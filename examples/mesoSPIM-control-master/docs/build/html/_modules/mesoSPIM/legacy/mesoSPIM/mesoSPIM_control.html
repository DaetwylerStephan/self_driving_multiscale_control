
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>mesoSPIM.legacy.mesoSPIM.mesoSPIM_control &#8212; mesoSPIM Control 0.0.1 documentation</title>
    <link rel="stylesheet" href="../../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for mesoSPIM.legacy.mesoSPIM.mesoSPIM_control</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">mesoSPIM Control software</span>

<span class="sd">Author: Fabian Voigt</span>

<span class="sd">Currently, everything is in one big file to avoid the messiness of relative imports</span>

<span class="sd">TODO: CHANGE</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="sd">&#39;&#39;&#39;Standard package imports&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="c1">#import matplotlib.pyplot as plt</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">signal</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">traceback</span>

<span class="sd">&#39;&#39;&#39; Support for importing modules from arbitrary paths &#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">importlib.util</span>

<span class="kn">import</span> <span class="nn">copy</span> <span class="c1"># TODO: Remove this thread-safety thing at some point</span>

<span class="sd">&#39;&#39;&#39;PyQt5 imports&#39;&#39;&#39;</span>
<span class="kn">from</span> <span class="nn">PyQt5.QtWidgets</span> <span class="k">import</span> <span class="n">QMainWindow</span><span class="p">,</span> <span class="n">QWidget</span><span class="p">,</span> <span class="n">QPushButton</span><span class="p">,</span> <span class="n">QApplication</span><span class="p">,</span> <span class="n">QFileDialog</span><span class="p">,</span> <span class="n">QMessageBox</span>
<span class="kn">from</span> <span class="nn">PyQt5.QtCore</span> <span class="k">import</span> <span class="n">pyqtSignal</span><span class="p">,</span> <span class="n">pyqtSlot</span><span class="p">,</span> <span class="n">QThread</span><span class="p">,</span> <span class="n">QObject</span><span class="p">,</span> <span class="n">QTimer</span><span class="p">,</span> <span class="n">QMutex</span><span class="p">,</span> <span class="n">QMutexLocker</span>
<span class="kn">from</span> <span class="nn">PyQt5.uic</span> <span class="k">import</span> <span class="n">loadUi</span>

<span class="sd">&#39;&#39;&#39;National Instruments Imports&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">nidaqmx</span>
<span class="kn">from</span> <span class="nn">nidaqmx.constants</span> <span class="k">import</span> <span class="n">AcquisitionType</span><span class="p">,</span> <span class="n">TaskMode</span>
<span class="kn">from</span> <span class="nn">nidaqmx.constants</span> <span class="k">import</span> <span class="n">LineGrouping</span><span class="p">,</span> <span class="n">DigitalWidthUnits</span>
<span class="kn">from</span> <span class="nn">nidaqmx.types</span> <span class="k">import</span> <span class="n">CtrTime</span>

<span class="sd">&#39;&#39;&#39; Import mesoSPIM modules &#39;&#39;&#39;</span>
<span class="kn">from</span> <span class="nn">.devices.waveform</span> <span class="k">import</span> <span class="n">waveforms</span> <span class="k">as</span> <span class="n">wf</span>
<span class="kn">from</span> <span class="nn">.devices</span> <span class="k">import</span> <span class="n">zoom</span> <span class="k">as</span> <span class="n">zoom</span>
<span class="kn">from</span> <span class="nn">.devices</span> <span class="k">import</span> <span class="n">shutter</span> <span class="k">as</span> <span class="n">shutter</span>
<span class="kn">from</span> <span class="nn">.devices</span> <span class="k">import</span> <span class="n">laserenable</span> <span class="k">as</span> <span class="n">laserenable</span>
<span class="c1"># from devices import joystick as joystick</span>
<span class="c1"># from devices.luigs_and_neumann import LNcontrol as ln</span>
<span class="c1"># from devices.galil import galilcontrol as gl</span>
<span class="kn">from</span> <span class="nn">.devices.ludl</span> <span class="k">import</span> <span class="n">ludlcontrol</span> <span class="k">as</span> <span class="n">ludl</span>

<span class="kn">from</span> <span class="nn">.devices.camera</span> <span class="k">import</span> <span class="n">hamamatsu_camera</span> <span class="k">as</span> <span class="n">cam</span>

<span class="kn">from</span> <span class="nn">pipython</span> <span class="k">import</span> <span class="n">GCSDevice</span><span class="p">,</span> <span class="n">pitools</span>

<span class="kn">import</span> <span class="nn">pywinusb.hid</span> <span class="k">as</span> <span class="nn">hid</span>

<span class="kn">import</span> <span class="nn">pyqtgraph</span> <span class="k">as</span> <span class="nn">pg</span>

<span class="n">pg</span><span class="o">.</span><span class="n">setConfigOptions</span><span class="p">(</span><span class="n">imageAxisOrder</span><span class="o">=</span><span class="s1">&#39;row-major&#39;</span><span class="p">)</span>
<span class="n">pg</span><span class="o">.</span><span class="n">setConfigOptions</span><span class="p">(</span><span class="n">foreground</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">pg</span><span class="o">.</span><span class="n">setConfigOptions</span><span class="p">(</span><span class="n">background</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">tifffile</span> <span class="k">as</span> <span class="nn">tf</span>

<span class="sd">&#39;&#39;&#39; Mutexes to regulate thread access to config parameters &#39;&#39;&#39;</span>
<span class="n">config_mutex</span> <span class="o">=</span> <span class="n">QMutex</span><span class="p">()</span>
<span class="n">state_mutex</span> <span class="o">=</span> <span class="n">QMutex</span><span class="p">()</span>
<span class="n">script_mutex</span> <span class="o">=</span> <span class="n">QMutex</span><span class="p">()</span>

<div class="viewcode-block" id="mesoSPIM_Global_Signals"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Global_Signals">[docs]</a><span class="k">class</span> <span class="nc">mesoSPIM_Global_Signals</span><span class="p">(</span><span class="n">QObject</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Contains general state and config of the microscope &#39;&#39;&#39;</span>

    <span class="sd">&#39;&#39;&#39; General stop signal: Every thread should be able to call this &#39;&#39;&#39;</span>
    <span class="n">stop</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>

    <span class="sd">&#39;&#39;&#39; Update Waveforms: e.g. when ETL parameters are changed via the GUI&#39;&#39;&#39;</span>
    <span class="n">update_waveforms</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">update_stack_parameters</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">update_etl_from_csv</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">save_etl_parameters_to_csv</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">update_sweeptime</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>

    <span class="sd">&#39;&#39;&#39; Update the GUI Signal &#39;&#39;&#39;</span>
    <span class="n">update_gui</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">update_etl_gui</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>

    <span class="sd">&#39;&#39;&#39; Other signals: &#39;&#39;&#39;</span>
    <span class="n">set_zoom</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">set_filter</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">set_intensity</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">set_laser_and_intensity</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>

    <span class="sd">&#39;&#39;&#39; Position &amp; movement-related signals &#39;&#39;&#39;</span>
    <span class="n">move_relative</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">move_relative_and_wait_until_done</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">move_absolute</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">move_absolute_and_wait_until_done</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>

    <span class="n">load_sample</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">unload_sample</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">stop_movement</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>

    <span class="n">update_position</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>

    <span class="n">zero_xyz</span> <span class="o">=</span>    <span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">zero_xy</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">zero_z</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">zero_focus</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">zero_rot</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>


    <span class="sd">&#39;&#39;&#39; State-changing signals &#39;&#39;&#39;</span>
    <span class="n">live</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">snap</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">stack</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">acquisition</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">visual_mode</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">lightsheet_alignment_mode</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>

    <span class="n">prepare_stack</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">add_images_to_stack</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">end_stack</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>

    <span class="n">finished</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">progress</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="sd">&#39;&#39;&#39; Status Messages &#39;&#39;&#39;</span>
    <span class="n">status_message</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>

    <span class="sd">&#39;&#39;&#39; Scripting Signals &#39;&#39;&#39;</span>
    <span class="n">execute_script</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>

    <span class="sd">&#39;&#39;&#39; Joystick timer Signals &#39;&#39;&#39;</span>
    <span class="n">joystick_timer_start</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">joystick_timer_stop</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>

    <span class="sd">&#39;&#39;&#39; Camera Signals &#39;&#39;&#39;</span>
    <span class="n">update_camera_exposure</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">update_camera_line_interval</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span></div>

<div class="viewcode-block" id="Script_Repository"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.Script_Repository">[docs]</a><span class="k">class</span> <span class="nc">Script_Repository</span><span class="p">(</span><span class="n">QObject</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Class that contains scripts.</span>

<span class="sd">    Things should be written in here using the mutex.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">script</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span></div>

<div class="viewcode-block" id="mesoSPIM_State"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_State">[docs]</a><span class="k">class</span> <span class="nc">mesoSPIM_State</span><span class="p">(</span><span class="n">QObject</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;This class contains the microscope state</span>

<span class="sd">    Here, we convert from a dictionary to a normal object</span>

<span class="sd">    Any access to this global state should be locked via mutexes</span>

<span class="sd">    TODO: Turn this into a singleton at some point, for now: Instantiate only once.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;init&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">cfg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">samplerate</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;samplerate&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sweeptime</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;sweeptime&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">samples</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">etl_cfg_file</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;ETL_cfg_file&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;filepath&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">folder</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;folder&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_prefix</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;file_prefix&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_number</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;start_number&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_suffix</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;file_suffix&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zoom</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;zoom&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pixelsize</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;pixelsize&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">laser</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;laser&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intensity</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intensities</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;intensities&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_laser_voltage</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;max_laser_voltage&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutterstate</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;shutterstate&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutterconfig</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;shutterconfig&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">laser_interleaving</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;laser_interleaving&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">etl_l_delay_percent</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;etl_l_delay_%&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">etl_l_ramp_rising_percent</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;etl_l_ramp_rising_%&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">etl_l_ramp_falling_percent</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;etl_l_ramp_falling_%&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">etl_l_amplitude</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;etl_l_amplitude&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">etl_l_offset</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;etl_l_offset&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">etl_r_delay_percent</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;etl_r_delay_%&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">etl_r_ramp_rising_percent</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;etl_r_ramp_rising_%&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">etl_r_ramp_falling_percent</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;etl_r_ramp_falling_%&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">etl_r_amplitude</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;etl_r_amplitude&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">etl_r_offset</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;etl_r_offset&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">galvo_l_frequency</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;galvo_l_frequency&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">galvo_l_amplitude</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;galvo_l_amplitude&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">galvo_l_offset</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;galvo_l_offset&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">galvo_l_duty_cycle</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;galvo_l_duty_cycle&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">galvo_l_phase</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;galvo_l_phase&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">galvo_r_frequency</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;galvo_r_frequency&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">galvo_r_amplitude</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;galvo_r_amplitude&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">galvo_r_offset</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;galvo_r_offset&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">galvo_r_duty_cycle</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;galvo_r_duty_cycle&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">galvo_r_phase</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;galvo_r_phase&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">laser_delay_percent</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;laser_delay_%&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">laser_pulse_percent</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;laser_pulse_%&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_delay_percent</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;camera_delay_%&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_pulse_percent</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;camera_pulse_%&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_exposure</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;camera_exposure&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_line_interval</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;camera_line_interval&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;stack&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tiling</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;tiling&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calculate_samples</span><span class="p">()</span>

<div class="viewcode-block" id="mesoSPIM_State.calculate_samples"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_State.calculate_samples">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">samplerate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sweeptime</span><span class="p">)))</span></div></div>

<div class="viewcode-block" id="mesoSPIM_GUI"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI">[docs]</a><span class="k">class</span> <span class="nc">mesoSPIM_GUI</span><span class="p">(</span><span class="n">QMainWindow</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Main application window which instantiates a worker object and moves it</span>
<span class="sd">    to a thread.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="sd">&#39;&#39;&#39; Button Overview</span>
<span class="sd">        SnapButton</span>
<span class="sd">        LiveButton</span>
<span class="sd">        StackButton</span>
<span class="sd">        ScriptButton</span>
<span class="sd">        StopButton</span>

<span class="sd">        ZoomComboBox</span>
<span class="sd">        LaserComboBox</span>
<span class="sd">        LaserSlider</span>

<span class="sd">        ProgressBar</span>

<span class="sd">        FilterComboBox</span>
<span class="sd">        ShutterComboBox</span>

<span class="sd">        X_Position_Indicator</span>
<span class="sd">        Y_Position_Indicator</span>
<span class="sd">        Z_Position_Indicator</span>
<span class="sd">        Rot_Position_Indicator</span>
<span class="sd">        Focus_Position_Indicator</span>

<span class="sd">        SaveParametersButton</span>
<span class="sd">        ETLconfigIndicator</span>
<span class="sd">        zeroLeftETLButton</span>
<span class="sd">        zeroRightETLButton</span>

<span class="sd">        VisualModeButton</span>
<span class="sd">        LightsheetSwitchingModeButton</span>

<span class="sd">        xMinusButton</span>
<span class="sd">        xPlusButton</span>
<span class="sd">        xyzIncrementSpinbox</span>
<span class="sd">        xyzZeroButton</span>

<span class="sd">        focusPlusButton</span>
<span class="sd">        focusMinusButton</span>
<span class="sd">        focusZeroButton</span>
<span class="sd">        focusIncrementSpinBox</span>

<span class="sd">        scriptEdit - QTextEdit for working on scripts</span>
<span class="sd">        loadScriptButton</span>
<span class="sd">        saveScriptButton</span>
<span class="sd">        executeScriptButton</span>

<span class="sd">        stackSetFolderButton</span>
<span class="sd">        stackFolderIndicator</span>
<span class="sd">        prefixLineEdit</span>
<span class="sd">        startNumberSpinBox</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">laserdict</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">laserdict</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filterdict</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">filterdict</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zoomdict</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">zoomdict</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutteroptions</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">shutteroptions</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">shutter_selection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutteroptions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="sd">&#39;&#39;&#39;Basic parameters to populate the GUI&#39;&#39;&#39;</span>

        <span class="c1"># self.startup = config.startup_parameters</span>

        <span class="sd">&#39;&#39;&#39;Set up the UI&#39;&#39;&#39;</span>
        <span class="n">loadUi</span><span class="p">(</span><span class="s1">&#39;gui/mesoSPIM-GUI.ui&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s1">&#39;mesoSPIM-Control&#39;</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39; Set up the basic slots &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SnapButton</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">snap</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LiveButton</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">live</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">StopButton</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">StackButton</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">StopButton</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39; Set the NI thread up &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">core_thread</span> <span class="o">=</span> <span class="n">QThread</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">core_worker</span> <span class="o">=</span>  <span class="n">mesoSPIM_Core</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">core_worker</span><span class="o">.</span><span class="n">moveToThread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">core_thread</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39; Set the Camera thread up &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_thread</span> <span class="o">=</span> <span class="n">QThread</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_worker</span> <span class="o">=</span> <span class="n">mesoSPIM_Camera</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_worker</span><span class="o">.</span><span class="n">moveToThread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camera_thread</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39; Set the serial thread up &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serial_thread</span> <span class="o">=</span> <span class="n">QThread</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serial_worker</span> <span class="o">=</span> <span class="n">mesoSPIM_Serial</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serial_worker</span><span class="o">.</span><span class="n">moveToThread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serial_thread</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39; Create the connections &#39;&#39;&#39;</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_progressbar</span><span class="p">)</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reset_GUI</span><span class="p">)</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">update_position</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_position_indicators</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39; Populate the Filter Combobox and connect signal &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FilterComboBox</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FilterComboBox</span><span class="o">.</span><span class="n">addItems</span><span class="p">([</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filterdict</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FilterComboBox</span><span class="o">.</span><span class="n">currentIndexChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_filter</span><span class="p">)</span>
        <span class="c1"># self.FilterComboBox.activated.connect(self.set_filter)</span>

        <span class="sd">&#39;&#39;&#39; Populate the Zoom Combobox and connect signal &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ZoomComboBox</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ZoomComboBox</span><span class="o">.</span><span class="n">addItems</span><span class="p">([</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">zoomdict</span><span class="p">])</span>
        <span class="c1"># self.ZoomComboBox.activated.connect(self.set_zoom)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ZoomComboBox</span><span class="o">.</span><span class="n">currentIndexChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_zoom</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39; Populate the Laser Combobox and connect signal &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LaserComboBox</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LaserComboBox</span><span class="o">.</span><span class="n">addItems</span><span class="p">([</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">laserdict</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">LaserComboBox</span><span class="o">.</span><span class="n">currentIndexChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_laser_and_intensity</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LaserSlider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_intensity</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39; Populate the Shutter Combobox and connect signal &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ShutterComboBox</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ShutterComboBox</span><span class="o">.</span><span class="n">addItems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shutteroptions</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ShutterComboBox</span><span class="o">.</span><span class="n">activated</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_shutter_selection</span><span class="p">)</span>
        <span class="c1"># currentIndexChanged.connect</span>

        <span class="sd">&#39;&#39;&#39; Set up the movement &amp; zero buttons &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xPlusButton</span><span class="o">.</span><span class="n">pressed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">relative_movement</span><span class="p">({</span><span class="s1">&#39;x_rel&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyzIncrementSpinbox</span><span class="o">.</span><span class="n">value</span><span class="p">()}))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xMinusButton</span><span class="o">.</span><span class="n">pressed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">relative_movement</span><span class="p">({</span><span class="s1">&#39;x_rel&#39;</span><span class="p">:</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">xyzIncrementSpinbox</span><span class="o">.</span><span class="n">value</span><span class="p">()}))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yPlusButton</span><span class="o">.</span><span class="n">pressed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">relative_movement</span><span class="p">({</span><span class="s1">&#39;y_rel&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyzIncrementSpinbox</span><span class="o">.</span><span class="n">value</span><span class="p">()}))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yMinusButton</span><span class="o">.</span><span class="n">pressed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">relative_movement</span><span class="p">({</span><span class="s1">&#39;y_rel&#39;</span><span class="p">:</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">xyzIncrementSpinbox</span><span class="o">.</span><span class="n">value</span><span class="p">()}))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zPlusButton</span><span class="o">.</span><span class="n">pressed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">relative_movement</span><span class="p">({</span><span class="s1">&#39;z_rel&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyzIncrementSpinbox</span><span class="o">.</span><span class="n">value</span><span class="p">()}))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zMinusButton</span><span class="o">.</span><span class="n">pressed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">relative_movement</span><span class="p">({</span><span class="s1">&#39;z_rel&#39;</span><span class="p">:</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">xyzIncrementSpinbox</span><span class="o">.</span><span class="n">value</span><span class="p">()}))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">focusPlusButton</span><span class="o">.</span><span class="n">pressed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">relative_movement</span><span class="p">({</span><span class="s1">&#39;f_rel&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">focusIncrementSpinbox</span><span class="o">.</span><span class="n">value</span><span class="p">()}))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">focusMinusButton</span><span class="o">.</span><span class="n">pressed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">relative_movement</span><span class="p">({</span><span class="s1">&#39;f_rel&#39;</span><span class="p">:</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">focusIncrementSpinbox</span><span class="o">.</span><span class="n">value</span><span class="p">()}))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotPlusButton</span><span class="o">.</span><span class="n">pressed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">relative_movement</span><span class="p">({</span><span class="s1">&#39;theta_rel&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotIncrementSpinbox</span><span class="o">.</span><span class="n">value</span><span class="p">()}))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotMinusButton</span><span class="o">.</span><span class="n">pressed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">relative_movement</span><span class="p">({</span><span class="s1">&#39;theta_rel&#39;</span><span class="p">:</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">rotIncrementSpinbox</span><span class="o">.</span><span class="n">value</span><span class="p">()}))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xyzrotStopButton</span><span class="o">.</span><span class="n">pressed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop_movement</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xyZeroButton</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zero_xy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zZeroButton</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zero_z</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xyzZeroButton</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zero_xyz</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">focusZeroButton</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zero_focus</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotZeroButton</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zero_rot</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xyzLoadButton</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_sample</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xyzUnloadButton</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unload_sample</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39; Stack buttons &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stackSetFolderButton</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_folder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefixLineEdit</span><span class="o">.</span><span class="n">editingFinished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_file_prefix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">startNumberSpinBox</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_start_number</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stackMarkStartButton</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mark_stack_start</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stackMarkEndButton</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mark_stack_end</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zStepSizeSpinbox</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_z_stepsize</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stackCalculatePlanesButton</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_z_planes</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39; Tilting buttons &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tilingSetStartPosition</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_tiling_start_position</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tilingSetEndPosition</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_tiling_z_end_position</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tilingCalculatePlanesButton</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_tiling_parameters</span><span class="p">)</span>


        <span class="sd">&#39;&#39;&#39; Set up the Buttons in the alignment tab and the connections of the</span>
<span class="sd">        related signals.</span>

<span class="sd">        VisualModeButton</span>
<span class="sd">        LightsheetSwitchingModeButton</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">VisualModeButton</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">visual_mode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LightsheetSwitchingModeButton</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lightsheet_alignment_mode</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39; Set up the connections of the ETL spinboxes in the ETL tab &#39;&#39;&#39;</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">etl_l_offset_Spinbox</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">etl_l_offset</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">etl_r_offset_Spinbox</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">etl_r_offset</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">etl_l_amp_Spinbox</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">etl_l_amplitude</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">etl_r_amp_Spinbox</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">etl_r_amplitude</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">etl_l_offset_Spinbox</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_etl_parameters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">etl_r_offset_Spinbox</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_etl_parameters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">etl_l_amp_Spinbox</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_etl_parameters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">etl_r_amp_Spinbox</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_etl_parameters</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">etl_increment_Spinbox</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_etl_increments</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39; Set up ETL cfg &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zeroLeftETLButton</span><span class="o">.</span><span class="n">toggled</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zeroLeftETL</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zeroRightETLButton</span><span class="o">.</span><span class="n">toggled</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zeroRightETL</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39; Set up ETL cfg &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chooseETLcfgButton</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">choose_etl_config</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">SaveParametersButton</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_etl_config</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39; Set up scripting buttons &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadScriptButton</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_script</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saveScriptButton</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_script</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executeScriptButton</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">execute_script</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Populate GUI with the initial values</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="sd">&#39;&#39;&#39; Display ETL config from the initial file &#39;&#39;&#39;</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ETLconfigIndicator</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">etl_cfg_file</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39; Populate the controls with the correct startup values</span>
<span class="sd">        TODO: This is hardcoded</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FilterComboBox</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ZoomComboBox</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LaserComboBox</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ShutterComboBox</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LaserSlider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">LaserSliderChangeCount</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="sd">&#39;&#39;&#39; Display initial values for exposure time and sweeptime &#39;&#39;&#39;</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exposure_Spinbox</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">camera_exposure</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sweeptime_Spinbox</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">sweeptime</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">line_interval_Spinbox</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">camera_line_interval</span><span class="o">*</span><span class="mi">1000000</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">stackFolderIndicator</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">folder</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39; Set up connections for the camera / sweeptime parameters &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exposure_Spinbox</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_exposure_time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sweeptime_Spinbox</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_sweeptime</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line_interval_Spinbox</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_line_interval</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39; Populate the Galvo Parameters from the startup values &#39;&#39;&#39;</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">freq</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">galvo_l_frequency</span>
            <span class="n">galvo_l_offset</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">galvo_l_offset</span>
            <span class="n">galvo_r_offset</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">galvo_r_offset</span>
            <span class="n">galvo_l_amplitude</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">galvo_l_amplitude</span>
            <span class="n">galvo_r_amplitude</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">galvo_r_amplitude</span>
            <span class="n">galvo_l_phase</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">galvo_l_phase</span>
            <span class="n">galvo_r_phase</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">galvo_r_phase</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">galvoFrequencySpinbox</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">galvo_left_offset_Spinbox</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">galvo_l_offset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">galvo_right_offset_Spinbox</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">galvo_r_offset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">galvo_left_amplitude_Spinbox</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">galvo_l_amplitude</span><span class="p">)</span>
        <span class="c1"># self.galvo_right_amplitude_Spinbox.setValue(galvo_r_amplitude)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">galvo_left_phase_Spinbox</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">galvo_l_phase</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">180</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">galvo_right_phase_Spinbox</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">galvo_r_phase</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">180</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39; Set up the connections of the Galvo Spinboxes in the Parameter Tab&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">galvoFrequencySpinbox</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_galvo_parameters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">galvo_left_offset_Spinbox</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_galvo_parameters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">galvo_right_offset_Spinbox</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_galvo_parameters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">galvo_left_amplitude_Spinbox</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_galvo_parameters</span><span class="p">)</span>
        <span class="c1"># self.galvo_right_amplitude_Spinbox.valueChanged.connect(self.set_galvo_parameters)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">galvo_left_phase_Spinbox</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_galvo_parameters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">galvo_right_phase_Spinbox</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_galvo_parameters</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39; Wire up speciality signals &#39;&#39;&#39;</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">update_etl_gui</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_etl_parameters</span><span class="p">)</span>

        <span class="n">gsig</span><span class="o">.</span><span class="n">status_message</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">display_status_message</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39; Start the threads &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">core_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serial_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Setting up the joystick</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hid_filter</span> <span class="o">=</span> <span class="n">hid</span><span class="o">.</span><span class="n">HidDeviceFilter</span><span class="p">(</span><span class="n">vendor_id</span> <span class="o">=</span> <span class="mh">0x0738</span><span class="p">,</span> <span class="n">product_id</span> <span class="o">=</span> <span class="mh">0x2218</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hid_device</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hid_filter</span><span class="o">.</span><span class="n">get_devices</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">joystick</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hid_device</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">joystick</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">joystick</span><span class="o">.</span><span class="n">set_raw_data_handler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">farm_panel_handler</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">joystick_mode</span> <span class="o">=</span> <span class="s1">&#39;undefined&#39;</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Joystick Mode: Undefined&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        One problem with the joystick is that it stops sending packages when the</span>
<span class="sd">        maximum tip/tilt is reached. To circumvent the motion to be stopped,</span>
<span class="sd">        a QTimer is used to periodically trigger movement in the same direction.</span>

<span class="sd">        joystick_timer_start/stop are helper methods.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">joystick_timer</span> <span class="o">=</span> <span class="n">QTimer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">joystick_timer</span><span class="o">.</span><span class="n">timeout</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joystick_persistent_update</span><span class="p">)</span>

        <span class="n">gsig</span><span class="o">.</span><span class="n">joystick_timer_start</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joystick_timer_start</span><span class="p">)</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">joystick_timer_stop</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joystick_timer_stop</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Setting up the camera window</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_window</span> <span class="o">=</span> <span class="n">mesoSPIM_CameraGUI</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_window</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Wire emitted images to camera window</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_worker</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camera_window</span><span class="o">.</span><span class="n">set_image</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Cleans the threads up after deletion, waits until the threads</span>
<span class="sd">        have truly finished their life.</span>

<span class="sd">        Make sure to keep this up to date with the number of threads</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">joystick</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">core_thread</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">camera_thread</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">serial_thread</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">core_thread</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">camera_thread</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">serial_thread</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

<div class="viewcode-block" id="mesoSPIM_GUI.update_progressbar"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.update_progressbar">[docs]</a>    <span class="nd">@pyqtSlot</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">update_progressbar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ProgressBar</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.pos2str"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.pos2str">[docs]</a>    <span class="k">def</span> <span class="nf">pos2str</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Little helper method for converting positions to strings &#39;&#39;&#39;</span>

        <span class="sd">&#39;&#39;&#39; Show 2 decimal places &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">position</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.update_position_indicators"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.update_position_indicators">[docs]</a>    <span class="nd">@pyqtSlot</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">update_position_indicators</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_Position_Indicator</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos2str</span><span class="p">(</span><span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;x_pos&#39;</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; µm&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Y_Position_Indicator</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos2str</span><span class="p">(</span><span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;y_pos&#39;</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; µm&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Z_Position_Indicator</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos2str</span><span class="p">(</span><span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;z_pos&#39;</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; µm&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Focus_Position_Indicator</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos2str</span><span class="p">(</span><span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;f_pos&#39;</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; µm&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Rotation_Position_Indicator</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos2str</span><span class="p">(</span><span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;theta_pos&#39;</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;°&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.display_status_message"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.display_status_message">[docs]</a>    <span class="k">def</span> <span class="nf">display_status_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Displays a message in the status bar for a time in ms</span>

<span class="sd">        If time=0, the message will stay.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">time</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span></div>


<div class="viewcode-block" id="mesoSPIM_GUI.set_etl_parameters"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.set_etl_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">set_etl_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">etl_l_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">etl_l_offset_Spinbox</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
            <span class="n">s</span><span class="o">.</span><span class="n">etl_r_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">etl_r_offset_Spinbox</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
            <span class="n">s</span><span class="o">.</span><span class="n">etl_l_amplitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">etl_l_amp_Spinbox</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
            <span class="n">s</span><span class="o">.</span><span class="n">etl_r_amplitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">etl_r_amp_Spinbox</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>

        <span class="n">gsig</span><span class="o">.</span><span class="n">update_waveforms</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.update_etl_parameters"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.update_etl_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">update_etl_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">etl_l_offset</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">etl_l_offset</span>
            <span class="n">etl_r_offset</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">etl_r_offset</span>
            <span class="n">etl_l_amp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">etl_l_amplitude</span>
            <span class="n">etl_r_amp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">etl_r_amplitude</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">etl_l_offset_Spinbox</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">etl_l_offset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">etl_r_offset_Spinbox</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">etl_r_offset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">etl_l_amp_Spinbox</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">etl_l_amp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">etl_r_amp_Spinbox</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">etl_r_amp</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.choose_etl_config"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.choose_etl_config">[docs]</a>    <span class="k">def</span> <span class="nf">choose_etl_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; File dialog for choosing the config file</span>

<span class="sd">        TODO: Check that this is really a .csv-File</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">old_path</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">etl_cfg_file</span>

        <span class="n">path</span> <span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="o">.</span><span class="n">getOpenFileName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;Open csv File&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">etl_cfg_file</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39; To avoid crashes, only set the cfg file when a file has been selected:&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
                <span class="n">s</span><span class="o">.</span><span class="n">etl_cfg_file</span> <span class="o">=</span> <span class="n">path</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ETLconfigIndicator</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">etl_cfg_file</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Chosen ETL CFG file:&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">etl_cfg_file</span><span class="p">)</span>

            <span class="n">gsig</span><span class="o">.</span><span class="n">update_etl_from_csv</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.save_etl_config"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.save_etl_config">[docs]</a>    <span class="k">def</span> <span class="nf">save_etl_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Save current ETL parameters into config</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">save_etl_parameters_to_csv</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.zeroLeftETL"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.zeroLeftETL">[docs]</a>    <span class="k">def</span> <span class="nf">zeroLeftETL</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Zeros the amplitude of the left ETL for faster alignment &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zeroLeftETLButton</span><span class="o">.</span><span class="n">isChecked</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ETL_L_amp_backup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">etl_l_amp_Spinbox</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">etl_l_amp_Spinbox</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># print(&#39;Left ETL toggled, Button checked&#39;)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">etl_l_amp_Spinbox</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ETL_L_amp_backup</span><span class="p">)</span></div>
            <span class="c1"># print(&#39;Left ETL toggled, Button NOT checked&#39;)</span>

<div class="viewcode-block" id="mesoSPIM_GUI.zeroRightETL"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.zeroRightETL">[docs]</a>    <span class="k">def</span> <span class="nf">zeroRightETL</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Zeros the amplitude of the right ETL for faster alignment &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zeroRightETLButton</span><span class="o">.</span><span class="n">isChecked</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ETL_R_amp_backup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">etl_r_amp_Spinbox</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">etl_r_amp_Spinbox</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># print(&#39;Right ETL toggled, Button checked&#39;)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">etl_r_amp_Spinbox</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ETL_R_amp_backup</span><span class="p">)</span></div>
            <span class="c1"># print(&#39;Right ETL toggled, Button NOT checked&#39;)</span>

<div class="viewcode-block" id="mesoSPIM_GUI.relative_movement"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.relative_movement">[docs]</a>    <span class="k">def</span> <span class="nf">relative_movement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Takes a single-axis movement dict in the form</span>

<span class="sd">        {&#39;z_rel&#39;: 100}</span>
<span class="sd">        and sends it out as</span>
<span class="sd">        {&#39;x_rel&#39;: 0,&#39;y_rel&#39;: 0, &#39;z_rel&#39;: 100, &#39;f_rel&#39;: 0, &#39;theta_rel&#39;: 0}</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;y_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;z_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;f_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;theta_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">popitem</span><span class="p">()</span>
        <span class="n">message</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="n">value</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">move_relative</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.zero_xyz"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.zero_xyz">[docs]</a>    <span class="k">def</span> <span class="nf">zero_xyz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">zero_xyz</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.zero_xy"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.zero_xy">[docs]</a>    <span class="k">def</span> <span class="nf">zero_xy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">zero_xy</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.zero_z"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.zero_z">[docs]</a>    <span class="k">def</span> <span class="nf">zero_z</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">zero_z</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.zero_focus"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.zero_focus">[docs]</a>    <span class="k">def</span> <span class="nf">zero_focus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">zero_focus</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.zero_rot"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.zero_rot">[docs]</a>    <span class="k">def</span> <span class="nf">zero_rot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">zero_rot</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.reset_GUI"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.reset_GUI">[docs]</a>    <span class="k">def</span> <span class="nf">reset_GUI</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Resets the GUI after any acquisition (live, stack, alignment etc ran)</span>

<span class="sd">        TODO: When Stack / Script buttons become available, reset them as well</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SnapButton</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LiveButton</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">StackButton</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">StopButton</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable_alignment_mode_buttons</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable_controls</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_progressbar_to_standard</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.enable_stop_button"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.enable_stop_button">[docs]</a>    <span class="k">def</span> <span class="nf">enable_stop_button</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">StopButton</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.enable_alignment_mode_buttons"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.enable_alignment_mode_buttons">[docs]</a>    <span class="k">def</span> <span class="nf">enable_alignment_mode_buttons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">VisualModeButton</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LightsheetSwitchingModeButton</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.disable_alignment_mode_buttons"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.disable_alignment_mode_buttons">[docs]</a>    <span class="k">def</span> <span class="nf">disable_alignment_mode_buttons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">VisualModeButton</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LightsheetSwitchingModeButton</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.disable_mode_control_buttons"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.disable_mode_control_buttons">[docs]</a>    <span class="k">def</span> <span class="nf">disable_mode_control_buttons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;If the microscope is in any acquisition state,</span>
<span class="sd">        it should disable ALL the buttons that can cause it to go into another</span>
<span class="sd">        mode and enable the stop button.</span>

<span class="sd">        ONLY the stop button or proper finishing of the acquisition allow</span>
<span class="sd">        the GUI to return to the original state.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable_stop_button</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SnapButton</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LiveButton</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">StackButton</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disable_alignment_mode_buttons</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.disable_controls"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.disable_controls">[docs]</a>    <span class="k">def</span> <span class="nf">disable_controls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tabWidget</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FilterComboBox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ZoomComboBox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ShutterComboBox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LaserComboBox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LaserSlider</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.enable_controls"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.enable_controls">[docs]</a>    <span class="k">def</span> <span class="nf">enable_controls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tabWidget</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FilterComboBox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ZoomComboBox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ShutterComboBox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LaserComboBox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LaserSlider</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.update_folder"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.update_folder">[docs]</a>    <span class="k">def</span> <span class="nf">update_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Get a new folder name for saving the acquisition &#39;&#39;&#39;</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">old_folder</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">folder</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="o">.</span><span class="n">getExistingDirectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;Select directory&#39;</span><span class="p">,</span> <span class="n">old_folder</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
                <span class="n">s</span><span class="o">.</span><span class="n">folder</span> <span class="o">=</span> <span class="n">path</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stackFolderIndicator</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.update_file_prefix"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.update_file_prefix">[docs]</a>    <span class="k">def</span> <span class="nf">update_file_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">file_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefixLineEdit</span><span class="o">.</span><span class="n">text</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.update_start_number"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.update_start_number">[docs]</a>    <span class="k">def</span> <span class="nf">update_start_number</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">start_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startNumberSpinBox</span><span class="o">.</span><span class="n">value</span><span class="p">()</span></div>

    <span class="c1"># def update_stack_filename(self):</span>
    <span class="c1">#     &#39;&#39;&#39; File dialog for choosing the file to store from a stack</span>
    <span class="c1">#</span>
    <span class="c1">#     &#39;&#39;&#39;</span>
    <span class="c1">#     path , _ = QFileDialog.getSaveFileName(self, &#39;File to save&#39;)</span>
    <span class="c1">#</span>
    <span class="c1">#     &#39;&#39;&#39; To avoid crashes, only set the filename when a file has been selected:&#39;&#39;&#39;</span>
    <span class="c1">#     if path:</span>
    <span class="c1">#         with QMutexLocker(state_mutex):</span>
    <span class="c1">#             s.filepath = path</span>
    <span class="c1">#             self.stackFilenameIndicator.setText(path)</span>
    <span class="c1">#</span>
    <span class="c1">#         print(&#39;Chosen Filename:&#39;, path)</span>

<div class="viewcode-block" id="mesoSPIM_GUI.mark_stack_start"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.mark_stack_start">[docs]</a>    <span class="k">def</span> <span class="nf">mark_stack_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">start_pos</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="s1">&#39;z_pos&#39;</span><span class="p">]</span>
            <span class="n">s</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="s1">&#39;z_start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_pos</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stackStartIndicator</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos2str</span><span class="p">(</span><span class="n">start_pos</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; µm&#39;</span><span class="p">)</span></div>
        <span class="c1">#gsig.update_stack_parameters.emit()</span>
        <span class="c1">#self.update_z_planes()</span>

<div class="viewcode-block" id="mesoSPIM_GUI.mark_stack_end"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.mark_stack_end">[docs]</a>    <span class="k">def</span> <span class="nf">mark_stack_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">end_pos</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="s1">&#39;z_pos&#39;</span><span class="p">]</span>
            <span class="n">s</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="s1">&#39;z_end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">end_pos</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stackEndIndicator</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos2str</span><span class="p">(</span><span class="n">end_pos</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; µm&#39;</span><span class="p">)</span>
        <span class="sd">&#39;&#39;&#39;Could it be that the missing gsig in the following line was causing the calculation problem?&#39;&#39;&#39;</span></div>
        <span class="c1">#gsig.update_stack_parameters.emit()</span>
        <span class="c1">#self.update_z_planes()</span>

<div class="viewcode-block" id="mesoSPIM_GUI.set_z_stepsize"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.set_z_stepsize">[docs]</a>    <span class="k">def</span> <span class="nf">set_z_stepsize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">z_stepsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zStepSizeSpinbox</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="s1">&#39;z_stepsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_stepsize</span></div>

        <span class="c1">#self.update_z_planes()</span>

<div class="viewcode-block" id="mesoSPIM_GUI.update_z_planes"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.update_z_planes">[docs]</a>    <span class="k">def</span> <span class="nf">update_z_planes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">update_stack_parameters</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

        <span class="sd">&#39;&#39;&#39;This is a hack (using time.sleep) to ensure that the state has been updated</span>
<span class="sd">        before I&#39;m trying to write into the indicator. Proper finished signal</span>
<span class="sd">        would be better here&#39;&#39;&#39;</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">z_planes</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="s1">&#39;z_planes&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">zPlanesIndicator</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">z_planes</span><span class="p">))</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.snap"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.snap">[docs]</a>    <span class="k">def</span> <span class="nf">snap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Snap a single image&#39;&#39;&#39;</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">snap</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_progressbar_to_busy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disable_mode_control_buttons</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.live"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.live">[docs]</a>    <span class="k">def</span> <span class="nf">live</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Enter live mode&#39;&#39;&#39;</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">live</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_progressbar_to_busy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disable_mode_control_buttons</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.stack"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.stack">[docs]</a>    <span class="k">def</span> <span class="nf">stack</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disable_mode_control_buttons</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disable_controls</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.stop"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Should stop everything&#39;&#39;&#39;</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">stop</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_GUI</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_progressbar_to_standard</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.visual_mode"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.visual_mode">[docs]</a>    <span class="k">def</span> <span class="nf">visual_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Run in visual mode without ETL parameters</span>

<span class="sd">        TODO: Disable ETL controls and reenable them later as part of the stop method ?</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">visual_mode</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable_stop_button</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_progressbar_to_busy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disable_mode_control_buttons</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.lightsheet_alignment_mode"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.lightsheet_alignment_mode">[docs]</a>    <span class="k">def</span> <span class="nf">lightsheet_alignment_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Run in light-sheet switching mode: interleaved left/right shuttering for</span>
<span class="sd">        coalignment of the light-sheets</span>

<span class="sd">        TODO: When Stack / Script buttons become available, disable them as well</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">lightsheet_alignment_mode</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable_stop_button</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_progressbar_to_busy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disable_mode_control_buttons</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.set_progressbar_to_busy"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.set_progressbar_to_busy">[docs]</a>    <span class="k">def</span> <span class="nf">set_progressbar_to_busy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;If min and max of a progress bar are 0, it shows a &quot;busy&quot; indicator&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ProgressBar</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ProgressBar</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.set_progressbar_to_standard"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.set_progressbar_to_standard">[docs]</a>    <span class="k">def</span> <span class="nf">set_progressbar_to_standard</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ProgressBar</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ProgressBar</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.set_shutter_selection"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.set_shutter_selection">[docs]</a>    <span class="k">def</span> <span class="nf">set_shutter_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">shutter_selection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ShutterComboBox</span><span class="o">.</span><span class="n">currentText</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">shutterconfig</span> <span class="o">=</span>  <span class="n">shutter_selection</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.set_filter"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.set_filter">[docs]</a>    <span class="k">def</span> <span class="nf">set_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">set_filter</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FilterComboBox</span><span class="o">.</span><span class="n">currentText</span><span class="p">())</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.set_zoom"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.set_zoom">[docs]</a>    <span class="k">def</span> <span class="nf">set_zoom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">zoom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ZoomComboBox</span><span class="o">.</span><span class="n">currentText</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">laser</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">laser</span>
            <span class="n">intensity</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">intensity</span>
            <span class="n">s</span><span class="o">.</span><span class="n">zoom</span> <span class="o">=</span> <span class="n">zoom</span>

        <span class="n">gsig</span><span class="o">.</span><span class="n">set_zoom</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">zoom</span><span class="p">)</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">set_laser_and_intensity</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">laser</span><span class="p">,</span> <span class="n">intensity</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.set_intensity"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.set_intensity">[docs]</a>    <span class="k">def</span> <span class="nf">set_intensity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Updates laser intensity of the running laser &#39;&#39;&#39;</span>
        <span class="n">intensity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LaserSlider</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">intensity</span> <span class="o">=</span> <span class="n">intensity</span>

        <span class="n">gsig</span><span class="o">.</span><span class="n">set_intensity</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">intensity</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.set_laser_and_intensity"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.set_laser_and_intensity">[docs]</a>    <span class="k">def</span> <span class="nf">set_laser_and_intensity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Sends laser and laser intensity in %&#39;&#39;&#39;</span>
        <span class="n">laser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LaserComboBox</span><span class="o">.</span><span class="n">currentText</span><span class="p">()</span>
        <span class="n">intensity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LaserSlider</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">laser</span> <span class="o">=</span>  <span class="n">laser</span>
            <span class="n">s</span><span class="o">.</span><span class="n">intensity</span> <span class="o">=</span> <span class="n">intensity</span>

        <span class="n">gsig</span><span class="o">.</span><span class="n">set_laser_and_intensity</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">laser</span><span class="p">,</span> <span class="n">intensity</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.set_etl_increments"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.set_etl_increments">[docs]</a>    <span class="k">def</span> <span class="nf">set_etl_increments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">increment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">etl_increment_Spinbox</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">etl_l_offset_Spinbox</span><span class="o">.</span><span class="n">setSingleStep</span><span class="p">(</span><span class="n">increment</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">etl_r_offset_Spinbox</span><span class="o">.</span><span class="n">setSingleStep</span><span class="p">(</span><span class="n">increment</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">etl_l_amp_Spinbox</span><span class="o">.</span><span class="n">setSingleStep</span><span class="p">(</span><span class="n">increment</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">etl_r_amp_Spinbox</span><span class="o">.</span><span class="n">setSingleStep</span><span class="p">(</span><span class="n">increment</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.set_exposure_time"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.set_exposure_time">[docs]</a>    <span class="k">def</span> <span class="nf">set_exposure_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Display is in ms, value needed is in seconds &#39;&#39;&#39;</span>

        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">camera_exposure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exposure_Spinbox</span><span class="o">.</span><span class="n">value</span><span class="p">()</span><span class="o">/</span><span class="mi">1000</span>

        <span class="n">gsig</span><span class="o">.</span><span class="n">update_camera_exposure</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.set_sweeptime"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.set_sweeptime">[docs]</a>    <span class="k">def</span> <span class="nf">set_sweeptime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Display is in ms, value needed is in seconds</span>

<span class="sd">        TODO: Functionality needs to be added</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">sweeptime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sweeptime_Spinbox</span><span class="o">.</span><span class="n">value</span><span class="p">()</span><span class="o">/</span><span class="mi">1000</span>

        <span class="n">gsig</span><span class="o">.</span><span class="n">update_sweeptime</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sweeptime in s: &#39;</span><span class="p">,</span> <span class="n">sweeptime</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.set_line_interval"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.set_line_interval">[docs]</a>    <span class="k">def</span> <span class="nf">set_line_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Change line interval &#39;&#39;&#39;</span>

        <span class="sd">&#39;&#39;&#39; Display is in microseconds, value needed is in seconds &#39;&#39;&#39;</span>

        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">camera_line_interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_interval_Spinbox</span><span class="o">.</span><span class="n">value</span><span class="p">()</span><span class="o">/</span><span class="mi">1000000</span>

        <span class="n">gsig</span><span class="o">.</span><span class="n">update_camera_line_interval</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.set_galvo_parameters"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.set_galvo_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">set_galvo_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Update Galvo Parameters from the values in the parameter tab &#39;&#39;&#39;</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">galvoFrequencySpinbox</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="n">galvo_l_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">galvo_left_offset_Spinbox</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="n">galvo_r_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">galvo_right_offset_Spinbox</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="n">galvo_l_amplitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">galvo_left_amplitude_Spinbox</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="c1"># galvo_r_amplitude = self.galvo_right_amplitude_Spinbox.value()</span>
        <span class="n">galvo_l_phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">galvo_left_phase_Spinbox</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="n">galvo_r_phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">galvo_right_phase_Spinbox</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>

        <span class="sd">&#39;&#39;&#39; convert phase from deg to rad &#39;&#39;&#39;</span>
        <span class="n">galvo_l_phase</span> <span class="o">=</span> <span class="p">(</span><span class="n">galvo_l_phase</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">galvo_l_phase</span> <span class="o">=</span> <span class="p">(</span><span class="n">galvo_r_phase</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>

        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">galvo_l_frequency</span> <span class="o">=</span> <span class="n">freq</span>
            <span class="n">s</span><span class="o">.</span><span class="n">galvo_r_frequency</span> <span class="o">=</span> <span class="n">freq</span>
            <span class="n">s</span><span class="o">.</span><span class="n">galvo_l_offset</span> <span class="o">=</span> <span class="n">galvo_l_offset</span>
            <span class="n">s</span><span class="o">.</span><span class="n">galvo_r_offset</span> <span class="o">=</span> <span class="n">galvo_r_offset</span>
            <span class="n">s</span><span class="o">.</span><span class="n">galvo_l_amplitude</span> <span class="o">=</span> <span class="n">galvo_l_amplitude</span>
            <span class="c1"># s.galvo_r_amplitude = galvo_r_amplitude</span>
            <span class="n">s</span><span class="o">.</span><span class="n">galvo_l_phase</span> <span class="o">=</span> <span class="n">galvo_l_phase</span>
            <span class="n">s</span><span class="o">.</span><span class="n">galvo_r_phase</span> <span class="o">=</span> <span class="n">galvo_r_phase</span>

        <span class="sd">&#39;&#39;&#39; Hack to ensure sequential execution&#39;&#39;&#39;</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">update_waveforms</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.load_sample"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.load_sample">[docs]</a>    <span class="k">def</span> <span class="nf">load_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">load_sample</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.unload_sample"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.unload_sample">[docs]</a>    <span class="k">def</span> <span class="nf">unload_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">unload_sample</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.stop_movement"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.stop_movement">[docs]</a>    <span class="k">def</span> <span class="nf">stop_movement</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">stop_movement</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;All movements stopped&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.tiling"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.tiling">[docs]</a>    <span class="k">def</span> <span class="nf">tiling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.update_tiling_parameters"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.update_tiling_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">update_tiling_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Here, the tiling parameters are calculated and set by the GUI</span>

<span class="sd">        These are:</span>
<span class="sd">        - number of z_planes per substack</span>
<span class="sd">        - total number of planes</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">z_start</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">tiling</span><span class="p">[</span><span class="s1">&#39;z_start&#39;</span><span class="p">]</span>
            <span class="n">z_end</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">tiling</span><span class="p">[</span><span class="s1">&#39;z_end&#39;</span><span class="p">]</span>

            <span class="n">z_stepsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilingZStepSizeSpinbox</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
            <span class="n">s</span><span class="o">.</span><span class="n">tiling</span><span class="p">[</span><span class="s1">&#39;z_stepsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_stepsize</span>

            <span class="n">x_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilingXStepsSpinBox</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
            <span class="n">s</span><span class="o">.</span><span class="n">tiling</span><span class="p">[</span><span class="s1">&#39;x_steps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_steps</span>

            <span class="n">y_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilingYStepsSpinBox</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
            <span class="n">s</span><span class="o">.</span><span class="n">tiling</span><span class="p">[</span><span class="s1">&#39;y_steps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_steps</span>

            <span class="n">x_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilingOffsetSpinbox</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            There are two offset values for rectangular FOVs, but for now, the</span>
<span class="sd">            FOV is square...</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">s</span><span class="o">.</span><span class="n">tiling</span><span class="p">[</span><span class="s1">&#39;x_offset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_offset</span>
            <span class="n">s</span><span class="o">.</span><span class="n">tiling</span><span class="p">[</span><span class="s1">&#39;y_offset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_offset</span>

        <span class="n">z_planes</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="n">z_end</span> <span class="o">-</span> <span class="n">z_start</span><span class="p">)</span><span class="o">/</span><span class="n">z_stepsize</span><span class="p">))</span>
        <span class="n">total_planes</span> <span class="o">=</span> <span class="n">z_planes</span><span class="o">*</span><span class="n">x_steps</span><span class="o">*</span><span class="n">y_steps</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tilingZPlanesIndicator</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">z_planes</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tilingTotalPlanesIndicator</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">total_planes</span><span class="p">))</span>

        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">tiling</span><span class="p">[</span><span class="s1">&#39;z_planes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_planes</span>
            <span class="n">s</span><span class="o">.</span><span class="n">tiling</span><span class="p">[</span><span class="s1">&#39;total_planes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_planes</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.set_tiling_start_position"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.set_tiling_start_position">[docs]</a>    <span class="k">def</span> <span class="nf">set_tiling_start_position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">tiling</span><span class="p">[</span><span class="s1">&#39;x_start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="s1">&#39;x_pos&#39;</span><span class="p">]</span>
            <span class="n">s</span><span class="o">.</span><span class="n">tiling</span><span class="p">[</span><span class="s1">&#39;y_start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="s1">&#39;y_pos&#39;</span><span class="p">]</span>
            <span class="n">z_start</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="s1">&#39;z_pos&#39;</span><span class="p">]</span>
            <span class="n">s</span><span class="o">.</span><span class="n">tiling</span><span class="p">[</span><span class="s1">&#39;z_start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_start</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tilingZStartIndicator</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos2str</span><span class="p">(</span><span class="n">z_start</span><span class="p">))</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.set_tiling_z_end_position"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.set_tiling_z_end_position">[docs]</a>    <span class="k">def</span> <span class="nf">set_tiling_z_end_position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">z_end</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="s1">&#39;z_pos&#39;</span><span class="p">]</span>
            <span class="n">s</span><span class="o">.</span><span class="n">tiling</span><span class="p">[</span><span class="s1">&#39;z_end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_end</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tilingZEndIndicator</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos2str</span><span class="p">(</span><span class="n">z_end</span><span class="p">))</span></div>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Joystick-related stuff starts here</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">sample_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Raw data: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<div class="viewcode-block" id="mesoSPIM_GUI.get_bin"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.get_bin">[docs]</a>    <span class="k">def</span> <span class="nf">get_bin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the binary representation of x.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : int</span>
<span class="sd">        n : int</span>
<span class="sd">            Minimum number of digits. If x needs less digits in binary, the rest</span>
<span class="sd">            is filled with zeros.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">n</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.sample_handler"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.sample_handler">[docs]</a>    <span class="k">def</span> <span class="nf">sample_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Raw data: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.set_laser_via_button"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.set_laser_via_button">[docs]</a>    <span class="k">def</span> <span class="nf">set_laser_via_button</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">laser</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LaserComboBox</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="n">intensity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LaserSlider</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>

        <span class="n">gsig</span><span class="o">.</span><span class="n">set_laser_and_intensity</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">laser</span><span class="p">,</span> <span class="n">intensity</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">laser</span> <span class="o">=</span>  <span class="n">laser</span>
            <span class="n">s</span><span class="o">.</span><span class="n">intensity</span> <span class="o">=</span> <span class="n">intensity</span></div>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    The first six buttons should be lasers, but what if there are less lasers in the system?</span>
<span class="sd">    &#39;&#39;&#39;</span>

<div class="viewcode-block" id="mesoSPIM_GUI.button1"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.button1">[docs]</a>    <span class="k">def</span> <span class="nf">button1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;select the first laser&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">laser</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">laserdict</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_laser_via_button</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">laser</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span></div>

        <span class="c1"># print(&#39;Button 1 pressed, really&#39;)</span>

<div class="viewcode-block" id="mesoSPIM_GUI.button2"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.button2">[docs]</a>    <span class="k">def</span> <span class="nf">button2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">laser</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">laserdict</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_laser_via_button</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">laser</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span></div>

        <span class="c1"># print(&#39;Button 2 pressed&#39;)</span>

<div class="viewcode-block" id="mesoSPIM_GUI.button3"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.button3">[docs]</a>    <span class="k">def</span> <span class="nf">button3</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">laser</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">laserdict</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_laser_via_button</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">laser</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span></div>

        <span class="c1"># print(&#39;Button 3 pressed&#39;)</span>

<div class="viewcode-block" id="mesoSPIM_GUI.button4"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.button4">[docs]</a>    <span class="k">def</span> <span class="nf">button4</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>
        <span class="c1"># print(&#39;Button 4 pressed&#39;)</span>

<div class="viewcode-block" id="mesoSPIM_GUI.button5"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.button5">[docs]</a>    <span class="k">def</span> <span class="nf">button5</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">unload_sample</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>
        <span class="c1"># print(&#39;Button 5 pressed&#39;)</span>

<div class="viewcode-block" id="mesoSPIM_GUI.button6"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.button6">[docs]</a>    <span class="k">def</span> <span class="nf">button6</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">laser</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">laserdict</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_laser_via_button</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">laser</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span></div>

        <span class="c1"># print(&#39;Button 6 pressed&#39;)</span>

<div class="viewcode-block" id="mesoSPIM_GUI.button7"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.button7">[docs]</a>    <span class="k">def</span> <span class="nf">button7</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">laser</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">laserdict</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_laser_via_button</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">laser</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span></div>

        <span class="c1"># print(&#39;Button 7 pressed&#39;)</span>

<div class="viewcode-block" id="mesoSPIM_GUI.button8"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.button8">[docs]</a>    <span class="k">def</span> <span class="nf">button8</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">laser</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">laserdict</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_laser_via_button</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">laser</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span></div>

        <span class="c1"># print(&#39;Button 8 pressed&#39;)</span>

<div class="viewcode-block" id="mesoSPIM_GUI.button9"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.button9">[docs]</a>    <span class="k">def</span> <span class="nf">button9</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>
        <span class="c1"># print(&#39;Button 9 pressed&#39;)</span>

<div class="viewcode-block" id="mesoSPIM_GUI.button10"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.button10">[docs]</a>    <span class="k">def</span> <span class="nf">button10</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">load_sample</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>
        <span class="c1"># print(&#39;Button 10 pressed&#39;)</span>

<div class="viewcode-block" id="mesoSPIM_GUI.button11"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.button11">[docs]</a>    <span class="k">def</span> <span class="nf">button11</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Increment filter &#39;&#39;&#39;</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FilterComboBox</span><span class="o">.</span><span class="n">currentIndex</span><span class="p">()</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filterdict</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FilterComboBox</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="n">index</span><span class="p">)</span></div>

        <span class="c1"># print(&#39;Button 11 pressed&#39;)</span>

<div class="viewcode-block" id="mesoSPIM_GUI.button12"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.button12">[docs]</a>    <span class="k">def</span> <span class="nf">button12</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Decrement filter &#39;&#39;&#39;</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FilterComboBox</span><span class="o">.</span><span class="n">currentIndex</span><span class="p">()</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FilterComboBox</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="n">index</span><span class="p">)</span></div>

        <span class="c1"># print(&#39;Button 12 pressed&#39;)</span>

<div class="viewcode-block" id="mesoSPIM_GUI.button13"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.button13">[docs]</a>    <span class="k">def</span> <span class="nf">button13</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Increment zoom &#39;&#39;&#39;</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ZoomComboBox</span><span class="o">.</span><span class="n">currentIndex</span><span class="p">()</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zoomdict</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ZoomComboBox</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="n">index</span><span class="p">)</span></div>

        <span class="c1"># print(&#39;Button 13 pressed&#39;)</span>

<div class="viewcode-block" id="mesoSPIM_GUI.button14"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.button14">[docs]</a>    <span class="k">def</span> <span class="nf">button14</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Decrement zoom &#39;&#39;&#39;</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ZoomComboBox</span><span class="o">.</span><span class="n">currentIndex</span><span class="p">()</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ZoomComboBox</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="n">index</span><span class="p">)</span></div>

        <span class="c1"># print(&#39;Button 14 pressed&#39;)</span>

<div class="viewcode-block" id="mesoSPIM_GUI.button15"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.button15">[docs]</a>    <span class="k">def</span> <span class="nf">button15</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Zero XYZ &#39;&#39;&#39;</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">zero_xyz</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>

        <span class="c1"># print(&#39;Button 15 pressed&#39;)</span>

<div class="viewcode-block" id="mesoSPIM_GUI.button16"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.button16">[docs]</a>    <span class="k">def</span> <span class="nf">button16</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Zero F &#39;&#39;&#39;</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">zero_focus</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>

        <span class="c1"># print(&#39;Button 16 pressed&#39;)</span>

<div class="viewcode-block" id="mesoSPIM_GUI.button17"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.button17">[docs]</a>    <span class="k">def</span> <span class="nf">button17</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Select left shutter &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ShutterComboBox</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">shutterconfig</span> <span class="o">=</span>  <span class="s1">&#39;Both&#39;</span></div>
        <span class="c1"># print(&#39;Button 17 pressed&#39;)</span>

<div class="viewcode-block" id="mesoSPIM_GUI.button18"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.button18">[docs]</a>    <span class="k">def</span> <span class="nf">button18</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Select left shutter &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ShutterComboBox</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">shutterconfig</span> <span class="o">=</span>  <span class="s1">&#39;Both&#39;</span></div>
        <span class="c1"># print(&#39;Button 17 pressed&#39;)</span>

<div class="viewcode-block" id="mesoSPIM_GUI.button19"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.button19">[docs]</a>    <span class="k">def</span> <span class="nf">button19</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Select left shutter &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ShutterComboBox</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">shutterconfig</span> <span class="o">=</span>  <span class="s1">&#39;Left&#39;</span></div>
        <span class="c1"># print(&#39;Button 19 pressed&#39;)</span>

<div class="viewcode-block" id="mesoSPIM_GUI.button20"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.button20">[docs]</a>    <span class="k">def</span> <span class="nf">button20</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Select right shutter &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ShutterComboBox</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">shutterconfig</span> <span class="o">=</span>  <span class="s1">&#39;Right&#39;</span></div>

            <span class="c1"># print(&#39;Button 18 pressed&#39;)</span>
        <span class="c1"># print(&#39;Button 20 pressed&#39;)</span>

<div class="viewcode-block" id="mesoSPIM_GUI.button21"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.button21">[docs]</a>    <span class="k">def</span> <span class="nf">button21</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">state</span>

        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;live&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">live</span><span class="p">()</span></div>

        <span class="c1"># print(&#39;Button 21 pressed&#39;)</span>

<div class="viewcode-block" id="mesoSPIM_GUI.button22"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.button22">[docs]</a>    <span class="k">def</span> <span class="nf">button22</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mark_stack_start</span><span class="p">()</span></div>
        <span class="c1"># print(&#39;Button 22 pressed&#39;)</span>

<div class="viewcode-block" id="mesoSPIM_GUI.button23"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.button23">[docs]</a>    <span class="k">def</span> <span class="nf">button23</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_z_planes</span><span class="p">()</span></div>
        <span class="c1"># print(&#39;Button 23 pressed&#39;)</span>

<div class="viewcode-block" id="mesoSPIM_GUI.button24"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.button24">[docs]</a>    <span class="k">def</span> <span class="nf">button24</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mark_stack_end</span><span class="p">()</span></div>
        <span class="c1"># print(&#39;Button 24 pressed&#39;)</span>

<div class="viewcode-block" id="mesoSPIM_GUI.button25"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.button25">[docs]</a>    <span class="k">def</span> <span class="nf">button25</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># print(&#39;Button 25 pressed&#39;)</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.button26"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.button26">[docs]</a>    <span class="k">def</span> <span class="nf">button26</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Increase laser intensity</span>

<span class="sd">        The LaserSliderChangeCount is used to decrease the number of events,</span>
<span class="sd">        otherwise the slider would be moved too quickly.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LaserSliderChangeCount</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">LaserSliderChangeCount</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LaserSlider</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="mi">100</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">LaserSlider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">LaserSlider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span></div>

        <span class="c1"># print(&#39;Button 26 pressed&#39;)</span>

<div class="viewcode-block" id="mesoSPIM_GUI.button27"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.button27">[docs]</a>    <span class="k">def</span> <span class="nf">button27</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Decrease laser intensity</span>

<span class="sd">        The LaserSliderChangeCount is used to decrease the number of events,</span>
<span class="sd">        otherwise the slider would be moved too quickly.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LaserSliderChangeCount</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">LaserSliderChangeCount</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LaserSlider</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">LaserSlider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">LaserSlider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>

        <span class="c1"># print(&#39;Button 27 pressed&#39;)</span>

<div class="viewcode-block" id="mesoSPIM_GUI.button28"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.button28">[docs]</a>    <span class="k">def</span> <span class="nf">button28</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">stop_movement</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>
        <span class="c1"># print(&#39;Button 28 pressed&#39;)</span>

<div class="viewcode-block" id="mesoSPIM_GUI.button29"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.button29">[docs]</a>    <span class="k">def</span> <span class="nf">button29</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># print(&#39;Button 29 pressed, Joystick mode: &#39;,self.joystick_mode)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">joystick_mode</span> <span class="o">==</span> <span class="s1">&#39;XY&#39;</span><span class="p">:</span>
            <span class="c1"># print(&#39;Choice 1&#39;)</span>
            <span class="sd">&#39;&#39;&#39; Switch Joystick Mode to the opposite &#39;&#39;&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">joystick_mode</span> <span class="o">=</span> <span class="s1">&#39;ZF&#39;</span>
            <span class="n">gsig</span><span class="o">.</span><span class="n">status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Joystick Mode: ZF Mode&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">joystick_mode</span> <span class="o">==</span> <span class="s1">&#39;ZF&#39;</span><span class="p">:</span>
            <span class="c1"># print(&#39;Choice 2&#39;)</span>
            <span class="sd">&#39;&#39;&#39; Switch Joystick Mode to the opposite &#39;&#39;&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">joystick_mode</span> <span class="o">=</span> <span class="s1">&#39;XY&#39;</span>
            <span class="n">gsig</span><span class="o">.</span><span class="n">status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Joystick Mode: XY Mode&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">joystick_mode</span> <span class="o">==</span> <span class="s1">&#39;Undefined&#39;</span><span class="p">:</span>
            <span class="c1"># print(&#39;Choice 3&#39;)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">joystick_mode</span> <span class="o">=</span> <span class="s1">&#39;Undefined&#39;</span>
            <span class="n">gsig</span><span class="o">.</span><span class="n">status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Joystick Mode: Undefined&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span></div>
            <span class="c1"># print(&#39;Choice 4&#39;)</span>

<div class="viewcode-block" id="mesoSPIM_GUI.button_handler_method"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.button_handler_method">[docs]</a>    <span class="k">def</span> <span class="nf">button_handler_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">method_to_call</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">string</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
            <span class="n">method_to_call</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.button_handler"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.button_handler">[docs]</a>    <span class="k">def</span> <span class="nf">button_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">string</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.joystick_handler"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.joystick_handler">[docs]</a>    <span class="k">def</span> <span class="nf">joystick_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">pass</span></div>
        <span class="c1"># print(axis, &#39; is: &#39;, value)</span>

<div class="viewcode-block" id="mesoSPIM_GUI.farm_panel_handler"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.farm_panel_handler">[docs]</a>    <span class="k">def</span> <span class="nf">farm_panel_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Buttons 1 to 8&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_1to8</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">group_1to8_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_1to8</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
        <span class="sd">&#39;&#39;&#39;Catch only events which are different from Off-events&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_1to8_string</span> <span class="o">!=</span> <span class="s1">&#39;00000000&#39;</span><span class="p">:</span>
            <span class="c1"># print(self.group_1to8_string)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">button_handler_method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_1to8_string</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">button1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">button_handler_method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_1to8_string</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">button2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">button_handler_method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_1to8_string</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">button3</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">button_handler_method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_1to8_string</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">button4</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">button_handler_method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_1to8_string</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">button5</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">button_handler_method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_1to8_string</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">button6</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">button_handler_method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_1to8_string</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">button7</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">button_handler_method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_1to8_string</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">button8</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">group_9to16</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_9to16_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_9to16</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
        <span class="c1">#print(self.group_9to16_string)</span>
        <span class="sd">&#39;&#39;&#39;Catch only events which are different from Off-events&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_9to16_string</span> <span class="o">!=</span> <span class="s1">&#39;00000000&#39;</span><span class="p">:</span>
            <span class="c1"># print(self.group_9to16_string)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">button_handler_method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_9to16_string</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">button9</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">button_handler_method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_9to16_string</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">button10</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">button_handler_method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_9to16_string</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">button11</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">button_handler_method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_9to16_string</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">button12</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">button_handler_method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_9to16_string</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">button13</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">button_handler_method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_9to16_string</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">button14</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">button_handler_method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_9to16_string</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">button15</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">button_handler_method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_9to16_string</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">button16</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">group_17to24</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_17to24_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_17to24</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
        <span class="sd">&#39;&#39;&#39;Catch only events which are different from Off-events&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_17to24_string</span> <span class="o">!=</span> <span class="s1">&#39;00000000&#39;</span><span class="p">:</span>
            <span class="c1"># print(self.group_17to24_string)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">button_handler_method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_17to24_string</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">button17</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">button_handler_method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_17to24_string</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">button18</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">button_handler_method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_17to24_string</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">button19</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">button_handler_method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_17to24_string</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">button20</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">button_handler_method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_17to24_string</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">button21</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">button_handler_method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_17to24_string</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">button22</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">button_handler_method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_17to24_string</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">button23</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">button_handler_method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_17to24_string</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">button24</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">group_25to29</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_25to29_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_25to29</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
        <span class="sd">&#39;&#39;&#39;Catch only events which are different from Off-events&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_25to29_string</span> <span class="o">!=</span> <span class="s1">&#39;00000000&#39;</span><span class="p">:</span>
            <span class="c1"># print(self.group_25to29_string)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">button_handler_method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_25to29_string</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">button25</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">button_handler_method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_25to29_string</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">button26</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">button_handler_method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_25to29_string</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">button27</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">button_handler_method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_25to29_string</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">button28</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">button_handler_method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_25to29_string</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">button29</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39;Joystick handling:</span>

<span class="sd">        Stop the joystick timer - a QTimer can be stopped even though it was never</span>
<span class="sd">        started. This allows every new arriving HID package to stop the</span>
<span class="sd">        persistent sending of messages.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">joystick_timer_stop</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">128</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">joystick_mode</span> <span class="o">=</span> <span class="s1">&#39;XY&#39;</span>
            <span class="n">gsig</span><span class="o">.</span><span class="n">status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Joystick Mode: XY Mode&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># inc for increment</span>
            <span class="n">inc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="mi">128</span><span class="p">)</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="mi">128</span> <span class="o">==</span> <span class="o">-</span><span class="mi">128</span> <span class="ow">or</span> <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="mi">128</span> <span class="o">==</span> <span class="mi">127</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x_rel&#39;</span><span class="p">:</span> <span class="n">inc</span><span class="p">,</span> <span class="s1">&#39;y_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;z_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;f_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;theta_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
                <span class="n">gsig</span><span class="o">.</span><span class="n">joystick_timer_start</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x_rel&#39;</span><span class="p">:</span> <span class="n">inc</span><span class="p">,</span> <span class="s1">&#39;y_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;z_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;f_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;theta_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
                <span class="n">gsig</span><span class="o">.</span><span class="n">move_relative</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">joystick_handler</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="mi">128</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">128</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">joystick_mode</span> <span class="o">=</span> <span class="s1">&#39;XY&#39;</span>
            <span class="n">gsig</span><span class="o">.</span><span class="n">status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Joystick Mode: XY Mode&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">inc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">-</span><span class="mi">128</span><span class="p">)</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">-</span><span class="mi">128</span> <span class="o">==</span> <span class="o">-</span><span class="mi">128</span> <span class="ow">or</span> <span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">-</span><span class="mi">128</span> <span class="o">==</span> <span class="mi">127</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;y_rel&#39;</span><span class="p">:</span> <span class="n">inc</span><span class="p">,</span> <span class="s1">&#39;z_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;f_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;theta_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
                <span class="n">gsig</span><span class="o">.</span><span class="n">joystick_timer_start</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;y_rel&#39;</span><span class="p">:</span> <span class="n">inc</span><span class="p">,</span> <span class="s1">&#39;z_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;f_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;theta_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
                <span class="n">gsig</span><span class="o">.</span><span class="n">move_relative</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">joystick_handler</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">-</span><span class="mi">128</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">128</span><span class="p">:</span>
            <span class="c1"># inc = int((data[7]-128)/8)</span>
            <span class="c1"># message = {&#39;x_rel&#39;: 0, &#39;y_rel&#39;: 0, &#39;z_rel&#39;: inc, &#39;f_rel&#39;: 0, &#39;theta_rel&#39;: 0}</span>
            <span class="c1"># gsig.move_relative.emit(message)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">joystick_handler</span><span class="p">(</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">-</span><span class="mi">128</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">128</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">joystick_mode</span> <span class="o">=</span> <span class="s1">&#39;ZF&#39;</span>
            <span class="n">gsig</span><span class="o">.</span><span class="n">status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Joystick Mode: ZF Mode&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

            <span class="sd">&#39;&#39;&#39;Twist as fine focus&#39;&#39;&#39;</span>
            <span class="n">inc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">-</span><span class="mi">128</span><span class="p">)</span><span class="o">/</span><span class="mi">30</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">-</span><span class="mi">128</span> <span class="o">==</span> <span class="o">-</span><span class="mi">128</span> <span class="ow">or</span> <span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">-</span><span class="mi">128</span> <span class="o">==</span> <span class="mi">127</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;y_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;z_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;f_rel&#39;</span><span class="p">:</span> <span class="n">inc</span><span class="p">,</span> <span class="s1">&#39;theta_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
                <span class="n">gsig</span><span class="o">.</span><span class="n">joystick_timer_start</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;y_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;z_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;f_rel&#39;</span><span class="p">:</span> <span class="n">inc</span><span class="p">,</span> <span class="s1">&#39;theta_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
                <span class="n">gsig</span><span class="o">.</span><span class="n">move_relative</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">joystick_handler</span><span class="p">(</span><span class="s1">&#39;RZ&#39;</span><span class="p">,</span><span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">-</span><span class="mi">128</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">128</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">joystick_mode</span> <span class="o">=</span> <span class="s1">&#39;ZF&#39;</span>
            <span class="n">gsig</span><span class="o">.</span><span class="n">status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Joystick Mode: ZF Mode&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">inc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">-</span><span class="mi">128</span><span class="p">)</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">-</span><span class="mi">128</span> <span class="o">==</span> <span class="o">-</span><span class="mi">128</span> <span class="ow">or</span> <span class="n">data</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">-</span><span class="mi">128</span> <span class="o">==</span> <span class="mi">127</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;y_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;z_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;f_rel&#39;</span><span class="p">:</span> <span class="n">inc</span><span class="p">,</span> <span class="s1">&#39;theta_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
                <span class="n">gsig</span><span class="o">.</span><span class="n">joystick_timer_start</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;y_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;z_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;f_rel&#39;</span><span class="p">:</span> <span class="n">inc</span><span class="p">,</span> <span class="s1">&#39;theta_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
                <span class="n">gsig</span><span class="o">.</span><span class="n">move_relative</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">joystick_handler</span><span class="p">(</span><span class="s1">&#39;(2) RY&#39;</span><span class="p">,</span><span class="n">data</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">-</span><span class="mi">128</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">128</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">joystick_mode</span> <span class="o">=</span> <span class="s1">&#39;ZF&#39;</span>
            <span class="n">gsig</span><span class="o">.</span><span class="n">status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Joystick Mode: ZF Mode&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">inc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">-</span><span class="mi">128</span><span class="p">)</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">-</span><span class="mi">128</span> <span class="o">==</span> <span class="o">-</span><span class="mi">128</span> <span class="ow">or</span> <span class="n">data</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">-</span><span class="mi">128</span> <span class="o">==</span> <span class="mi">127</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;y_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;z_rel&#39;</span><span class="p">:</span> <span class="n">inc</span><span class="p">,</span> <span class="s1">&#39;f_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;theta_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
                <span class="n">gsig</span><span class="o">.</span><span class="n">joystick_timer_start</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;y_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;z_rel&#39;</span><span class="p">:</span> <span class="n">inc</span><span class="p">,</span> <span class="s1">&#39;f_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;theta_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
                <span class="n">gsig</span><span class="o">.</span><span class="n">move_relative</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">joystick_handler</span><span class="p">(</span><span class="s1">&#39;(3) RX&#39;</span><span class="p">,</span><span class="n">data</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">-</span><span class="mi">128</span><span class="p">)</span></div>

    <span class="sd">&#39;&#39;&#39; As the HID handling is threaded, additional methods are necessary to</span>
<span class="sd">    deal with starting &amp; stopping of the joystick timer&#39;&#39;&#39;</span>

<div class="viewcode-block" id="mesoSPIM_GUI.joystick_timer_start"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.joystick_timer_start">[docs]</a>    <span class="k">def</span> <span class="nf">joystick_timer_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; The interval is hardcoded and was found to be ok with PI stages &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">joystick_timer</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.joystick_timer_stop"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.joystick_timer_stop">[docs]</a>    <span class="k">def</span> <span class="nf">joystick_timer_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">joystick_timer</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.joystick_persistent_update"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.joystick_persistent_update">[docs]</a>    <span class="k">def</span> <span class="nf">joystick_persistent_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">move_relative</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.load_script"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.load_script">[docs]</a>    <span class="k">def</span> <span class="nf">load_script</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Load a script</span>

<span class="sd">        The empty string in the method arguments ensures that it remembers the</span>
<span class="sd">        last location from where a file was opened.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">path</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="o">.</span><span class="n">getOpenFileName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Load script&quot;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39; To avoid crashes, continue only when a file has been selected:&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">myscript</span><span class="p">:</span>
                <span class="n">script</span> <span class="o">=</span> <span class="n">myscript</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scriptEdit</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">script_mutex</span><span class="p">):</span>
                <span class="n">script_repository</span><span class="o">.</span><span class="n">script</span> <span class="o">=</span> <span class="n">script</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.save_script"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.save_script">[docs]</a>    <span class="k">def</span> <span class="nf">save_script</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Save a script &#39;&#39;&#39;</span>
        <span class="n">path</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="o">.</span><span class="n">getSaveFileName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;Save File&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39; To avoid crashes, continue only when a file has been selected:&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">myscript</span><span class="p">:</span>
                <span class="n">script</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scriptEdit</span><span class="o">.</span><span class="n">toPlainText</span><span class="p">()</span>
                <span class="n">myscript</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>

            <span class="sd">&#39;&#39;&#39; Is an update of the mutexed script here really necessary? &#39;&#39;&#39;</span>
            <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">script_mutex</span><span class="p">):</span>
                <span class="n">script_repository</span><span class="o">.</span><span class="n">script</span> <span class="o">=</span> <span class="n">script</span></div>

<div class="viewcode-block" id="mesoSPIM_GUI.execute_script"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_GUI.execute_script">[docs]</a>    <span class="k">def</span> <span class="nf">execute_script</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;If the script comes as a string, we can just exec it&#39;&#39;&#39;</span>
        <span class="n">script</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scriptEdit</span><span class="o">.</span><span class="n">toPlainText</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">script_mutex</span><span class="p">):</span>
            <span class="n">script_repository</span><span class="o">.</span><span class="n">script</span> <span class="o">=</span> <span class="n">script</span>
        <span class="sd">&#39;&#39;&#39; Any script will need a stop button - is that a good idea? &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">enable_stop_button</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_progressbar_to_busy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disable_controls</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disable_mode_control_buttons</span><span class="p">()</span>

        <span class="n">gsig</span><span class="o">.</span><span class="n">execute_script</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div></div>

<div class="viewcode-block" id="mesoSPIM_camera_GUI"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_camera_GUI">[docs]</a><span class="k">class</span> <span class="nc">mesoSPIM_camera_GUI</span><span class="p">(</span><span class="n">QWidget</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="sd">&#39;&#39;&#39;Set up the UI&#39;&#39;&#39;</span>
        <span class="n">loadUi</span><span class="p">(</span><span class="s1">&#39;gui/mesoSPIM-GUI-camera.ui&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s1">&#39;mesoSPIM-Control&#39;</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39; Set histogram Range &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graphicsView</span><span class="o">.</span><span class="n">setLevels</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">4000</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">imageItem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graphicsView</span><span class="o">.</span><span class="n">getImageItem</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">histogram</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graphicsView</span><span class="o">.</span><span class="n">getHistogramWidget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">histogram</span><span class="o">.</span><span class="n">setMinimumWidth</span><span class="p">(</span><span class="mi">250</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">histogram</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">vb</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="mi">250</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39; Initialize crosshairs &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crosspen</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">mkPen</span><span class="p">({</span><span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vLine</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">InfiniteLine</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">movable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">crosspen</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hLine</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">InfiniteLine</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">movable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">crosspen</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graphicsView</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vLine</span><span class="p">,</span> <span class="n">ignoreBounds</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graphicsView</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hLine</span><span class="p">,</span> <span class="n">ignoreBounds</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="mesoSPIM_camera_GUI.display_status_message"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_camera_GUI.display_status_message">[docs]</a>    <span class="nd">@pyqtSlot</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">display_status_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Displays a message in the status bar for a time in ms</span>

<span class="sd">        If time=0, the message will stay.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">time</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span><span class="o">.</span><span class="n">showMessage</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_camera_GUI.draw_crosshairs"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_camera_GUI.draw_crosshairs">[docs]</a>    <span class="k">def</span> <span class="nf">draw_crosshairs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graphicsView</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vLine</span><span class="p">,</span> <span class="n">ignoreBounds</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graphicsView</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hLine</span><span class="p">,</span> <span class="n">ignoreBounds</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_camera_GUI.set_image"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_camera_GUI.set_image">[docs]</a>    <span class="nd">@pyqtSlot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">set_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graphicsView</span><span class="o">.</span><span class="n">setImage</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">autoLevels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">autoHistogramRange</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">autoRange</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">draw_crosshairs</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="mesoSPIM_Core"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core">[docs]</a><span class="k">class</span> <span class="nc">mesoSPIM_Core</span><span class="p">(</span><span class="n">QObject</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    The mesoSPIM core takes care of all interactions with NI hardware and is</span>
<span class="sd">    thus the pacemaker of the microscope (responsible for synchronizing</span>
<span class="sd">    all digital and analog outs).</span>



<span class="sd">    TODO: In the future, the core will take care of script execution as well.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="sd">&#39;&#39;&#39;Configuration details&#39;&#39;&#39;</span>

        <span class="c1">#self.s = mesoSPIM_State(config)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_create_waveforms</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">laserdict</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">laserdict</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">laserenable</span> <span class="o">=</span> <span class="n">laserenable</span><span class="o">.</span><span class="n">Laser_Enabler</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">laserdict</span><span class="p">)</span>

        <span class="c1">## Set the Shutters up</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">left_shutter_line</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">shutterdict</span><span class="p">[</span><span class="s1">&#39;shutter_left&#39;</span><span class="p">]</span>
            <span class="n">right_shutter_line</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">shutterdict</span><span class="p">[</span><span class="s1">&#39;shutter_right&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">shutter_left</span> <span class="o">=</span> <span class="n">shutter</span><span class="o">.</span><span class="n">Shutter</span><span class="p">(</span><span class="n">left_shutter_line</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutter_right</span> <span class="o">=</span> <span class="n">shutter</span><span class="o">.</span><span class="n">Shutter</span><span class="p">(</span><span class="n">right_shutter_line</span><span class="p">)</span>

        <span class="c1"># all shutters should be disabled:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutter_left</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutter_right</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">laser</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">laser</span>
            <span class="n">intensity</span> <span class="o">=</span>  <span class="n">s</span><span class="o">.</span><span class="n">intensity</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_laser</span><span class="p">(</span><span class="n">laser</span><span class="p">,</span> <span class="n">intensity</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39; Wiring up the global signals: Mode changes &#39;&#39;&#39;</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">live</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">live</span><span class="p">)</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">snap</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">snap</span><span class="p">)</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">stop</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">visual_mode</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">visual_mode</span><span class="p">)</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">lightsheet_alignment_mode</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lightsheet_alignment_mode</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39; Wiring up other global signals &#39;&#39;&#39;</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">update_stack_parameters</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_stack_parameters</span><span class="p">)</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">update_waveforms</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_waveforms</span><span class="p">)</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">update_etl_from_csv</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_etl</span><span class="p">)</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">save_etl_parameters_to_csv</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_etl_parameters_to_csv</span><span class="p">)</span>

        <span class="c1"># gsig.update_sweeptime.connect(self.set_sweeptime)</span>

        <span class="n">gsig</span><span class="o">.</span><span class="n">update_position</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_position_state</span><span class="p">)</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">set_zoom</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_zoom</span><span class="p">)</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">set_intensity</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_intensity</span><span class="p">)</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">set_laser_and_intensity</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_laser</span><span class="p">)</span>

        <span class="n">gsig</span><span class="o">.</span><span class="n">execute_script</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">execute_script</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; If you crash, please close the door.&#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutter_left</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutter_right</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

<div class="viewcode-block" id="mesoSPIM_Core.stop"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Signal-invoked local stop flag telling all listeners to stop.</span>

<span class="sd">        TODO: Investigate whether this might be better handled with an</span>
<span class="sd">        internal signal.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.update_position_state"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core.update_position_state">[docs]</a>    <span class="nd">@pyqtSlot</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">update_position_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position_dict</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">position_dict</span></div>

    <span class="k">def</span> <span class="nf">_create_waveforms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Calculate the number of samples:</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">calculate_samples</span><span class="p">()</span>
            <span class="n">samples</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">samples</span>
            <span class="n">samplerate</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">samplerate</span>
            <span class="n">sweeptime</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">sweeptime</span>
            <span class="n">etl_l_delay_percent</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">etl_l_delay_percent</span>
            <span class="n">etl_l_ramp_rising_percent</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">etl_l_ramp_rising_percent</span>
            <span class="n">etl_l_ramp_falling_percent</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">etl_l_ramp_falling_percent</span>
            <span class="n">etl_l_amplitude</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">etl_l_amplitude</span>
            <span class="n">etl_l_offset</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">etl_l_offset</span>
            <span class="n">etl_r_delay_percent</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">etl_r_delay_percent</span>
            <span class="n">etl_r_ramp_rising_percent</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">etl_r_ramp_rising_percent</span>
            <span class="n">etl_r_ramp_falling_percent</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">etl_r_ramp_falling_percent</span>
            <span class="n">etl_r_amplitude</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">etl_r_amplitude</span><span class="p">,</span>
            <span class="n">etl_r_offset</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">etl_r_offset</span>
            <span class="n">galvo_l_frequency</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">galvo_l_frequency</span>
            <span class="n">galvo_l_amplitude</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">galvo_l_amplitude</span>
            <span class="n">galvo_l_offset</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">galvo_l_offset</span>
            <span class="n">galvo_r_offset</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">galvo_r_offset</span>
            <span class="n">galvo_l_phase</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">galvo_l_phase</span>
            <span class="n">galvo_r_phase</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">galvo_r_phase</span>
            <span class="n">laser_designation</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">laser_designation</span>
            <span class="n">laser</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">laser</span>
            <span class="n">intensity</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">intensity</span>
            <span class="n">laser_delay_percent</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">laser_delay_percent</span>
            <span class="n">laser_pulse_percent</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">laser_pulse_percent</span>

        <span class="sd">&#39;&#39;&#39;Create ETL L and R waveforms&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">etl_l_waveform</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">tunable_lens_ramp</span><span class="p">(</span><span class="n">samplerate</span> <span class="o">=</span> <span class="n">samplerate</span><span class="p">,</span>
                                                   <span class="n">sweeptime</span> <span class="o">=</span> <span class="n">sweeptime</span><span class="p">,</span>
                                                   <span class="n">delay</span> <span class="o">=</span> <span class="n">etl_l_delay_percent</span><span class="p">,</span>
                                                   <span class="n">rise</span> <span class="o">=</span> <span class="n">etl_l_ramp_rising_percent</span><span class="p">,</span>
                                                   <span class="n">fall</span> <span class="o">=</span> <span class="n">etl_l_ramp_falling_percent</span><span class="p">,</span>
                                                   <span class="n">amplitude</span> <span class="o">=</span> <span class="n">etl_l_amplitude</span><span class="p">,</span>
                                                   <span class="n">offset</span> <span class="o">=</span> <span class="n">etl_l_offset</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">etl_r_waveform</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">tunable_lens_ramp</span><span class="p">(</span><span class="n">samplerate</span> <span class="o">=</span> <span class="n">samplerate</span><span class="p">,</span>
                                                   <span class="n">sweeptime</span> <span class="o">=</span> <span class="n">sweeptime</span><span class="p">,</span>
                                                   <span class="n">delay</span> <span class="o">=</span> <span class="n">etl_r_delay_percent</span><span class="p">,</span>
                                                   <span class="n">rise</span> <span class="o">=</span> <span class="n">etl_r_ramp_rising_percent</span><span class="p">,</span>
                                                   <span class="n">fall</span> <span class="o">=</span> <span class="n">etl_r_ramp_falling_percent</span><span class="p">,</span>
                                                   <span class="n">amplitude</span> <span class="o">=</span> <span class="n">etl_r_amplitude</span><span class="p">,</span>
                                                   <span class="n">offset</span> <span class="o">=</span> <span class="n">etl_r_offset</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39;Create Galvo waveforms:&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_galvo_waveforms</span><span class="p">(</span><span class="n">freq</span> <span class="o">=</span> <span class="n">galvo_l_frequency</span><span class="p">,</span>
                                    <span class="n">amp</span> <span class="o">=</span> <span class="n">galvo_l_amplitude</span><span class="p">,</span>
                                    <span class="n">offset_l</span> <span class="o">=</span> <span class="n">galvo_l_offset</span><span class="p">,</span>
                                    <span class="n">offset_r</span> <span class="o">=</span> <span class="n">galvo_r_offset</span><span class="p">,</span>
                                    <span class="n">phase_l</span> <span class="o">=</span> <span class="n">galvo_l_phase</span><span class="p">,</span>
                                    <span class="n">phase_r</span> <span class="o">=</span> <span class="n">galvo_r_phase</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39;Create zero waveforms for the lasers&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zero_waveform</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">samples</span><span class="p">))</span>

        <span class="sd">&#39;&#39;&#39;This could be improved: create a list with as many zero arrays as analog out lines for ETL and Lasers&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">laser_waveform_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">zero_waveform</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">laser_designation</span><span class="p">]</span>

        <span class="sd">&#39;&#39;&#39;Bundle everything&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bundle_galvo_and_etl_waveforms</span><span class="p">()</span>

        <span class="sd">&#39;&#39;&#39;Update the laser intensity waveform&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_laser_intensity</span><span class="p">(</span><span class="n">laser</span><span class="p">,</span>
                                 <span class="n">intensity</span><span class="p">,</span>
                                 <span class="n">delay_percent</span><span class="o">=</span><span class="n">laser_delay_percent</span><span class="p">,</span>
                                 <span class="n">pulse_percent</span><span class="o">=</span><span class="n">laser_pulse_percent</span><span class="p">)</span>

<div class="viewcode-block" id="mesoSPIM_Core.set_galvo_waveforms"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core.set_galvo_waveforms">[docs]</a>    <span class="k">def</span> <span class="nf">set_galvo_waveforms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq</span> <span class="o">=</span> <span class="mf">99.5</span><span class="p">,</span> <span class="n">amp</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">offset_l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">offset_r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phase_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">phase_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Updates galvo waveforms, assumes that the frequencies and amplitudes are the same on both sides&#39;&#39;&#39;</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">samplerate</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">samplerate</span>
            <span class="n">sweeptime</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">sweeptime</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">galvo_l_waveform</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">sawtooth</span><span class="p">(</span><span class="n">samplerate</span><span class="p">,</span>
                                            <span class="n">sweeptime</span><span class="p">,</span>
                                            <span class="n">freq</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">offset_l</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">phase_l</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">galvo_r_waveform</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">sawtooth</span><span class="p">(</span><span class="n">samplerate</span><span class="p">,</span>
                                            <span class="n">sweeptime</span><span class="p">,</span>
                                            <span class="n">freq</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">offset_r</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">phase_r</span><span class="p">)</span>
        <span class="sd">&#39;&#39;&#39;Update the state&#39;&#39;&#39;</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">galvo_l_frequency</span> <span class="o">=</span> <span class="n">freq</span>
            <span class="n">s</span><span class="o">.</span><span class="n">galvo_l_amplitude</span> <span class="o">=</span> <span class="n">amp</span>
            <span class="n">s</span><span class="o">.</span><span class="n">galvo_l_offset</span> <span class="o">=</span> <span class="n">offset_l</span>
            <span class="n">s</span><span class="o">.</span><span class="n">galvo_r_offset</span> <span class="o">=</span> <span class="n">offset_r</span>
            <span class="n">s</span><span class="o">.</span><span class="n">galvo_l_phase</span> <span class="o">=</span> <span class="n">phase_l</span>
            <span class="n">s</span><span class="o">.</span><span class="n">galvo_r_phase</span> <span class="o">=</span> <span class="n">phase_r</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bundle_galvo_and_etl_waveforms</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.set_etl_l_waveform"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core.set_etl_l_waveform">[docs]</a>    <span class="k">def</span> <span class="nf">set_etl_l_waveform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Allows simple external changing of the ETL left parameters&#39;&#39;&#39;</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">samplerate</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">samplerate</span>
            <span class="n">sweeptime</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">sweeptime</span>
            <span class="n">etl_l_delay_percent</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">etl_l_delay_percent</span>
            <span class="n">etl_l_ramp_rising_percent</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">etl_l_ramp_rising_percent</span>
            <span class="n">etl_l_ramp_falling_percent</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">etl_l_ramp_falling_percent</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">etl_l_waveform</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">tunable_lens_ramp</span><span class="p">(</span><span class="n">samplerate</span><span class="p">,</span>
                                                   <span class="n">sweeptime</span><span class="p">,</span>
                                                   <span class="n">etl_l_delay_percent</span><span class="p">,</span>
                                                   <span class="n">rise</span> <span class="o">=</span> <span class="n">etl_l_ramp_rising_percent</span><span class="p">,</span>
                                                   <span class="n">fall</span> <span class="o">=</span> <span class="n">etl_l_ramp_falling_percent</span><span class="p">,</span>
                                                   <span class="n">amplitude</span> <span class="o">=</span> <span class="n">amplitude</span><span class="p">,</span>
                                                   <span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bundle_galvo_and_etl_waveforms</span><span class="p">()</span>

        <span class="sd">&#39;&#39;&#39;Update the state dictionary:&#39;&#39;&#39;</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">etl_l_amplitude</span> <span class="o">=</span> <span class="n">amplitude</span>
            <span class="n">s</span><span class="o">.</span><span class="n">etl_l_offset</span> <span class="o">=</span> <span class="n">offset</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.set_etl_r_waveform"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core.set_etl_r_waveform">[docs]</a>    <span class="k">def</span> <span class="nf">set_etl_r_waveform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Allows simple external changing of the ETL right parameters&#39;&#39;&#39;</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">samplerate</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">samplerate</span>
            <span class="n">sweeptime</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">sweeptime</span>
            <span class="n">etl_r_delay_percent</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">etl_r_delay_percent</span>
            <span class="n">etl_r_ramp_rising_percent</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">etl_r_ramp_rising_percent</span>
            <span class="n">etl_r_ramp_falling_percent</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">etl_r_ramp_falling_percent</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">etl_r_waveform</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">tunable_lens_ramp</span><span class="p">(</span><span class="n">samplerate</span><span class="p">,</span>
                                                   <span class="n">sweeptime</span><span class="p">,</span>
                                                   <span class="n">etl_r_delay_percent</span><span class="p">,</span>
                                                   <span class="n">rise</span> <span class="o">=</span> <span class="n">etl_r_ramp_rising_percent</span><span class="p">,</span>
                                                   <span class="n">fall</span> <span class="o">=</span> <span class="n">etl_r_ramp_falling_percent</span><span class="p">,</span>
                                                   <span class="n">amplitude</span> <span class="o">=</span> <span class="n">amplitude</span><span class="p">,</span>
                                                   <span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bundle_galvo_and_etl_waveforms</span><span class="p">()</span>

        <span class="sd">&#39;&#39;&#39;Update the state dictionary:&#39;&#39;&#39;</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">etl_r_amplitude</span> <span class="o">=</span> <span class="n">amplitude</span>
            <span class="n">s</span><span class="o">.</span><span class="n">etl_r_offset</span> <span class="o">=</span> <span class="n">offset</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.set_laser_intensity"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core.set_laser_intensity">[docs]</a>    <span class="k">def</span> <span class="nf">set_laser_intensity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                               <span class="n">laserline</span><span class="p">,</span>
                               <span class="n">intensity</span><span class="p">,</span>
                               <span class="n">delay_percent</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                               <span class="n">pulse_percent</span> <span class="o">=</span> <span class="mi">80</span><span class="p">):</span>

        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">samplerate</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">samplerate</span>
            <span class="n">sweeptime</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">sweeptime</span>
            <span class="n">max_laser_voltage</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">max_laser_voltage</span>
            <span class="n">laserline</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">laser_designation</span><span class="p">[</span><span class="n">laserline</span><span class="p">]</span>

        <span class="sd">&#39;&#39;&#39; Going from percent of the max to volts:&#39;&#39;&#39;</span>
        <span class="n">laser_voltage</span> <span class="o">=</span> <span class="n">max_laser_voltage</span> <span class="o">*</span> <span class="n">intensity</span> <span class="o">/</span> <span class="mi">100</span>

        <span class="sd">&#39;&#39;&#39;Create template waveform with the correct intensity&#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">laser_template_waveform</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">single_pulse</span><span class="p">(</span><span class="n">samplerate</span><span class="p">,</span>
                                                       <span class="n">sweeptime</span><span class="p">,</span>
                                                       <span class="n">delay_percent</span><span class="p">,</span>
                                                       <span class="n">pulse_percent</span><span class="p">,</span>
                                                       <span class="n">laser_voltage</span><span class="p">,</span>
                                                       <span class="mi">0</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39;The key: replace the waveform in the waveform list with this new template&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">laser_waveform_list</span><span class="p">[</span><span class="n">laserline</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">laser_template_waveform</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">laser_waveforms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">laser_waveform_list</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">intensity</span> <span class="o">=</span> <span class="n">intensity</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.bundle_galvo_and_etl_waveforms"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core.bundle_galvo_and_etl_waveforms">[docs]</a>    <span class="k">def</span> <span class="nf">bundle_galvo_and_etl_waveforms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Stacks the Galvo and ETL waveforms into a numpy array adequate for</span>
<span class="sd">        the NI cards.</span>

<span class="sd">        In here, the assignment of output channels of the Galvo / ETL card to the</span>
<span class="sd">        corresponding output channel is hardcoded: This could be improved.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">galvo_and_etl_waveforms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">galvo_l_waveform</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">galvo_r_waveform</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">etl_l_waveform</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">etl_r_waveform</span><span class="p">))</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.set_zoom"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core.set_zoom">[docs]</a>    <span class="nd">@pyqtSlot</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">set_zoom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zoom</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Little helper method: Because the mesoSPIM core is not handling</span>
<span class="sd">        the serial Zoom connection. &#39;&#39;&#39;</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">etl_cfg_file</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">etl_cfg_file</span>
            <span class="n">laser</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">laser</span>
            <span class="n">s</span><span class="o">.</span><span class="n">zoom</span> <span class="o">=</span> <span class="n">zoom</span>
            <span class="n">s</span><span class="o">.</span><span class="n">pixelsize</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pixelsize</span><span class="p">[</span><span class="n">zoom</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_etl_parameters_from_csv</span><span class="p">(</span><span class="n">etl_cfg_file</span><span class="p">,</span> <span class="n">laser</span><span class="p">,</span> <span class="n">zoom</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.update_etl_parameters_from_csv"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core.update_etl_parameters_from_csv">[docs]</a>    <span class="nd">@pyqtSlot</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">update_etl_parameters_from_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfg_path</span><span class="p">,</span> <span class="n">laser</span><span class="p">,</span> <span class="n">zoom</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Updates the internal ETL left/right offsets and amplitudes from the</span>
<span class="sd">        values in the ETL csv files</span>

<span class="sd">        The .csv file needs to contain the follwing columns:</span>

<span class="sd">        Wavelength</span>
<span class="sd">        Zoom</span>
<span class="sd">        ETL-Left-Offset</span>
<span class="sd">        ETL-Left-Amp</span>
<span class="sd">        ETL-Right-Offset</span>
<span class="sd">        ETL-Right-Amp</span>


<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># print(&#39;Updating ETL parameters from file:&#39;, cfg_path)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cfg_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
            <span class="c1">#print(&#39;opened csv&#39;)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Wavelength&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">laser</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Zoom&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">zoom</span><span class="p">:</span>

                    <span class="sd">&#39;&#39;&#39; Some diagnostic tracing statements</span>

<span class="sd">                    # print(row)</span>
<span class="sd">                    # print(&#39;updating parameters&#39;)</span>
<span class="sd">                    # print(self.etl_l[&#39;amplitude&#39;])</span>

<span class="sd">                    &#39;&#39;&#39;</span>
                    <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
                        <span class="n">s</span><span class="o">.</span><span class="n">etl_l_offset</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;ETL-Left-Offset&#39;</span><span class="p">])</span>
                        <span class="n">s</span><span class="o">.</span><span class="n">etl_l_amplitude</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;ETL-Left-Amp&#39;</span><span class="p">])</span>
                        <span class="n">s</span><span class="o">.</span><span class="n">etl_r_offset</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;ETL-Right-Offset&#39;</span><span class="p">])</span>
                        <span class="n">s</span><span class="o">.</span><span class="n">etl_r_amplitude</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;ETL-Right-Amp&#39;</span><span class="p">])</span>

        <span class="sd">&#39;&#39;&#39;Update waveforms with the new parameters&#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_create_waveforms</span><span class="p">()</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">update_etl_gui</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.save_etl_parameters_to_csv"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core.save_etl_parameters_to_csv">[docs]</a>    <span class="nd">@pyqtSlot</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">save_etl_parameters_to_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Saves the current ETL left/right offsets and amplitudes from the</span>
<span class="sd">        values to the ETL csv files</span>

<span class="sd">        The .csv file needs to contain the following columns:</span>

<span class="sd">        Wavelength</span>
<span class="sd">        Zoom</span>
<span class="sd">        ETL-Left-Offset</span>
<span class="sd">        ETL-Left-Amp</span>
<span class="sd">        ETL-Right-Offset</span>
<span class="sd">        ETL-Right-Amp</span>

<span class="sd">        Creates a temporary cfg file with the ending _tmp</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">etl_cfg_file</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">etl_cfg_file</span>
            <span class="n">laser</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">laser</span>
            <span class="n">zoom</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">zoom</span>
            <span class="n">etl_l_offset</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">etl_l_offset</span>
            <span class="n">etl_l_amplitude</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">etl_l_amplitude</span>
            <span class="n">etl_r_offset</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">etl_r_offset</span>
            <span class="n">etl_r_amplitude</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">etl_r_amplitude</span>

        <span class="sd">&#39;&#39;&#39;Temporary filepath&#39;&#39;&#39;</span>
        <span class="n">tmp_etl_cfg_file</span> <span class="o">=</span> <span class="n">etl_cfg_file</span><span class="o">+</span><span class="s1">&#39;_tmp&#39;</span>

        <span class="c1"># print(&#39;saving current ETL parameters&#39;)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">etl_cfg_file</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">input_file</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmp_etl_cfg_file</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outputfile</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span><span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
            <span class="c1">#print(&#39;created reader&#39;)</span>
            <span class="n">fieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Objective&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;Wavelength&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;Zoom&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;ETL-Left-Offset&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;ETL-Left-Amp&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;ETL-Right-Offset&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;ETL-Right-Amp&#39;</span><span class="p">]</span>

            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">outputfile</span><span class="p">,</span><span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">,</span><span class="n">dialect</span><span class="o">=</span><span class="s1">&#39;excel&#39;</span><span class="p">,</span><span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
            <span class="c1">#print(&#39;created writer&#39;)</span>

            <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Wavelength&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">laser</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Zoom&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">zoom</span><span class="p">:</span>

                        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">({</span><span class="s1">&#39;Objective&#39;</span> <span class="p">:</span> <span class="s1">&#39;1x&#39;</span><span class="p">,</span>
                                         <span class="s1">&#39;Wavelength&#39;</span> <span class="p">:</span> <span class="n">laser</span><span class="p">,</span>
                                         <span class="s1">&#39;Zoom&#39;</span> <span class="p">:</span> <span class="n">zoom</span><span class="p">,</span>
                                         <span class="s1">&#39;ETL-Left-Offset&#39;</span> <span class="p">:</span> <span class="n">etl_l_offset</span><span class="p">,</span>
                                         <span class="s1">&#39;ETL-Left-Amp&#39;</span> <span class="p">:</span> <span class="n">etl_l_amplitude</span><span class="p">,</span>
                                         <span class="s1">&#39;ETL-Right-Offset&#39;</span> <span class="p">:</span> <span class="n">etl_r_offset</span><span class="p">,</span>
                                         <span class="s1">&#39;ETL-Right-Amp&#39;</span> <span class="p">:</span> <span class="n">etl_r_amplitude</span><span class="p">,</span>
                                         <span class="p">})</span>

                <span class="k">else</span><span class="p">:</span>
                        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

            <span class="n">writer</span><span class="o">.</span><span class="n">writerows</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">etl_cfg_file</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">tmp_etl_cfg_file</span><span class="p">,</span> <span class="n">etl_cfg_file</span><span class="p">)</span></div>


<div class="viewcode-block" id="mesoSPIM_Core.create_tasks"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core.create_tasks">[docs]</a>    <span class="k">def</span> <span class="nf">create_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Creates a total of four tasks for the mesoSPIM:</span>

<span class="sd">        These are:</span>
<span class="sd">        - the master trigger task, a digital out task that only provides a trigger pulse for the others</span>
<span class="sd">        - the camera trigger task, a counter task that triggers the camera in lightsheet mode</span>
<span class="sd">        - the galvo task (analog out) that controls the left &amp; right galvos for creation of</span>
<span class="sd">          the light-sheet and shadow avoidance</span>
<span class="sd">        - the ETL &amp; Laser task (analog out) that controls all the laser intensities (Laser should only</span>
<span class="sd">          be on when the camera is acquiring) and the left/right ETL waveforms</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">ah</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">acquisition_hardware</span>
            <span class="n">samplerate</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">samplerate</span>
            <span class="n">samples</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">samples</span>
            <span class="n">sweeptime</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">sweeptime</span>
            <span class="n">camera_pulse_percent</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">camera_pulse_percent</span>
            <span class="n">camera_delay_percent</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">camera_delay_percent</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">master_trigger_task</span> <span class="o">=</span> <span class="n">nidaqmx</span><span class="o">.</span><span class="n">Task</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_trigger_task</span> <span class="o">=</span> <span class="n">nidaqmx</span><span class="o">.</span><span class="n">Task</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">galvo_etl_task</span> <span class="o">=</span> <span class="n">nidaqmx</span><span class="o">.</span><span class="n">Task</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">laser_task</span> <span class="o">=</span> <span class="n">nidaqmx</span><span class="o">.</span><span class="n">Task</span><span class="p">()</span>

        <span class="sd">&#39;&#39;&#39;Housekeeping: Setting up the DO master trigger task&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">master_trigger_task</span><span class="o">.</span><span class="n">do_channels</span><span class="o">.</span><span class="n">add_do_chan</span><span class="p">(</span><span class="n">ah</span><span class="p">[</span><span class="s1">&#39;master_trigger_out_line&#39;</span><span class="p">],</span>
                                                         <span class="n">line_grouping</span><span class="o">=</span><span class="n">LineGrouping</span><span class="o">.</span><span class="n">CHAN_FOR_ALL_LINES</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39;Calculate camera high time and initial delay:</span>

<span class="sd">        Disadvantage: high time and delay can only be set after a task has been created</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">camera_high_time</span> <span class="o">=</span> <span class="n">camera_pulse_percent</span><span class="o">*</span><span class="mf">0.01</span><span class="o">*</span><span class="n">sweeptime</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_delay</span> <span class="o">=</span> <span class="n">camera_delay_percent</span><span class="o">*</span><span class="mf">0.01</span><span class="o">*</span><span class="n">sweeptime</span>

        <span class="sd">&#39;&#39;&#39;Housekeeping: Setting up the counter task for the camera trigger&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_trigger_task</span><span class="o">.</span><span class="n">co_channels</span><span class="o">.</span><span class="n">add_co_pulse_chan_time</span><span class="p">(</span><span class="n">ah</span><span class="p">[</span><span class="s1">&#39;camera_trigger_out_line&#39;</span><span class="p">],</span>
                                                                    <span class="n">high_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">camera_high_time</span><span class="p">,</span>
                                                                    <span class="n">initial_delay</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">camera_delay</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">camera_trigger_task</span><span class="o">.</span><span class="n">triggers</span><span class="o">.</span><span class="n">start_trigger</span><span class="o">.</span><span class="n">cfg_dig_edge_start_trig</span><span class="p">(</span><span class="n">ah</span><span class="p">[</span><span class="s1">&#39;camera_trigger_source&#39;</span><span class="p">])</span>

        <span class="sd">&#39;&#39;&#39;Housekeeping: Setting up the AO task for the Galvo and setting the trigger input&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">galvo_etl_task</span><span class="o">.</span><span class="n">ao_channels</span><span class="o">.</span><span class="n">add_ao_voltage_chan</span><span class="p">(</span><span class="n">ah</span><span class="p">[</span><span class="s1">&#39;galvo_etl_task_line&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">galvo_etl_task</span><span class="o">.</span><span class="n">timing</span><span class="o">.</span><span class="n">cfg_samp_clk_timing</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">samplerate</span><span class="p">,</span>
                                                   <span class="n">sample_mode</span><span class="o">=</span><span class="n">AcquisitionType</span><span class="o">.</span><span class="n">FINITE</span><span class="p">,</span>
                                                   <span class="n">samps_per_chan</span><span class="o">=</span><span class="n">samples</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">galvo_etl_task</span><span class="o">.</span><span class="n">triggers</span><span class="o">.</span><span class="n">start_trigger</span><span class="o">.</span><span class="n">cfg_dig_edge_start_trig</span><span class="p">(</span><span class="n">ah</span><span class="p">[</span><span class="s1">&#39;galvo_etl_task_trigger_source&#39;</span><span class="p">])</span>

        <span class="sd">&#39;&#39;&#39;Housekeeping: Setting up the AO task for the ETL and lasers and setting the trigger input&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">laser_task</span><span class="o">.</span><span class="n">ao_channels</span><span class="o">.</span><span class="n">add_ao_voltage_chan</span><span class="p">(</span><span class="n">ah</span><span class="p">[</span><span class="s1">&#39;laser_task_line&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">laser_task</span><span class="o">.</span><span class="n">timing</span><span class="o">.</span><span class="n">cfg_samp_clk_timing</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="n">samplerate</span><span class="p">,</span>
                                                       <span class="n">sample_mode</span><span class="o">=</span><span class="n">AcquisitionType</span><span class="o">.</span><span class="n">FINITE</span><span class="p">,</span>
                                                       <span class="n">samps_per_chan</span><span class="o">=</span><span class="n">samples</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">laser_task</span><span class="o">.</span><span class="n">triggers</span><span class="o">.</span><span class="n">start_trigger</span><span class="o">.</span><span class="n">cfg_dig_edge_start_trig</span><span class="p">(</span><span class="n">ah</span><span class="p">[</span><span class="s1">&#39;laser_task_trigger_source&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.set_shutter_selection"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core.set_shutter_selection">[docs]</a>    <span class="nd">@pyqtSlot</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">set_shutter_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shutterstring</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">shutterconfig</span> <span class="o">=</span> <span class="n">shutterstring</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.open_shutters"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core.open_shutters">[docs]</a>    <span class="k">def</span> <span class="nf">open_shutters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Here, the possible values are hardcoded which is a DRY violation &#39;&#39;&#39;</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">shutterconfig</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">shutterconfig</span>

        <span class="k">if</span> <span class="n">shutterconfig</span> <span class="o">==</span> <span class="s1">&#39;Both&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutter_left</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutter_right</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">shutterconfig</span> <span class="o">==</span> <span class="s1">&#39;Left&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutter_left</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutter_right</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutter_right</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutter_left</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">shutterstate</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.close_shutters"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core.close_shutters">[docs]</a>    <span class="k">def</span> <span class="nf">close_shutters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutter_left</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutter_right</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">shutterstate</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.write_waveforms_to_tasks"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core.write_waveforms_to_tasks">[docs]</a>    <span class="k">def</span> <span class="nf">write_waveforms_to_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Write the waveforms to the slave tasks&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">galvo_etl_task</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">galvo_and_etl_waveforms</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">laser_task</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">laser_waveforms</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.start_tasks"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core.start_tasks">[docs]</a>    <span class="k">def</span> <span class="nf">start_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Starts the tasks for camera triggering and analog outputs</span>

<span class="sd">        If the tasks are configured to be triggered, they won&#39;t output any</span>
<span class="sd">        signals until run_tasks() is called.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_trigger_task</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">galvo_etl_task</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">laser_task</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.run_tasks"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core.run_tasks">[docs]</a>    <span class="k">def</span> <span class="nf">run_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Runs the tasks for triggering, analog and counter outputs</span>

<span class="sd">        Firstly, the master trigger triggers all other task via a shared trigger</span>
<span class="sd">        line (PFI line as given in the config file).</span>

<span class="sd">        For this to work, all analog output and counter tasks have to be started so</span>
<span class="sd">        that they are waiting for the trigger signal.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">master_trigger_task</span><span class="o">.</span><span class="n">write</span><span class="p">([</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span> <span class="n">auto_start</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39;Wait until everything is done - this is effectively a sleep function.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">galvo_etl_task</span><span class="o">.</span><span class="n">wait_until_done</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">laser_task</span><span class="o">.</span><span class="n">wait_until_done</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_trigger_task</span><span class="o">.</span><span class="n">wait_until_done</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.stop_tasks"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core.stop_tasks">[docs]</a>    <span class="k">def</span> <span class="nf">stop_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Stops the tasks for triggering, analog and counter outputs&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">galvo_etl_task</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">laser_task</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_trigger_task</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">master_trigger_task</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.close_tasks"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core.close_tasks">[docs]</a>    <span class="k">def</span> <span class="nf">close_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Closes the tasks for triggering, analog and counter outputs.</span>

<span class="sd">        Tasks should only be closed are they are stopped.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">galvo_etl_task</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">laser_task</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_trigger_task</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">master_trigger_task</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.update_stack_parameters"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core.update_stack_parameters">[docs]</a>    <span class="nd">@pyqtSlot</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">update_stack_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Updates the stack parameters: calculates z_planes after</span>
<span class="sd">        z_start, z_end, z_stepsize are known&#39;&#39;&#39;</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">z_start</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="s1">&#39;z_start&#39;</span><span class="p">]</span>
            <span class="n">z_end</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="s1">&#39;z_end&#39;</span><span class="p">]</span>
            <span class="n">z_stepsize</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="s1">&#39;z_stepsize&#39;</span><span class="p">]</span>

            <span class="n">z_planes</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="n">z_end</span> <span class="o">-</span> <span class="n">z_start</span><span class="p">)</span><span class="o">/</span><span class="n">z_stepsize</span><span class="p">))</span>

            <span class="n">s</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="s1">&#39;z_planes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_planes</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.snap"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core.snap">[docs]</a>    <span class="nd">@pyqtSlot</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">snap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">open_shutters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snap_image</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_shutters</span><span class="p">()</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.snap_image"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core.snap_image">[docs]</a>    <span class="k">def</span> <span class="nf">snap_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Snaps a single image after updating the waveforms.</span>

<span class="sd">        Can be used in acquisitions where changing waveforms are required,</span>
<span class="sd">        but there is additional overhead due to the need to write the</span>
<span class="sd">        waveforms into the buffers of the NI cards.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">create_tasks</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_waveforms_to_tasks</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_tasks</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_tasks</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_tasks</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_tasks</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.prepare_image_series"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core.prepare_image_series">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_image_series</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Prepares an image series without waveform update&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_tasks</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_waveforms_to_tasks</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.snap_image_in_series"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core.snap_image_in_series">[docs]</a>    <span class="k">def</span> <span class="nf">snap_image_in_series</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Snaps and image from a series without waveform update&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_tasks</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_tasks</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_tasks</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.close_image_series"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core.close_image_series">[docs]</a>    <span class="k">def</span> <span class="nf">close_image_series</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Cleans up after series without waveform update&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_tasks</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.live"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core.live">[docs]</a>    <span class="nd">@pyqtSlot</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">live</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;live&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># self.hcam.setACQMode(mode = &quot;run_till_abort&quot;)</span>
        <span class="c1"># self.hcam.startAcquisition()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open_shutters</span><span class="p">()</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="sd">&#39;&#39;&#39; Needs update to use snap image in series &#39;&#39;&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snap_image</span><span class="p">()</span>

            <span class="c1"># [frames, dims] = self.hcam.getFrames()</span>

            <span class="c1"># &#39;&#39;&#39; Instead of :</span>
            <span class="c1"># &quot;for aframe in frames:&quot;&quot;</span>
            <span class="c1"># I use &quot;aframe = frames[0]&quot;</span>
            <span class="c1"># to avoid time-varying delays, which lead to a &quot;stuttering of the microscope&quot;</span>
            <span class="c1"># &#39;&#39;&#39;</span>
            <span class="c1"># aframe = frames[0]</span>
            <span class="c1">#</span>
            <span class="c1"># image = aframe.getData()</span>
            <span class="c1"># image = np.reshape(image, (-1, 2048))</span>
            <span class="c1"># image = np.rot90(image)</span>
            <span class="c1">#</span>
            <span class="c1"># self.frame.emit(image)</span>
            <span class="c1">#</span>
            <span class="c1"># &#39;&#39;&#39; This only processes events for the thread it is called from.</span>
            <span class="c1"># Most importantly, it allows catching the stopflag.</span>
            <span class="c1"># &#39;&#39;&#39;</span>
            <span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>

            <span class="sd">&#39;&#39;&#39; How to handle a possible shutter switch?&#39;&#39;&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">open_shutters</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">close_shutters</span><span class="p">()</span>

        <span class="c1"># self.hcam.stopAcquisition()</span>

        <span class="n">gsig</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;idle&#39;</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.create_filename"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core.create_filename">[docs]</a>    <span class="k">def</span> <span class="nf">create_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39; Create zero-padded suffix &#39;&#39;&#39;</span>
            <span class="n">string</span> <span class="o">=</span> <span class="s1">&#39;000000&#39;</span>
            <span class="n">num_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">start_number</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">file_suffix</span> <span class="o">=</span> <span class="n">string</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">num_string</span><span class="p">)]</span><span class="o">+</span><span class="n">num_string</span>
            <span class="n">s</span><span class="o">.</span><span class="n">start_number</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">path</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">folder</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="n">file_prefix</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="n">file_suffix</span> <span class="o">+</span> <span class="s1">&#39;.raw&#39;</span>


        <span class="sd">&#39;&#39;&#39; Check that filename does not exist: &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: File would be overwritten, stack stopped; choose another filename!&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
            <span class="c1"># warning = QMessageBox.warning(None,&#39;Filename warning&#39;,</span>
            <span class="c1">#         &#39;Filename exists - overwrite&#39;,</span>
            <span class="c1">#         QMessageBox.Ok | QMessageBox.Cancel)</span>
            <span class="c1"># if warning == QMessageBox.Ok:</span>
            <span class="c1">#     with QMutexLocker(state_mutex):</span>
            <span class="c1">#         s.filepath = path</span>
            <span class="c1"># else:</span>
            <span class="c1">#     return False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
                <span class="n">s</span><span class="o">.</span><span class="n">filepath</span> <span class="o">=</span> <span class="n">path</span>
            <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.stack"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core.stack">[docs]</a>    <span class="nd">@pyqtSlot</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">stack</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Stack algorithm</span>

<span class="sd">        Get start and end points &amp; stepsize from the state</span>
<span class="sd">        Go to start position</span>
<span class="sd">        Update waveforms</span>
<span class="sd">        Lock waveform controls</span>
<span class="sd">        Open shutters</span>
<span class="sd">        for i in range(...):</span>

<span class="sd">            Snap image in series</span>
<span class="sd">            Move stage</span>
<span class="sd">            Signal progress</span>
<span class="sd">            How to escape the loop?</span>
<span class="sd">                Break when stopflag pops up</span>

<span class="sd">        Close shutters (no shutterswitch in this one)</span>
<span class="sd">        Go back to start position</span>
<span class="sd">        Enable waveform controls</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_filename</span><span class="p">()</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
                <span class="n">s</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;stack&#39;</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">filepath</span>
                <span class="n">z_start</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="s1">&#39;z_start&#39;</span><span class="p">]</span>
                <span class="n">z_end</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="s1">&#39;z_end&#39;</span><span class="p">]</span>
                <span class="n">z_stepsize</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="s1">&#39;z_stepsize&#39;</span><span class="p">]</span>
                <span class="n">z_planes</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="s1">&#39;z_planes&#39;</span><span class="p">]</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;File to save: &#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">write_metadata</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

            <span class="sd">&#39;&#39;&#39; Set sleeptimes depending on stepsize&#39;&#39;&#39;</span>
            <span class="k">if</span> <span class="n">z_stepsize</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="c1"># sleeptime = 0.005</span>
                <span class="n">sleeptime</span> <span class="o">=</span> <span class="mf">0.015</span>
            <span class="k">elif</span> <span class="n">z_stepsize</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">sleeptime</span> <span class="o">=</span> <span class="mf">0.015</span>
            <span class="k">elif</span> <span class="n">z_stepsize</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
                <span class="n">sleeptime</span> <span class="o">=</span> <span class="mf">0.02</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sleeptime</span> <span class="o">=</span> <span class="mf">0.05</span>

            <span class="sd">&#39;&#39;&#39; Invert direction if steps go in the other direction &#39;&#39;&#39;</span>
            <span class="k">if</span> <span class="n">z_end</span> <span class="o">&lt;</span> <span class="n">z_start</span><span class="p">:</span>
                <span class="n">z_stepsize</span> <span class="o">=</span> <span class="o">-</span><span class="n">z_stepsize</span>

            <span class="sd">&#39;&#39;&#39; Go to start position &#39;&#39;&#39;</span>
            <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
                <span class="n">current_z_pos</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="s1">&#39;z_pos&#39;</span><span class="p">]</span>

            <span class="sd">&#39;&#39;&#39; Prepare Movement dict &#39;&#39;&#39;</span>
            <span class="n">movement_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;z_abs&#39;</span> <span class="p">:</span> <span class="n">z_start</span><span class="p">}</span>

            <span class="sd">&#39;&#39;&#39;Move to stack start position&#39;&#39;&#39;</span>
            <span class="k">if</span> <span class="n">z_start</span> <span class="o">!=</span> <span class="n">current_z_pos</span><span class="p">:</span>
                <span class="n">gsig</span><span class="o">.</span><span class="n">move_absolute</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">movement_dict</span><span class="p">)</span>

                <span class="n">delta</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">z_start</span> <span class="o">-</span> <span class="n">current_z_pos</span><span class="p">)</span>
                <span class="k">while</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">delta</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">z_start</span> <span class="o">-</span> <span class="n">current_z_pos</span><span class="p">)</span>
                    <span class="sd">&#39;&#39;&#39;Wait for movement to finish by waiting a little and</span>
<span class="sd">                    checking the position again.</span>

<span class="sd">                    Hacky, but does the trick</span>
<span class="sd">                    &#39;&#39;&#39;</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
                    <span class="sd">&#39;&#39;&#39;The coordinate update lives in another method in the same</span>
<span class="sd">                    thread, so Events need to be processed&#39;&#39;&#39;</span>
                    <span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
                    <span class="n">gsig</span><span class="o">.</span><span class="n">status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Moving to start position&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
                    <span class="c1"># print(&#39;Moving to start position&#39;)</span>

                    <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
                        <span class="n">current_z_pos</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="s1">&#39;z_pos&#39;</span><span class="p">]</span>

            <span class="sd">&#39;&#39;&#39; Prepare relative movement dictionary &#39;&#39;&#39;</span>
            <span class="n">stack_rel_movement_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;y_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;z_rel&#39;</span><span class="p">:</span> <span class="n">z_stepsize</span><span class="p">,</span> <span class="s1">&#39;f_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;theta_rel&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ready&#39;</span><span class="p">)</span>
            <span class="c1"># cur_frame = 0</span>

            <span class="n">gsig</span><span class="o">.</span><span class="n">prepare_stack</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prepare_image_series</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">open_shutters</span><span class="p">()</span>

            <span class="n">start_pos_message</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">z_start</span>
            <span class="n">end_pos_message</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">z_end</span>

            <span class="n">gsig</span><span class="o">.</span><span class="n">status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Running stack from z=</span><span class="si">{start_pos_message}</span><span class="s1"> to z=</span><span class="si">{end_pos_message}</span><span class="s1"> with z_step=</span><span class="si">{z_stepsize}</span><span class="s1"> µm, </span><span class="si">{z_planes}</span><span class="s1"> slices in total&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

            <span class="sd">&#39;&#39;&#39; And here, the core of the work happens &#39;&#39;&#39;</span>
            <span class="n">starttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">z_planes</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">snap_image_in_series</span><span class="p">()</span>
                    <span class="n">gsig</span><span class="o">.</span><span class="n">add_images_to_stack</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
                    <span class="n">gsig</span><span class="o">.</span><span class="n">move_relative</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">stack_rel_movement_dict</span><span class="p">)</span>
                    <span class="n">gsig</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="n">z_planes</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
                    <span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleeptime</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="n">endtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">delta_t</span> <span class="o">=</span> <span class="n">endtime</span><span class="o">-</span><span class="n">starttime</span>
            <span class="n">framerate</span> <span class="o">=</span> <span class="n">z_planes</span><span class="o">/</span><span class="n">delta_t</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">close_shutters</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_image_series</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Framerate: &#39;</span><span class="p">,</span> <span class="n">framerate</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">gsig</span><span class="o">.</span><span class="n">move_absolute</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">movement_dict</span><span class="p">)</span>

            <span class="n">gsig</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">gsig</span><span class="o">.</span><span class="n">status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Stack finished&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
            <span class="c1"># print(&quot;Saved&quot;, cur_frame, &quot;frames&quot;)</span>

            <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
                <span class="n">s</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;idle&#39;</span>
            <span class="c1">#print(&#39;updated state&#39;)</span>

            <span class="n">gsig</span><span class="o">.</span><span class="n">end_stack</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gsig</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>


<div class="viewcode-block" id="mesoSPIM_Core.set_sweeptime"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core.set_sweeptime">[docs]</a>    <span class="k">def</span> <span class="nf">set_sweeptime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sweeptime</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Sets the sweeptime in seconds and updates all related waveforms</span>

<span class="sd">        Things to update:</span>
<span class="sd">        ETL and Galvo parameters are retained, but laser intensity etc.</span>
<span class="sd">        has to be updated</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">sweeptime</span> <span class="o">=</span> <span class="n">sweeptime</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_waveforms</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.visual_mode"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core.visual_mode">[docs]</a>    <span class="nd">@pyqtSlot</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">visual_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Provides a simple way to show brains visually with a stereomicroscope</span>

<span class="sd">        TODO: Sweeptime-induced laser shuttering is still there. Not having this would mean we need</span>
<span class="sd">        a continous output task for the Galvos, which would be a bit of work.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="sd">&#39;&#39;&#39;Store old ETL amplitude and offset in local variables &#39;&#39;&#39;</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">old_etl_l_amplitude</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">etl_l_amplitude</span>
            <span class="n">old_etl_l_offset</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">etl_l_offset</span>
            <span class="n">old_etl_r_amplitude</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">etl_r_amplitude</span>
            <span class="n">old_etl_r_offset</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">etl_r_offset</span>

        <span class="sd">&#39;&#39;&#39;Set ETL amplitude to 0 to avoid sweeping effect (makes the visual image oscillate)&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_etl_l_waveform</span><span class="p">(</span><span class="n">amplitude</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">old_etl_l_offset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_etl_r_waveform</span><span class="p">(</span><span class="n">amplitude</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">old_etl_r_offset</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39;Actually run the microscope in this special live mode&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepare_image_series</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open_shutters</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">snap_image_in_series</span><span class="p">()</span>
          <span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">open_shutters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_image_series</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_shutters</span><span class="p">()</span>

        <span class="sd">&#39;&#39;&#39;Reset ETL amplitude to old values&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_etl_l_waveform</span><span class="p">(</span><span class="n">amplitude</span><span class="o">=</span><span class="n">old_etl_l_amplitude</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">old_etl_l_offset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_etl_r_waveform</span><span class="p">(</span><span class="n">amplitude</span><span class="o">=</span><span class="n">old_etl_r_amplitude</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">old_etl_r_offset</span><span class="p">)</span>

        <span class="n">gsig</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.lightsheet_alignment_mode"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core.lightsheet_alignment_mode">[docs]</a>    <span class="nd">@pyqtSlot</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">lightsheet_alignment_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Switches shutters after each image to allow coalignment of both lightsheets&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="sd">&#39;&#39;&#39;Needs more careful adjustment of the timing</span>

<span class="sd">        TODO: There is no wait period to wait for the shutters to open. Nonetheless, the</span>
<span class="sd">        visual of the mode impression is not too bad.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutter_left</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snap_image</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutter_left</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutter_right</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snap_image</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutter_right</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">close_shutters</span><span class="p">()</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.update_etl"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core.update_etl">[docs]</a>    <span class="nd">@pyqtSlot</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">update_etl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Little helper method to update ETL parameters&#39;&#39;&#39;</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">etl_cfg_file</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">etl_cfg_file</span>
            <span class="n">laser</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">laser</span>
            <span class="n">zoom</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">zoom</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;etl_cfg_file: &#39;</span><span class="p">,</span> <span class="n">etl_cfg_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_etl_parameters_from_csv</span><span class="p">(</span><span class="n">etl_cfg_file</span><span class="p">,</span><span class="n">laser</span><span class="p">,</span><span class="n">zoom</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.set_intensity"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core.set_intensity">[docs]</a>    <span class="nd">@pyqtSlot</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">set_intensity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">intensity</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Updates Intensity of the activated laser &#39;&#39;&#39;</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">laser</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">laser</span>
            <span class="n">laser_delay_percent</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">laser_delay_percent</span>
            <span class="n">laser_pulse_percent</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">laser_pulse_percent</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_laser_intensity</span><span class="p">(</span><span class="n">laser</span><span class="p">,</span>
                                 <span class="n">intensity</span><span class="p">,</span>
                                 <span class="n">delay_percent</span><span class="o">=</span><span class="n">laser_delay_percent</span><span class="p">,</span>
                                 <span class="n">pulse_percent</span><span class="o">=</span><span class="n">laser_pulse_percent</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39;Update the state dictionary:&#39;&#39;&#39;</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">intensity</span> <span class="o">=</span> <span class="n">intensity</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.set_laser"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core.set_laser">[docs]</a>    <span class="nd">@pyqtSlot</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">set_laser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">laser</span><span class="p">,</span> <span class="n">intensity</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Enables laser line, sets laser intensity, updates laser and</span>
<span class="sd">        ETL waveforms with values from the parameter table</span>

<span class="sd">        laser: String</span>
<span class="sd">        intensity: Float between 0 and 100 %</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">etl_cfg_file</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">etl_cfg_file</span>
            <span class="n">zoom</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">zoom</span>
            <span class="n">laser_delay_percent</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">laser_delay_percent</span>
            <span class="n">laser_pulse_percent</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">laser_pulse_percent</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">laserenable</span><span class="o">.</span><span class="n">enable</span><span class="p">(</span><span class="n">laser</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_etl_parameters_from_csv</span><span class="p">(</span><span class="n">etl_cfg_file</span><span class="p">,</span><span class="n">laser</span><span class="p">,</span><span class="n">zoom</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_laser_intensity</span><span class="p">(</span><span class="n">laser</span><span class="p">,</span>
                                 <span class="n">intensity</span><span class="p">,</span>
                                 <span class="n">delay_percent</span><span class="o">=</span><span class="n">laser_delay_percent</span><span class="p">,</span>
                                 <span class="n">pulse_percent</span><span class="o">=</span><span class="n">laser_pulse_percent</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39;Update the state dictionary:&#39;&#39;&#39;</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">laser</span> <span class="o">=</span> <span class="n">laser</span>
            <span class="n">s</span><span class="o">.</span><span class="n">intensity</span> <span class="o">=</span> <span class="n">intensity</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.calculate_number_of_stack_planes"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core.calculate_number_of_stack_planes">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_number_of_stack_planes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_z</span><span class="p">,</span> <span class="n">end_z</span><span class="p">,</span> <span class="n">stepsize</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Returns the number of planes</span>

<span class="sd">        Uses int( ) to round down to the nearest integer.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">end_z</span> <span class="o">-</span> <span class="n">start_z</span><span class="p">)</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">stepsize</span><span class="p">))</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.run_stack"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core.run_stack">[docs]</a>    <span class="k">def</span> <span class="nf">run_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_z</span><span class="p">,</span> <span class="n">end_z</span><span class="p">,</span> <span class="n">stepsize</span><span class="p">,</span> <span class="n">return_to_start</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Runs a stack &#39;&#39;&#39;</span>
        <span class="k">pass</span></div>

    <span class="sd">&#39;&#39;&#39; Support for running scripts will go here &#39;&#39;&#39;</span>
<div class="viewcode-block" id="mesoSPIM_Core.execute_script"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core.execute_script">[docs]</a>    <span class="k">def</span> <span class="nf">execute_script</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Execute script</span>

<span class="sd">        The script QMutex is locked to avoid the script being changed while</span>
<span class="sd">        there is an execution happening.</span>

<span class="sd">        Using the traceback module to provide decent exception messages</span>
<span class="sd">        when script execution fails.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">script_mutex</span><span class="p">):</span>
            <span class="n">script</span> <span class="o">=</span> <span class="n">script_repository</span><span class="o">.</span><span class="n">script</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">exec</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.write_line"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core.write_line">[docs]</a>    <span class="k">def</span> <span class="nf">write_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Little helper method to write a single line with a key and value for metadata</span>

<span class="sd">        Adds a line break at the end.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;] &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.write_metadata"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core.write_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">write_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Writes a metadata.txt file</span>

<span class="sd">        Path contains the file to be written</span>
<span class="sd">        Filename</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata_path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_path</span> <span class="o">+</span> <span class="s1">&#39;_meta.txt&#39;</span>

        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_path</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;Metadata for file&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;z_stepsize&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="s1">&#39;z_stepsize&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;CFG&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;Laser&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">laser</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;Intensity (%)&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">intensity</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;Zoom&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">zoom</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;Pixelsize in um&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">pixelsize</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;Filter&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">filter</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;Shutter&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">shutterconfig</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;POSTION&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;x_pos&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="s1">&#39;x_pos&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;y_pos&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="s1">&#39;y_pos&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;f_pos&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="s1">&#39;f_pos&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;z_start&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="s1">&#39;z_start&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;z_end&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="s1">&#39;z_end&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;z_stepsize&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="s1">&#39;z_stepsize&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;z_planes&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="s1">&#39;z_planes&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="s1">&#39;ETL PARAMETERS&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;ETL CFG File&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">etl_cfg_file</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="s1">&#39;etl_l_offset&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">etl_l_offset</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="s1">&#39;etl_l_amplitude&#39;</span><span class="p">,</span><span class="n">s</span><span class="o">.</span><span class="n">etl_l_amplitude</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="s1">&#39;etl_r_offset&#39;</span><span class="p">,</span><span class="n">s</span><span class="o">.</span><span class="n">etl_r_offset</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="s1">&#39;etl_r_amplitude&#39;</span><span class="p">,</span><span class="n">s</span><span class="o">.</span><span class="n">etl_r_amplitude</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;GALVO PARAMETERS&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;galvo_l_frequency&#39;</span><span class="p">,</span><span class="n">s</span><span class="o">.</span><span class="n">galvo_l_frequency</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;galvo_l_amplitude&#39;</span><span class="p">,</span><span class="n">s</span><span class="o">.</span><span class="n">galvo_l_amplitude</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;galvo_l_offset&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">galvo_l_offset</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;galvo_r_amplitude&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">galvo_r_amplitude</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;galvo_r_offset&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">galvo_r_offset</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;CAMERA PARAMETERS&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;camera_exposure&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">camera_exposure</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;camera_line_interval&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">camera_line_interval</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.move_relative"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core.move_relative">[docs]</a>    <span class="k">def</span> <span class="nf">move_relative</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Helper method to allow running movements with or without waiting for completion &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">wait_until_done</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">gsig</span><span class="o">.</span><span class="n">move_relative</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gsig</span><span class="o">.</span><span class="n">move_relative_and_wait_until_done</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.move_absolute"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Core.move_absolute">[docs]</a>    <span class="k">def</span> <span class="nf">move_absolute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Helper method to allow running movements with or without waiting for completion &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">wait_until_done</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">gsig</span><span class="o">.</span><span class="n">move_absolute</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gsig</span><span class="o">.</span><span class="n">move_absolute_and_wait_until_done</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="mesoSPIM_Camera"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Camera">[docs]</a><span class="k">class</span> <span class="nc">mesoSPIM_Camera</span><span class="p">(</span><span class="n">QObject</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Class for the Hamamatsu Camera</span>

<span class="sd">    Will run in its own thread</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">frame</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; TODO: add a config parameter eventually &#39;&#39;&#39;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cam_p</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">camera_parameters</span>

        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">camera_exposure</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">camera_exposure</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">camera_line_interval</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">camera_line_interval</span>

        <span class="sd">&#39;&#39;&#39; Wiring up the global signals: Mode changes &#39;&#39;&#39;</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">live</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">live</span><span class="p">)</span>
        <span class="c1"># gsig.snap.connect(self.snap)</span>
        <span class="c1"># gsig.stack.connect(self.stack)</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">stop</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">visual_mode</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">live</span><span class="p">)</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">lightsheet_alignment_mode</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">live</span><span class="p">)</span>

        <span class="n">gsig</span><span class="o">.</span><span class="n">prepare_stack</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prepare_stack</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">add_images_to_stack</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add_images_to_stack</span><span class="p">)</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">end_stack</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_stack</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">gsig</span><span class="o">.</span><span class="n">update_camera_exposure</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_exposure_time</span><span class="p">)</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">update_camera_line_interval</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_line_interval</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hcam</span> <span class="o">=</span> <span class="n">cam</span><span class="o">.</span><span class="n">HamamatsuCameraMR</span><span class="p">(</span><span class="n">camera_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cam_p</span><span class="p">[</span><span class="s1">&#39;camera_id&#39;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;camera 0 model:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hcam</span><span class="o">.</span><span class="n">getModelInfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cam_p</span><span class="p">[</span><span class="s1">&#39;camera_id&#39;</span><span class="p">]))</span>

        <span class="sd">&#39;&#39;&#39; mesoSPIM mode parameters &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hcam</span><span class="o">.</span><span class="n">setPropertyValue</span><span class="p">(</span><span class="s2">&quot;sensor_mode&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cam_p</span><span class="p">[</span><span class="s1">&#39;sensor_mode&#39;</span><span class="p">])</span>

        <span class="sd">&#39;&#39;&#39; mesoSPIM mode parameters: OLD &#39;&#39;&#39;</span>
        <span class="c1"># self.hcam.setPropertyValue(&quot;sensor_mode&quot;, 12) # 12 for progressive</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hcam</span><span class="o">.</span><span class="n">setPropertyValue</span><span class="p">(</span><span class="s2">&quot;defect_correct_mode&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cam_p</span><span class="p">[</span><span class="s1">&#39;defect_correct_mode&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hcam</span><span class="o">.</span><span class="n">setPropertyValue</span><span class="p">(</span><span class="s2">&quot;exposure_time&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camera_exposure</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hcam</span><span class="o">.</span><span class="n">setPropertyValue</span><span class="p">(</span><span class="s2">&quot;binning&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cam_p</span><span class="p">[</span><span class="s1">&#39;binning&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hcam</span><span class="o">.</span><span class="n">setPropertyValue</span><span class="p">(</span><span class="s2">&quot;readout_speed&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cam_p</span><span class="p">[</span><span class="s1">&#39;readout_speed&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hcam</span><span class="o">.</span><span class="n">setPropertyValue</span><span class="p">(</span><span class="s2">&quot;trigger_active&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cam_p</span><span class="p">[</span><span class="s1">&#39;trigger_active&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hcam</span><span class="o">.</span><span class="n">setPropertyValue</span><span class="p">(</span><span class="s2">&quot;trigger_mode&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cam_p</span><span class="p">[</span><span class="s1">&#39;trigger_mode&#39;</span><span class="p">])</span> <span class="c1"># it is unclear if this is the external lightsheeet mode - how to check this?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hcam</span><span class="o">.</span><span class="n">setPropertyValue</span><span class="p">(</span><span class="s2">&quot;trigger_polarity&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cam_p</span><span class="p">[</span><span class="s1">&#39;trigger_polarity&#39;</span><span class="p">])</span> <span class="c1"># positive pulse</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hcam</span><span class="o">.</span><span class="n">setPropertyValue</span><span class="p">(</span><span class="s2">&quot;trigger_source&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cam_p</span><span class="p">[</span><span class="s1">&#39;trigger_source&#39;</span><span class="p">])</span> <span class="c1"># external</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hcam</span><span class="o">.</span><span class="n">setPropertyValue</span><span class="p">(</span><span class="s2">&quot;internal_line_interval&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">camera_line_interval</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hcam</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>

<div class="viewcode-block" id="mesoSPIM_Camera.set_exposure_time"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Camera.set_exposure_time">[docs]</a>    <span class="nd">@pyqtSlot</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">set_exposure_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">camera_exposure</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">camera_exposure</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hcam</span><span class="o">.</span><span class="n">setPropertyValue</span><span class="p">(</span><span class="s2">&quot;exposure_time&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camera_exposure</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_Camera.set_line_interval"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Camera.set_line_interval">[docs]</a>    <span class="nd">@pyqtSlot</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">set_line_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">camera_line_interval</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">camera_line_interval</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hcam</span><span class="o">.</span><span class="n">setPropertyValue</span><span class="p">(</span><span class="s2">&quot;internal_line_interval&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">camera_line_interval</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_Camera.stop"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Camera.stop">[docs]</a>    <span class="nd">@pyqtSlot</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="mesoSPIM_Camera.live"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Camera.live">[docs]</a>    <span class="nd">@pyqtSlot</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">live</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        camera running in live mode</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hcam</span><span class="o">.</span><span class="n">setACQMode</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;run_till_abort&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hcam</span><span class="o">.</span><span class="n">startAcquisition</span><span class="p">()</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="p">[</span><span class="n">frames</span><span class="p">,</span> <span class="n">dims</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hcam</span><span class="o">.</span><span class="n">getFrames</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">aframe</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">aframe</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2048</span><span class="p">))</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

                <span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hcam</span><span class="o">.</span><span class="n">stopAcquisition</span><span class="p">()</span>

        <span class="n">gsig</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_Camera.prepare_stack"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Camera.prepare_stack">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="sd">&#39;&#39;&#39; TODO: Needs cam delay, sweeptime, QTimer, line delay, exp_time &#39;&#39;&#39;</span>

        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">filepath</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">z_start</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="s1">&#39;z_start&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">z_end</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="s1">&#39;z_end&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">z_stepsize</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="s1">&#39;z_stepsize&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">z_planes</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="s1">&#39;z_planes&#39;</span><span class="p">]</span>

        <span class="c1">#print(&#39;File to save: &#39;, self.path)</span>
        <span class="c1">#print(&#39;Planes:&#39;, self.z_planes)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fsize</span> <span class="o">=</span> <span class="mi">2048</span><span class="o">*</span><span class="mi">2048</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">max_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_planes</span>

        <span class="c1"># tif_filename = os.path.dirname(self.path) + &#39;/&#39; + &#39;image&#39; + &#39;.tif&#39;</span>



        <span class="bp">self</span><span class="o">.</span><span class="n">xy_stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;write&quot;</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsize</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_frame</span><span class="p">)</span>
        <span class="c1"># self.xy_stack_tif = tf.memmap(tif_filename, shape=(self.max_frame, 2048, 2048), dtype = np.uint16)</span>
        <span class="c1"># self.xz_stack = np.memmap(self.path[:-4]+&#39;xz.raw&#39;, mode = &quot;write&quot;, dtype = np.uint16, shape = 2048 * self.max_frame * 2048)</span>
        <span class="c1"># self.yz_stack = np.memmap(self.path[:-4]+&#39;yz.raw&#39;, mode = &quot;write&quot;, dtype = np.uint16, shape = 2048 * self.max_frame * 2048)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hcam</span><span class="o">.</span><span class="n">startAcquisition</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur_frame</span> <span class="o">=</span> <span class="mi">0</span></div>
        <span class="c1"># print(&#39;Camera ready&#39;)</span>

<div class="viewcode-block" id="mesoSPIM_Camera.add_images_to_stack"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Camera.add_images_to_stack">[docs]</a>    <span class="k">def</span> <span class="nf">add_images_to_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="p">[</span><span class="n">frames</span><span class="p">,</span> <span class="n">dims</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hcam</span><span class="o">.</span><span class="n">getFrames</span><span class="p">()</span>
        <span class="c1"># tif_filename = &#39;&#39;</span>
        <span class="k">for</span> <span class="n">aframe</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cur_frame</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_frame</span><span class="p">):</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">aframe</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2048</span><span class="p">))</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

                <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">xy_stack</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cur_frame</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">fsize</span><span class="p">:(</span><span class="bp">self</span><span class="o">.</span><span class="n">cur_frame</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">fsize</span><span class="p">]</span> <span class="o">=</span> <span class="n">image</span>

                <span class="c1"># for j in range(2048):</span>
                <span class="c1">#     line =  image[j*2048:(j+1)*2048]</span>
                <span class="c1">#     self.xz_stack[2048*j*self.max_frame+2048*self.cur_frame:2048*j*self.max_frame+2048*self.cur_frame+2048] = line</span>
                <span class="c1">#</span>
                <span class="c1"># &#39;&#39;&#39; Temporary mod: turn data into a matrix and rotate it &#39;&#39;&#39;</span>
                <span class="c1"># data = np.reshape(image, (-1, 2048))</span>
                <span class="c1"># data = np.rot90(data)</span>
                <span class="c1"># data = data.flatten()</span>
                <span class="c1">#</span>
                <span class="c1"># &#39;&#39;&#39; Write YZ (coronal) image &#39;&#39;&#39;</span>
                <span class="c1"># for j in range(2048):</span>
                <span class="c1">#     line =  data[j*2048:(j+1)*2048]</span>
                <span class="c1">#     self.yz_stack[2048*j*self.max_frame+2048*self.cur_frame:2048*j*self.max_frame+2048*self.cur_frame+2048] = line</span>

                <span class="c1"># print(self.cur_frame)</span>
                <span class="c1"># Problem: Stops one frame too soon</span>
                <span class="c1"># self.xy_stack_tif[self.cur_frame,:,:] = image</span>

                <span class="c1"># print(self.cur_frame)</span>
                <span class="c1"># tif_filename = os.path.dirname(self.path) + &#39;/&#39; + &#39;image_&#39; + str(self.cur_frame) + &#39;.tif&#39;</span>
                <span class="c1"># tf.imsave(tif_filename, image)</span>

                <span class="c1"># image = image.flatten()</span>

                <span class="c1"># QApplication.processEvents()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">cur_frame</span> <span class="o">+=</span> <span class="mi">1</span></div>
            <span class="c1"># tif_filename = &#39;&#39;</span>

<div class="viewcode-block" id="mesoSPIM_Camera.end_stack"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Camera.end_stack">[docs]</a>    <span class="k">def</span> <span class="nf">end_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># self.xy_stack_tif.flush()</span>
        <span class="c1"># del self.xy_stack_tif</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy_stack</span>
        <span class="c1"># del self.xz_stack</span>
        <span class="c1"># del self.yz_stack</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saved&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_frame</span><span class="p">,</span> <span class="s2">&quot;frames&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hcam</span><span class="o">.</span><span class="n">stopAcquisition</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Acq finished&#39;</span><span class="p">)</span>

        <span class="n">gsig</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Finished signal emitted&#39;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="mesoSPIM_Stages"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Stages">[docs]</a><span class="k">class</span> <span class="nc">mesoSPIM_Stages</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Implements a facade providing a unified interface for the stages &amp; movement</span>
<span class="sd">    depending on whether a Galil &amp; L&amp;N or Physik Instrumente stage combination</span>
<span class="sd">    is installed.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;needs a config object&#39;&#39;&#39;</span>

<div class="viewcode-block" id="mesoSPIM_Stages.move_relative"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Stages.move_relative">[docs]</a>    <span class="k">def</span> <span class="nf">move_relative</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="mesoSPIM_Stages.move_absolute"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Stages.move_absolute">[docs]</a>    <span class="k">def</span> <span class="nf">move_absolute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="mesoSPIM_Stages.read_coordinates"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Stages.read_coordinates">[docs]</a>    <span class="k">def</span> <span class="nf">read_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div></div>

<div class="viewcode-block" id="mesoSPIM_Serial"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Serial">[docs]</a><span class="k">class</span> <span class="nc">mesoSPIM_Serial</span><span class="p">(</span><span class="n">QObject</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    The mesoSPIM Serial class takes care of all interactions via serial ports.</span>

<span class="sd">    These are:</span>
<span class="sd">        * Stages (translation and rotation)</span>
<span class="sd">        * Zoom Control</span>
<span class="sd">        * Filter wheels</span>

<span class="sd">    The reason for running this in its own thread is that stages require frequent</span>
<span class="sd">    polling of coordinates.</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># position = pyqtSignal(dict)</span>
    <span class="n">sig_move_rel_xy</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">sig_zero_xy</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="sd">&#39;&#39;&#39; TODO: Config needs to be revamped towards nested dicts &#39;&#39;&#39;</span>

        <span class="sd">&#39;&#39;&#39; Setting up the PI stages &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pi</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">pi_parameters</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">controllername</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi</span><span class="p">[</span><span class="s1">&#39;controllername&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi</span><span class="p">[</span><span class="s1">&#39;stages&#39;</span><span class="p">]</span>
        <span class="c1"># (&#39;M-112K033&#39;,&#39;L-406.40DG10&#39;,&#39;M-112K033&#39;,&#39;M-116.DG&#39;,&#39;M-406.4PD&#39;,&#39;NOSTAGE&#39;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refmode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi</span><span class="p">[</span><span class="s1">&#39;refmode&#39;</span><span class="p">]</span>
        <span class="c1"># self.serialnum = (&#39;118015439&#39;)  # Wyss Geneva</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serialnum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi</span><span class="p">[</span><span class="s1">&#39;serialnum&#39;</span><span class="p">]</span>  <span class="c1"># UZH Irchel H45</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">pidevice</span> <span class="o">=</span> <span class="n">GCSDevice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controllername</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pidevice</span><span class="o">.</span><span class="n">ConnectUSB</span><span class="p">(</span><span class="n">serialnum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">serialnum</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39; PI connection diagnostics &#39;&#39;&#39;</span>
        <span class="c1"># print(&#39;connected: {}&#39;.format(self.pidevice.qIDN().strip()))</span>
        <span class="c1">#</span>
        <span class="c1"># if self.pidevice.HasqVER():</span>
        <span class="c1">#     print(&#39;version info: {}&#39;.format(self.pidevice.qVER().strip()))</span>
        <span class="c1">#</span>
        <span class="c1"># print(&#39;initialize connected stages...&#39;)</span>

        <span class="sd">&#39;&#39;&#39; PI startup &#39;&#39;&#39;</span>

        <span class="sd">&#39;&#39;&#39; with refmode enabled: pretty dangerous</span>
<span class="sd">        pitools.startup(self.pidevice, stages=self.stages, refmode=self.refmode)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">pitools</span><span class="o">.</span><span class="n">startup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pidevice</span><span class="p">,</span> <span class="n">stages</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stages</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39; Stage 5 referencing hack &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pidevice</span><span class="o">.</span><span class="n">FRF</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;M-406 Emergency referencing hack: Waiting for referencing move&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_till_controller_is_ready</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;M-406 Emergency referencing hack done&#39;</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39; Stage 5 close to good focus&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">startfocus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi</span><span class="p">[</span><span class="s1">&#39;startfocus&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pidevice</span><span class="o">.</span><span class="n">MOV</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">startfocus</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39; Making sure that the stage values are read out continously via QTimers &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pi_timer</span> <span class="o">=</span> <span class="n">QTimer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pi_timer</span><span class="o">.</span><span class="n">timeout</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_position</span><span class="p">)</span>
        <span class="sd">&#39;&#39;&#39; Set timer interval &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pi_timer</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39;Initial setting of all positions&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta_pos</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="sd">&#39;&#39;&#39;Internal (software) positions&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">int_x_pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">int_y_pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">int_z_pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">int_f_pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">int_theta_pos</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="sd">&#39;&#39;&#39;Create offsets</span>

<span class="sd">        It should be:</span>

<span class="sd">        int_x_pos = x_pos + int_x_pos_offset</span>
<span class="sd">        self.int_x_pos = self.x_pos + self.int_x_pos_offset</span>

<span class="sd">        OR</span>

<span class="sd">        x_pos = int_x_pos - int_x_pos_offset</span>
<span class="sd">        self.x_pos = self.int_x_pos - self.int_x_pos_offset</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">int_x_pos_offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">int_y_pos_offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">int_z_pos_offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">int_f_pos_offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">int_theta_pos_offset</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Setting movement limits: currently hardcoded</span>

<span class="sd">        Open question: Should these be in mm or microns?</span>
<span class="sd">        Answer: Microns for now....</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi</span><span class="p">[</span><span class="s1">&#39;x_max&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi</span><span class="p">[</span><span class="s1">&#39;x_min&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi</span><span class="p">[</span><span class="s1">&#39;y_max&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi</span><span class="p">[</span><span class="s1">&#39;y_min&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi</span><span class="p">[</span><span class="s1">&#39;z_max&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi</span><span class="p">[</span><span class="s1">&#39;z_min&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi</span><span class="p">[</span><span class="s1">&#39;f_max&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi</span><span class="p">[</span><span class="s1">&#39;f_min&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi</span><span class="p">[</span><span class="s1">&#39;theta_max&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi</span><span class="p">[</span><span class="s1">&#39;theta_min&#39;</span><span class="p">]</span>

        <span class="sd">&#39;&#39;&#39;Getting the filter wheel ready&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filterwheel</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">filterwheel_parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filterdict</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">filterdict</span>

        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filterstate</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">filter</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startup_zoom</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">zoom</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wheel</span> <span class="o">=</span> <span class="n">ludl</span><span class="o">.</span><span class="n">LudlFilterwheel</span><span class="p">(</span><span class="n">COMport</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filterwheel</span><span class="p">[</span><span class="s1">&#39;COMport&#39;</span><span class="p">],</span>
                                                <span class="n">filterdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filterdict</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wheel</span><span class="o">.</span><span class="n">move_filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filterstate</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39;Getting the zoom ready&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zoom</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">zoom_parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zoomdict</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">zoomdict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zoom</span> <span class="o">=</span> <span class="n">zoom</span><span class="o">.</span><span class="n">Dynamixel_Zoom</span><span class="p">(</span><span class="n">identifier</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zoom</span><span class="p">[</span><span class="s1">&#39;servo_id&#39;</span><span class="p">],</span>
                                   <span class="n">COMport</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zoom</span><span class="p">[</span><span class="s1">&#39;COMport&#39;</span><span class="p">],</span>
                                   <span class="n">zoomdict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zoomdict</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">zoom</span><span class="o">.</span><span class="n">change_zoom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">startup_zoom</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39; TODO: Zoom set to the startup values &#39;&#39;&#39;</span>

        <span class="sd">&#39;&#39;&#39; Connecting the global signals &#39;&#39;&#39;</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">set_zoom</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_zoom</span><span class="p">)</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">set_filter</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_filter</span><span class="p">)</span>

        <span class="n">gsig</span><span class="o">.</span><span class="n">move_relative</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">move_relative</span><span class="p">)</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">move_relative_and_wait_until_done</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">move_relative_and_wait</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">move_absolute</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">move_absolute</span><span class="p">)</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">move_absolute_and_wait_until_done</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">move_absolute</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">gsig</span><span class="o">.</span><span class="n">zero_xyz</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zero_xyz</span><span class="p">)</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">zero_xy</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zero_xy</span><span class="p">)</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">zero_z</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zero_z</span><span class="p">)</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">zero_focus</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zero_focus</span><span class="p">)</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">zero_rot</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zero_rot</span><span class="p">)</span>

        <span class="n">gsig</span><span class="o">.</span><span class="n">load_sample</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_sample</span><span class="p">)</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">unload_sample</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unload_sample</span><span class="p">)</span>

        <span class="n">gsig</span><span class="o">.</span><span class="n">stop_movement</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop_movement</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Close the PI connection&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pidevice</span><span class="o">.</span><span class="n">unload</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Stage disconnected&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="mesoSPIM_Serial.create_position_dict"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Serial.create_position_dict">[docs]</a>    <span class="k">def</span> <span class="nf">create_position_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x_pos&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_pos</span><span class="p">,</span>
                              <span class="s1">&#39;y_pos&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_pos</span><span class="p">,</span>
                              <span class="s1">&#39;z_pos&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_pos</span><span class="p">,</span>
                              <span class="s1">&#39;f_pos&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_pos</span><span class="p">,</span>
                              <span class="s1">&#39;theta_pos&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_pos</span><span class="p">,</span>
                              <span class="p">}</span></div>

<div class="viewcode-block" id="mesoSPIM_Serial.create_internal_position_dict"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Serial.create_internal_position_dict">[docs]</a>    <span class="k">def</span> <span class="nf">create_internal_position_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">int_position_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x_pos&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_x_pos</span><span class="p">,</span>
                                  <span class="s1">&#39;y_pos&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_y_pos</span><span class="p">,</span>
                                  <span class="s1">&#39;z_pos&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_z_pos</span><span class="p">,</span>
                                  <span class="s1">&#39;f_pos&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_f_pos</span><span class="p">,</span>
                                  <span class="s1">&#39;theta_pos&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_theta_pos</span><span class="p">,</span>
                                  <span class="p">}</span></div>


<div class="viewcode-block" id="mesoSPIM_Serial.read_position"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Serial.read_position">[docs]</a>    <span class="nd">@pyqtSlot</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">read_position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pidevice</span><span class="o">.</span><span class="n">qPOS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pidevice</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">x_pos</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">1000</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_pos</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="s1">&#39;2&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">1000</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_pos</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="s1">&#39;3&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">1000</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_pos</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="s1">&#39;5&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">1000</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta_pos</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="s1">&#39;4&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">create_position_dict</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">int_x_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_pos</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_x_pos_offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">int_y_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_pos</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_y_pos_offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">int_z_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_pos</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_z_pos_offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">int_f_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_pos</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_f_pos_offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">int_theta_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_pos</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_theta_pos_offset</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">create_internal_position_dict</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">send_position</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_Serial.send_position"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Serial.send_position">[docs]</a>    <span class="k">def</span> <span class="nf">send_position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">update_position</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_position_dict</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_Serial.check_target_safety"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Serial.check_target_safety">[docs]</a>    <span class="k">def</span> <span class="nf">check_target_safety</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
        <span class="c1"># print(&#39;X: &#39;, self.x_min &lt; x and self.x_max &gt; x)</span>
        <span class="c1"># print(&#39;Y: &#39;, self.y_min &lt; y and self.y_max &gt; y)</span>
        <span class="c1"># print(&#39;Z: &#39;, self.z_min &lt; z and self.z_max &gt; z)</span>
        <span class="c1"># print(&#39;F: &#39;, self.f_min &lt; f and self.f_max &gt; f)</span>
        <span class="c1"># print(&#39;T: &#39;, self.theta_min &lt; theta and self.theta_max &gt; theta)</span>

        <span class="k">if</span> \
        <span class="bp">self</span><span class="o">.</span><span class="n">x_min</span> <span class="o">&lt;</span> <span class="n">x</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_max</span> <span class="o">&gt;</span> <span class="n">x</span> <span class="ow">and</span> \
        <span class="bp">self</span><span class="o">.</span><span class="n">y_min</span> <span class="o">&lt;</span> <span class="n">y</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_max</span> <span class="o">&gt;</span> <span class="n">y</span> <span class="ow">and</span> \
        <span class="bp">self</span><span class="o">.</span><span class="n">z_min</span> <span class="o">&lt;</span> <span class="n">z</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_max</span> <span class="o">&gt;</span> <span class="n">z</span> <span class="ow">and</span> \
        <span class="bp">self</span><span class="o">.</span><span class="n">f_min</span> <span class="o">&lt;</span> <span class="n">f</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_max</span> <span class="o">&gt;</span> <span class="n">f</span> <span class="ow">and</span> \
        <span class="bp">self</span><span class="o">.</span><span class="n">theta_min</span> <span class="o">&lt;</span> <span class="n">theta</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_max</span> <span class="o">&gt;</span> <span class="n">theta</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="mesoSPIM_Serial.move_relative"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Serial.move_relative">[docs]</a>    <span class="nd">@pyqtSlot</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">move_relative</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">move_relative_with_wait_option</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span>  <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_Serial.move_relative_and_wait"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Serial.move_relative_and_wait">[docs]</a>    <span class="nd">@pyqtSlot</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">move_relative_and_wait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">move_relative_with_wait_option</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span>  <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_Serial.move_relative_with_wait_option"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Serial.move_relative_with_wait_option">[docs]</a>    <span class="k">def</span> <span class="nf">move_relative_with_wait_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; PI move relative method</span>

<span class="sd">        Lots of implementation details in here, should be replaced by a facade</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_target_safety</span><span class="p">(</span><span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;x_rel&#39;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">x_pos</span><span class="p">,</span>
                                    <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;y_rel&#39;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">y_pos</span><span class="p">,</span>
                                    <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;z_rel&#39;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">z_pos</span><span class="p">,</span>
                                    <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;f_rel&#39;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">f_pos</span><span class="p">,</span>
                                    <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;theta_rel&#39;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_pos</span><span class="p">):</span>

            <span class="n">x_rel</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;x_rel&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span>
            <span class="n">y_rel</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;y_rel&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span>
            <span class="n">z_rel</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;z_rel&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span>
            <span class="n">f_rel</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;f_rel&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span>
            <span class="n">theta_rel</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;theta_rel&#39;</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">pidevice</span><span class="o">.</span><span class="n">MVR</span><span class="p">({</span><span class="mi">1</span> <span class="p">:</span> <span class="n">x_rel</span><span class="p">,</span> <span class="mi">2</span> <span class="p">:</span> <span class="n">y_rel</span><span class="p">,</span> <span class="mi">3</span> <span class="p">:</span> <span class="n">z_rel</span><span class="p">,</span> <span class="mi">4</span> <span class="p">:</span>  <span class="n">theta_rel</span><span class="p">,</span> <span class="mi">5</span> <span class="p">:</span> <span class="n">f_rel</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">wait_until_done</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">pitools</span><span class="o">.</span><span class="n">waitontarget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pidevice</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">gsig</span><span class="o">.</span><span class="n">status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Relative movement stopped: Motion limit reached!&#39;</span><span class="p">,</span><span class="mi">1000</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_Serial.move_absolute"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Serial.move_absolute">[docs]</a>    <span class="nd">@pyqtSlot</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">move_absolute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        PI move absolute method</span>

<span class="sd">        Lots of implementation details in here, should be replaced by a facade</span>

<span class="sd">        TODO: Also lots of repeating code.</span>
<span class="sd">        TODO: DRY principle violated</span>
<span class="sd">        TODO: Emission of a stop signal a good idea or not?</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="s1">&#39;x_abs&#39;</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="n">x_abs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;x_abs&#39;</span><span class="p">]</span>
            <span class="n">x_abs</span> <span class="o">=</span> <span class="n">x_abs</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_x_pos_offset</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_min</span> <span class="o">&lt;</span> <span class="n">x_abs</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_max</span> <span class="o">&gt;</span> <span class="n">x_abs</span><span class="p">:</span>
                <span class="sd">&#39;&#39;&#39; Conversion to mm and command emission&#39;&#39;&#39;</span>
                <span class="n">x_abs</span><span class="o">=</span> <span class="n">x_abs</span><span class="o">/</span><span class="mi">1000</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pidevice</span><span class="o">.</span><span class="n">MOV</span><span class="p">({</span><span class="mi">1</span> <span class="p">:</span> <span class="n">x_abs</span><span class="p">})</span>
                <span class="n">pitools</span><span class="o">.</span><span class="n">waitontarget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pidevice</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gsig</span><span class="o">.</span><span class="n">status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Absolute movement stopped: X Motion limit would be reached!&#39;</span><span class="p">,</span><span class="mi">1000</span><span class="p">)</span>
                <span class="c1"># gsig.stop.emit()</span>

        <span class="k">if</span> <span class="s1">&#39;y_abs&#39;</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="n">y_abs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;y_abs&#39;</span><span class="p">]</span>
            <span class="n">y_abs</span> <span class="o">=</span> <span class="n">y_abs</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_y_pos_offset</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_min</span> <span class="o">&lt;</span> <span class="n">y_abs</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_max</span> <span class="o">&gt;</span> <span class="n">y_abs</span><span class="p">:</span>
                <span class="sd">&#39;&#39;&#39; Conversion to mm and command emission&#39;&#39;&#39;</span>
                <span class="n">y_abs</span><span class="o">=</span> <span class="n">y_abs</span><span class="o">/</span><span class="mi">1000</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pidevice</span><span class="o">.</span><span class="n">MOV</span><span class="p">({</span><span class="mi">2</span> <span class="p">:</span> <span class="n">y_abs</span><span class="p">})</span>
                <span class="n">pitools</span><span class="o">.</span><span class="n">waitontarget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pidevice</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gsig</span><span class="o">.</span><span class="n">status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Absolute movement stopped: X Motion limit would be reached!&#39;</span><span class="p">,</span><span class="mi">1000</span><span class="p">)</span>
                <span class="c1"># gsig.stop.emit()</span>

        <span class="k">if</span> <span class="s1">&#39;z_abs&#39;</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="n">z_abs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;z_abs&#39;</span><span class="p">]</span>
            <span class="n">z_abs</span> <span class="o">=</span> <span class="n">z_abs</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_z_pos_offset</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_min</span> <span class="o">&lt;</span> <span class="n">z_abs</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_max</span> <span class="o">&gt;</span> <span class="n">z_abs</span><span class="p">:</span>
                <span class="sd">&#39;&#39;&#39; Conversion to mm and command emission&#39;&#39;&#39;</span>
                <span class="n">z_abs</span><span class="o">=</span> <span class="n">z_abs</span><span class="o">/</span><span class="mi">1000</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pidevice</span><span class="o">.</span><span class="n">MOV</span><span class="p">({</span><span class="mi">3</span> <span class="p">:</span> <span class="n">z_abs</span><span class="p">})</span>
                <span class="n">pitools</span><span class="o">.</span><span class="n">waitontarget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pidevice</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gsig</span><span class="o">.</span><span class="n">status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Absolute movement stopped: Z Motion limit would be reached!&#39;</span><span class="p">,</span><span class="mi">1000</span><span class="p">)</span>
                <span class="c1"># gsig.stop.emit()</span>

        <span class="k">if</span> <span class="s1">&#39;f_abs&#39;</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="n">f_abs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;f_abs&#39;</span><span class="p">]</span>
            <span class="n">f_abs</span> <span class="o">=</span> <span class="n">f_abs</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_f_pos_offset</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_min</span> <span class="o">&lt;</span> <span class="n">f_abs</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_max</span> <span class="o">&gt;</span> <span class="n">f_abs</span><span class="p">:</span>
                <span class="sd">&#39;&#39;&#39; Conversion to mm and command emission&#39;&#39;&#39;</span>
                <span class="n">f_abs</span><span class="o">=</span> <span class="n">f_abs</span><span class="o">/</span><span class="mi">1000</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pidevice</span><span class="o">.</span><span class="n">MOV</span><span class="p">({</span><span class="mi">5</span> <span class="p">:</span> <span class="n">f_abs</span><span class="p">})</span>
                <span class="n">pitools</span><span class="o">.</span><span class="n">waitontarget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pidevice</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gsig</span><span class="o">.</span><span class="n">status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Absolute movement stopped: F Motion limit would be reached!&#39;</span><span class="p">,</span><span class="mi">1000</span><span class="p">)</span>
                <span class="c1"># gsig.stop.emit()</span>

        <span class="k">if</span> <span class="s1">&#39;theta_abs&#39;</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="n">theta_abs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;theta_abs&#39;</span><span class="p">]</span>
            <span class="n">theta_abs</span> <span class="o">=</span> <span class="n">theta_abs</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_theta_pos_offset</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_min</span> <span class="o">&lt;</span> <span class="n">theta_abs</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_max</span> <span class="o">&gt;</span> <span class="n">theta_abs</span><span class="p">:</span>
                <span class="sd">&#39;&#39;&#39; No Conversion to mm !!!! and command emission&#39;&#39;&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pidevice</span><span class="o">.</span><span class="n">MOV</span><span class="p">({</span><span class="mi">4</span> <span class="p">:</span> <span class="n">theta_abs</span><span class="p">})</span>
                <span class="n">pitools</span><span class="o">.</span><span class="n">waitontarget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pidevice</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gsig</span><span class="o">.</span><span class="n">status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Absolute movement stopped: Theta Motion limit would be reached!&#39;</span><span class="p">,</span><span class="mi">1000</span><span class="p">)</span></div>
                <span class="c1"># gsig.stop.emit()</span>

<div class="viewcode-block" id="mesoSPIM_Serial.zero_xyz"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Serial.zero_xyz">[docs]</a>    <span class="k">def</span> <span class="nf">zero_xyz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zero_xy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zero_z</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">read_position</span><span class="p">()</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Zeroed XYZ Stages&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_Serial.zero_xy"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Serial.zero_xy">[docs]</a>    <span class="k">def</span> <span class="nf">zero_xy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">int_x_pos_offset</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">x_pos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">int_y_pos_offset</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">y_pos</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">read_position</span><span class="p">()</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Zeroed XY Stages&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_Serial.zero_z"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Serial.zero_z">[docs]</a>    <span class="k">def</span> <span class="nf">zero_z</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">int_z_pos_offset</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">z_pos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_position</span><span class="p">()</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Zeroed Z Stage&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_Serial.zero_rot"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Serial.zero_rot">[docs]</a>    <span class="k">def</span> <span class="nf">zero_rot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">int_theta_pos_offset</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_pos</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">read_position</span><span class="p">()</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Zeroed Rotation Stages&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_Serial.zero_focus"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Serial.zero_focus">[docs]</a>    <span class="k">def</span> <span class="nf">zero_focus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">int_f_pos_offset</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">f_pos</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">read_position</span><span class="p">()</span>
        <span class="n">gsig</span><span class="o">.</span><span class="n">status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Zeroed Focus Stages&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_Serial.load_sample"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Serial.load_sample">[docs]</a>    <span class="k">def</span> <span class="nf">load_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">y_load_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi</span><span class="p">[</span><span class="s1">&#39;y_load_position&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pidevice</span><span class="o">.</span><span class="n">MOV</span><span class="p">({</span><span class="mi">2</span> <span class="p">:</span> <span class="n">y_load_pos</span><span class="p">})</span></div>
        <span class="c1"># pitools.waitontarget(self.pidevice)</span>

<div class="viewcode-block" id="mesoSPIM_Serial.unload_sample"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Serial.unload_sample">[docs]</a>    <span class="k">def</span> <span class="nf">unload_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">y_unload_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi</span><span class="p">[</span><span class="s1">&#39;y_unload_position&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pidevice</span><span class="o">.</span><span class="n">MOV</span><span class="p">({</span><span class="mi">2</span> <span class="p">:</span> <span class="n">y_unload_pos</span><span class="p">})</span></div>
        <span class="c1"># pitools.waitontarget(self.pidevice)</span>

<div class="viewcode-block" id="mesoSPIM_Serial.stop_movement"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Serial.stop_movement">[docs]</a>    <span class="k">def</span> <span class="nf">stop_movement</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pidevice</span><span class="o">.</span><span class="n">STP</span><span class="p">(</span><span class="n">noraise</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_Serial.block_till_controller_is_ready"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Serial.block_till_controller_is_ready">[docs]</a>    <span class="k">def</span> <span class="nf">block_till_controller_is_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Blocks further execution (especially during referencing moves)</span>
<span class="sd">        till the PI controller returns ready</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">blockflag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">while</span> <span class="n">blockflag</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pidevice</span><span class="o">.</span><span class="n">IsControllerReady</span><span class="p">():</span>
                <span class="n">blockflag</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span></div>


<div class="viewcode-block" id="mesoSPIM_Serial.set_filter"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Serial.set_filter">[docs]</a>    <span class="nd">@pyqtSlot</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">set_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filterstring</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wheel</span><span class="o">.</span><span class="n">move_filter</span><span class="p">(</span><span class="n">filterstring</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">filter</span> <span class="o">=</span> <span class="n">filterstring</span>

        <span class="sd">&#39;&#39;&#39;This should also signal back to the GUI that sth was changed&#39;&#39;&#39;</span></div>

<div class="viewcode-block" id="mesoSPIM_Serial.set_zoom"><a class="viewcode-back" href="../../../../share/legacy/legacy.html#mesoSPIM.legacy.mesoSPIM.mesoSPIM_control.mesoSPIM_Serial.set_zoom">[docs]</a>    <span class="nd">@pyqtSlot</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">set_zoom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zoomstring</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;This should also signal back to the GUI that sth was changed&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zoom</span><span class="o">.</span><span class="n">change_zoom</span><span class="p">(</span><span class="n">zoomstring</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">QMutexLocker</span><span class="p">(</span><span class="n">state_mutex</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">zoom</span> <span class="o">=</span> <span class="n">zoomstring</span></div></div>

<span class="sd">&#39;&#39;&#39; Instantiate the global signals which are accessible from anywhere</span>

<span class="sd">This has to be called &quot;gsig&quot;, otherwise the signal to slot connections in</span>
<span class="sd">mesoSPIM_Core and other classes won&#39;t work.</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="n">gsig</span> <span class="o">=</span> <span class="n">mesoSPIM_Global_Signals</span><span class="p">()</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Import microscope configuration at startup</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="c1"># &#39;&#39;&#39; This needs an placeholder QApplication to work &#39;&#39;&#39;</span>
<span class="c1"># cfg_app = QApplication(sys.argv)</span>
<span class="c1">#</span>
<span class="c1"># global_config_path = &#39;&#39;</span>
<span class="c1"># global_config_path , _ = QFileDialog.getOpenFileName(None,&#39;Open microscope configuration file&#39;)</span>
<span class="c1">#</span>
<span class="c1"># if global_config_path != &#39;&#39;:</span>
<span class="c1">#     &#39;&#39;&#39; Using importlib to load the config file &#39;&#39;&#39;</span>
<span class="c1">#     spec = importlib.util.spec_from_file_location(&#39;module.name&#39;, global_config_path)</span>
<span class="c1">#     config = importlib.util.module_from_spec(spec)</span>
<span class="c1">#     spec.loader.exec_module(config)</span>
<span class="c1"># else:</span>
<span class="c1">#     &#39;&#39;&#39; Application shutdown &#39;&#39;&#39;</span>
<span class="c1">#     warning = QMessageBox.warning(None,&#39;Shutdown warning&#39;,</span>
<span class="c1">#             &#39;No configuration file selected - shutting down!&#39;,</span>
<span class="c1">#             QMessageBox.Ok)</span>
<span class="c1">#     sys.exit()</span>
<span class="c1">#</span>
<span class="c1"># &#39;&#39;&#39;</span>
<span class="c1"># Instantiate global state, simply &quot;s&quot;</span>
<span class="c1"># Instantiate the script repository to contain scripts</span>
<span class="c1"># &#39;&#39;&#39;</span>
<span class="c1"># s = mesoSPIM_State(config)</span>
<span class="c1">#</span>
<span class="c1"># script_repository = Script_Repository()</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># def main():</span>
<span class="c1">#</span>
<span class="c1">#     app = QApplication(sys.argv)</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#     ex = mesoSPIM_GUI()</span>
<span class="c1">#</span>
<span class="c1">#     ex.show()</span>
<span class="c1">#     sys.exit(cfg_app.exec_())</span>
<span class="c1">#     sys.exit(app.exec_())</span>
<span class="c1">#</span>
<span class="c1"># if __name__ == &#39;__main__&#39;:</span>
<span class="c1">#     main()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Fabian F. Voigt.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>