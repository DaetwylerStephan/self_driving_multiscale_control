
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>mesoSPIM.src.mesoSPIM_Core &#8212; mesoSPIM Control 0.0.1 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for mesoSPIM.src.mesoSPIM_Core</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Core for the mesoSPIM project</span>
<span class="sd">=============================</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">signal</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">traceback</span>

<span class="sd">&#39;&#39;&#39;PyQt5 Imports&#39;&#39;&#39;</span>
<span class="kn">from</span> <span class="nn">PyQt5</span> <span class="k">import</span> <span class="n">QtWidgets</span><span class="p">,</span> <span class="n">QtCore</span><span class="p">,</span> <span class="n">QtGui</span>

<span class="sd">&#39;&#39;&#39;National Instruments Imports&#39;&#39;&#39;</span>
<span class="c1"># import nidaqmx</span>
<span class="c1"># from nidaqmx.constants import AcquisitionType, TaskMode</span>
<span class="c1"># from nidaqmx.constants import LineGrouping, DigitalWidthUnits</span>
<span class="c1"># from nidaqmx.types import CtrTime</span>

<span class="sd">&#39;&#39;&#39; Import mesoSPIM modules &#39;&#39;&#39;</span>
<span class="kn">from</span> <span class="nn">.mesoSPIM_State</span> <span class="k">import</span> <span class="n">mesoSPIM_StateSingleton</span>
<span class="kn">from</span> <span class="nn">.devices.shutters.NI_Shutter</span> <span class="k">import</span> <span class="n">NI_Shutter</span>
<span class="kn">from</span> <span class="nn">.mesoSPIM_Camera</span> <span class="k">import</span> <span class="n">mesoSPIM_HamamatsuCamera</span>
<span class="kn">from</span> <span class="nn">.devices.lasers.mesoSPIM_LaserEnabler</span> <span class="k">import</span> <span class="n">mesoSPIM_LaserEnabler</span>
<span class="kn">from</span> <span class="nn">.mesoSPIM_Serial</span> <span class="k">import</span> <span class="n">mesoSPIM_Serial</span>
<span class="kn">from</span> <span class="nn">.mesoSPIM_WaveFormGenerator</span> <span class="k">import</span> <span class="n">mesoSPIM_WaveFormGenerator</span>

<span class="kn">from</span> <span class="nn">.utils.acquisitions</span> <span class="k">import</span> <span class="n">AcquisitionList</span><span class="p">,</span> <span class="n">Acquisition</span>

<div class="viewcode-block" id="mesoSPIM_Core"><a class="viewcode-back" href="../../../share/mesoSPIM_Core.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core">[docs]</a><span class="k">class</span> <span class="nc">mesoSPIM_Core</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QObject</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;This class is the pacemaker of a mesoSPIM</span>

<span class="sd">    Signals it can send:</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">sig_finished</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">()</span>

    <span class="n">sig_update_gui_from_state</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>

    <span class="n">sig_state_request</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">sig_state_request_and_wait_until_done</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">sig_position</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>

    <span class="n">sig_status_message</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">sig_warning</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    
    <span class="n">sig_progress</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>

    <span class="sd">&#39;&#39;&#39; Camera-related signals &#39;&#39;&#39;</span>
    <span class="n">sig_prepare_image_series</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">(</span><span class="n">Acquisition</span><span class="p">)</span>
    <span class="n">sig_add_images_to_image_series</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">sig_add_images_to_image_series_and_wait_until_done</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">sig_end_image_series</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">()</span>

    <span class="n">sig_prepare_live</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">sig_get_live_image</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">sig_end_live</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">()</span>

    <span class="sd">&#39;&#39;&#39; Movement-related signals: &#39;&#39;&#39;</span>
    <span class="n">sig_move_relative</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">sig_move_relative_and_wait_until_done</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">sig_move_absolute</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">sig_move_absolute_and_wait_until_done</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">sig_zero_axes</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">sig_unzero_axes</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">sig_stop_movement</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">sig_load_sample</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">sig_unload_sample</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">()</span>

    <span class="sd">&#39;&#39;&#39; ETL-related signals &#39;&#39;&#39;</span>
    <span class="n">sig_save_etl_config</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="sd">&#39;&#39;&#39; Assign the parent class to a instance variable for callbacks &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cfg</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">mesoSPIM_StateSingleton</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;init&#39;</span>

        <span class="sd">&#39;&#39;&#39; The signal-slot switchboard &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_request_handler</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sig_execute_script</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">execute_script</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sig_move_relative</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="nb">dict</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_relative</span><span class="p">(</span><span class="nb">dict</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sig_move_relative_and_wait_until_done</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="nb">dict</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_relative</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sig_move_absolute</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="nb">dict</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_absolute</span><span class="p">(</span><span class="nb">dict</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sig_move_absolute_and_wait_until_done</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="nb">dict</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_absolute</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sig_zero_axes</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="nb">list</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zero_axes</span><span class="p">(</span><span class="nb">list</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sig_unzero_axes</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="nb">list</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">unzero_axes</span><span class="p">(</span><span class="nb">list</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sig_stop_movement</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop_movement</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sig_load_sample</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sig_load_sample</span><span class="o">.</span><span class="n">emit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sig_unload_sample</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sig_unload_sample</span><span class="o">.</span><span class="n">emit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sig_save_etl_config</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sig_save_etl_config</span><span class="o">.</span><span class="n">emit</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39; Set the Camera thread up &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_thread</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QThread</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_worker</span> <span class="o">=</span> <span class="n">mesoSPIM_HamamatsuCamera</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_worker</span><span class="o">.</span><span class="n">moveToThread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camera_thread</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39; Set the serial thread up &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serial_thread</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QThread</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serial_worker</span> <span class="o">=</span> <span class="n">mesoSPIM_Serial</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serial_worker</span><span class="o">.</span><span class="n">moveToThread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serial_thread</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serial_worker</span><span class="o">.</span><span class="n">sig_position</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="nb">dict</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sig_position</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="nb">dict</span><span class="p">))</span>

        <span class="sd">&#39;&#39;&#39; Start the threads &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serial_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Camera thread priority:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">camera_thread</span><span class="o">.</span><span class="n">priority</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Serial thread priority:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_thread</span><span class="o">.</span><span class="n">priority</span><span class="p">())</span>

        <span class="sd">&#39;&#39;&#39; Setting waveform generation up &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waveformer</span> <span class="o">=</span> <span class="n">mesoSPIM_WaveFormGenerator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waveformer</span><span class="o">.</span><span class="n">sig_update_gui_from_state</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">flag</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sig_update_gui_from_state</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">flag</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">waveformer</span><span class="o">.</span><span class="n">state_request_handler</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request_and_wait_until_done</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">waveformer</span><span class="o">.</span><span class="n">state_request_handler</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39; Setting the shutters up &#39;&#39;&#39;</span>
        <span class="n">left_shutter_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">shutterdict</span><span class="p">[</span><span class="s1">&#39;shutter_left&#39;</span><span class="p">]</span>
        <span class="n">right_shutter_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">shutterdict</span><span class="p">[</span><span class="s1">&#39;shutter_right&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">shutter_left</span> <span class="o">=</span> <span class="n">NI_Shutter</span><span class="p">(</span><span class="n">left_shutter_line</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutter_right</span> <span class="o">=</span> <span class="n">NI_Shutter</span><span class="p">(</span><span class="n">right_shutter_line</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">shutter_left</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutter_right</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;shutterstate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="sd">&#39;&#39;&#39; Setting the laserenabler up &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">laserenabler</span> <span class="o">=</span> <span class="n">mesoSPIM_LaserEnabler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">laserdict</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;idle&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_list_rotation_position</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Cleans the threads up after deletion, waits until the threads</span>
<span class="sd">        have truly finished their life.</span>

<span class="sd">        Make sure to keep this up to date with the number of threads</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">camera_thread</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">serial_thread</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">camera_thread</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">serial_thread</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>


<div class="viewcode-block" id="mesoSPIM_Core.state_request_handler"><a class="viewcode-back" href="../../../share/mesoSPIM_Core.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.state_request_handler">[docs]</a>    <span class="nd">@QtCore</span><span class="o">.</span><span class="n">pyqtSlot</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">state_request_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span><span class="nb">dict</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Core Thread: State request: Key: &#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="s1">&#39; Value: &#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            The request handling is done with exec() to write fewer lines of</span>
<span class="sd">            code.</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;filter&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;zoom&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;laser&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;intensity&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;shutterconfig&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;state&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;camera_exposure_time&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;camera_line_interval&#39;</span><span class="p">):</span>
                <span class="n">exec</span><span class="p">(</span><span class="s1">&#39;self.set_&#39;</span><span class="o">+</span><span class="n">key</span><span class="o">+</span><span class="s1">&#39;(value)&#39;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;samplerate&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;sweeptime&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;ETL_cfg_file&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;etl_l_delay_%&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;etl_l_ramp_rising_%&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;etl_l_ramp_falling_%&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;etl_l_amplitude&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;etl_l_offset&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;etl_r_delay_%&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;etl_r_ramp_rising_%&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;etl_r_ramp_falling_%&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;etl_r_amplitude&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;etl_r_offset&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;galvo_l_frequency&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;galvo_l_amplitude&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;galvo_l_offset&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;galvo_l_duty_cycle&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;galvo_l_phase&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;galvo_r_frequency&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;galvo_r_amplitude&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;galvo_r_offset&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;galvo_r_duty_cycle&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;galvo_r_phase&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;laser_l_delay_%&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;laser_l_pulse_%&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;laser_l_max_amplitude&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;laser_r_delay_%&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;laser_r_pulse_%&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;laser_r_max_amplitude&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;camera_delay_%&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;camera_pulse_%&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="n">key</span> <span class="p">:</span> <span class="n">value</span><span class="p">})</span></div>
            
<div class="viewcode-block" id="mesoSPIM_Core.set_state"><a class="viewcode-back" href="../../../share/mesoSPIM_Core.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.set_state">[docs]</a>    <span class="k">def</span> <span class="nf">set_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;live&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;live&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;state&#39;</span><span class="p">:</span><span class="s1">&#39;live&#39;</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">live</span><span class="p">()</span>
        
        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;run_selected_acquisition&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span><span class="o">=</span> <span class="s1">&#39;run_selected_acquisition&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;state&#39;</span><span class="p">:</span><span class="s1">&#39;run_selected_acquisition&#39;</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;selected_row&#39;</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;run_acquisition_list&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;run_acquisition_list&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;state&#39;</span><span class="p">:</span><span class="s1">&#39;run_acquisition_list&#39;</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">row</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;preview_acquisition&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;preview_acquisition&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preview_acquisition</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;idle&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Core: Stopping requested&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;state&#39;</span><span class="p">:</span><span class="s1">&#39;idle&#39;</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;lightsheet_alignment_mode&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;lightsheet_alignment_mode&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;state&#39;</span><span class="p">:</span><span class="s1">&#39;live&#39;</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lightsheet_alignment_mode</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;visual_mode&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;visual_mode&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;state&#39;</span><span class="p">:</span><span class="s1">&#39;live&#39;</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visual_mode</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.stop"><a class="viewcode-back" href="../../../share/mesoSPIM_Core.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="sd">&#39;&#39;&#39; This stopflag is a bit risky, needs to be updated&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;idle&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_update_gui_from_state</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.send_progress"><a class="viewcode-back" href="../../../share/mesoSPIM_Core.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.send_progress">[docs]</a>    <span class="k">def</span> <span class="nf">send_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                      <span class="n">cur_acq</span><span class="p">,</span>
                      <span class="n">tot_acqs</span><span class="p">,</span>
                      <span class="n">cur_image</span><span class="p">,</span>
                      <span class="n">images_in_acq</span><span class="p">,</span>
                      <span class="n">total_image_count</span><span class="p">,</span>
                      <span class="n">image_counter</span><span class="p">):</span>

        <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;current_acq&#39;</span><span class="p">:</span><span class="n">cur_acq</span><span class="p">,</span>
                <span class="s1">&#39;total_acqs&#39;</span> <span class="p">:</span><span class="n">tot_acqs</span><span class="p">,</span>
                <span class="s1">&#39;current_image_in_acq&#39;</span><span class="p">:</span><span class="n">cur_image</span><span class="p">,</span>
                <span class="s1">&#39;images_in_acq&#39;</span><span class="p">:</span> <span class="n">images_in_acq</span><span class="p">,</span>
                <span class="s1">&#39;total_image_count&#39;</span><span class="p">:</span><span class="n">total_image_count</span><span class="p">,</span>
                <span class="s1">&#39;image_counter&#39;</span><span class="p">:</span><span class="n">image_counter</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_progress</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.set_filter"><a class="viewcode-back" href="../../../share/mesoSPIM_Core.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.set_filter">[docs]</a>    <span class="k">def</span> <span class="nf">set_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">filter</span><span class="p">,</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">wait_until_done</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request_and_wait_until_done</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;filter&#39;</span> <span class="p">:</span> <span class="nb">filter</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;filter&#39;</span> <span class="p">:</span> <span class="nb">filter</span><span class="p">})</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.set_zoom"><a class="viewcode-back" href="../../../share/mesoSPIM_Core.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.set_zoom">[docs]</a>    <span class="k">def</span> <span class="nf">set_zoom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zoom</span><span class="p">,</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">wait_until_done</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request_and_wait_until_done</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;zoom&#39;</span> <span class="p">:</span> <span class="n">zoom</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;zoom&#39;</span> <span class="p">:</span> <span class="n">zoom</span><span class="p">})</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.set_laser"><a class="viewcode-back" href="../../../share/mesoSPIM_Core.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.set_laser">[docs]</a>    <span class="k">def</span> <span class="nf">set_laser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">laser</span><span class="p">,</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">laserenabler</span><span class="o">.</span><span class="n">enable</span><span class="p">(</span><span class="n">laser</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">wait_until_done</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request_and_wait_until_done</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;laser&#39;</span> <span class="p">:</span> <span class="n">laser</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;laser&#39;</span><span class="p">:</span><span class="n">laser</span><span class="p">})</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.set_intensity"><a class="viewcode-back" href="../../../share/mesoSPIM_Core.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.set_intensity">[docs]</a>    <span class="k">def</span> <span class="nf">set_intensity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">intensity</span><span class="p">,</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">wait_until_done</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request_and_wait_until_done</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;intensity&#39;</span><span class="p">:</span> <span class="n">intensity</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;intensity&#39;</span><span class="p">:</span><span class="n">intensity</span><span class="p">})</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.set_camera_exposure_time"><a class="viewcode-back" href="../../../share/mesoSPIM_Core.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.set_camera_exposure_time">[docs]</a>    <span class="k">def</span> <span class="nf">set_camera_exposure_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;camera_exposure_time&#39;</span> <span class="p">:</span> <span class="n">time</span><span class="p">})</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.set_camera_line_interval"><a class="viewcode-back" href="../../../share/mesoSPIM_Core.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.set_camera_line_interval">[docs]</a>    <span class="k">def</span> <span class="nf">set_camera_line_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;camera_line_interval&#39;</span> <span class="p">:</span> <span class="n">time</span><span class="p">})</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.move_relative"><a class="viewcode-back" href="../../../share/mesoSPIM_Core.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.move_relative">[docs]</a>    <span class="k">def</span> <span class="nf">move_relative</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">wait_until_done</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_move_relative_and_wait_until_done</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_move_relative</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.move_absolute"><a class="viewcode-back" href="../../../share/mesoSPIM_Core.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.move_absolute">[docs]</a>    <span class="k">def</span> <span class="nf">move_absolute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">wait_until_done</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_move_absolute_and_wait_until_done</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_move_absolute</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.zero_axes"><a class="viewcode-back" href="../../../share/mesoSPIM_Core.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.zero_axes">[docs]</a>    <span class="k">def</span> <span class="nf">zero_axes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_zero_axes</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.unzero_axes"><a class="viewcode-back" href="../../../share/mesoSPIM_Core.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.unzero_axes">[docs]</a>    <span class="k">def</span> <span class="nf">unzero_axes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_unzero_axes</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.stop_movement"><a class="viewcode-back" href="../../../share/mesoSPIM_Core.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.stop_movement">[docs]</a>    <span class="k">def</span> <span class="nf">stop_movement</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_stop_movement</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.set_shutterconfig"><a class="viewcode-back" href="../../../share/mesoSPIM_Core.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.set_shutterconfig">[docs]</a>    <span class="k">def</span> <span class="nf">set_shutterconfig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shutterconfig</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;shutterconfig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shutterconfig</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.open_shutters"><a class="viewcode-back" href="../../../share/mesoSPIM_Core.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.open_shutters">[docs]</a>    <span class="k">def</span> <span class="nf">open_shutters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">shutterconfig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;shutterconfig&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">shutterconfig</span> <span class="o">==</span> <span class="s1">&#39;Both&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutter_left</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutter_right</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">shutterconfig</span> <span class="o">==</span> <span class="s1">&#39;Left&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutter_left</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutter_right</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">shutterconfig</span> <span class="o">==</span> <span class="s1">&#39;Right&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutter_right</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutter_left</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutter_right</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutter_left</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;shutterstate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></div>
   
<div class="viewcode-block" id="mesoSPIM_Core.close_shutters"><a class="viewcode-back" href="../../../share/mesoSPIM_Core.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.close_shutters">[docs]</a>    <span class="k">def</span> <span class="nf">close_shutters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutter_left</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutter_right</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;shutterstate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span></div>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Sub-Imaging modes</span>
<span class="sd">    &#39;&#39;&#39;</span>
<div class="viewcode-block" id="mesoSPIM_Core.snap"><a class="viewcode-back" href="../../../share/mesoSPIM_Core.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.snap">[docs]</a>    <span class="k">def</span> <span class="nf">snap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open_shutters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snap_image</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_shutters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.snap_image"><a class="viewcode-back" href="../../../share/mesoSPIM_Core.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.snap_image">[docs]</a>    <span class="k">def</span> <span class="nf">snap_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Snaps a single image after updating the waveforms.</span>

<span class="sd">        Can be used in acquisitions where changing waveforms are required,</span>
<span class="sd">        but there is additional overhead due to the need to write the</span>
<span class="sd">        waveforms into the buffers of the NI cards.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">waveformer</span><span class="o">.</span><span class="n">create_tasks</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waveformer</span><span class="o">.</span><span class="n">write_waveforms_to_tasks</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waveformer</span><span class="o">.</span><span class="n">start_tasks</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waveformer</span><span class="o">.</span><span class="n">run_tasks</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waveformer</span><span class="o">.</span><span class="n">stop_tasks</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waveformer</span><span class="o">.</span><span class="n">close_tasks</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.prepare_image_series"><a class="viewcode-back" href="../../../share/mesoSPIM_Core.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.prepare_image_series">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_image_series</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Prepares an image series without waveform update&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waveformer</span><span class="o">.</span><span class="n">create_tasks</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waveformer</span><span class="o">.</span><span class="n">write_waveforms_to_tasks</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.snap_image_in_series"><a class="viewcode-back" href="../../../share/mesoSPIM_Core.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.snap_image_in_series">[docs]</a>    <span class="k">def</span> <span class="nf">snap_image_in_series</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Snaps and image from a series without waveform update&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waveformer</span><span class="o">.</span><span class="n">start_tasks</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waveformer</span><span class="o">.</span><span class="n">run_tasks</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waveformer</span><span class="o">.</span><span class="n">stop_tasks</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.close_image_series"><a class="viewcode-back" href="../../../share/mesoSPIM_Core.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.close_image_series">[docs]</a>    <span class="k">def</span> <span class="nf">close_image_series</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Cleans up after series without waveform update&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waveformer</span><span class="o">.</span><span class="n">close_tasks</span><span class="p">()</span></div>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Execution code for major imaging modes starts here</span>
<span class="sd">    &#39;&#39;&#39;</span>
        
<div class="viewcode-block" id="mesoSPIM_Core.live"><a class="viewcode-back" href="../../../share/mesoSPIM_Core.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.live">[docs]</a>    <span class="k">def</span> <span class="nf">live</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_prepare_live</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">open_shutters</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="sd">&#39;&#39;&#39; Needs update to use snap image in series &#39;&#39;&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snap_image</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_get_live_image</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

            <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>

            <span class="sd">&#39;&#39;&#39; How to handle a possible shutter switch?&#39;&#39;&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">open_shutters</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">close_shutters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_end_live</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.start"><a class="viewcode-back" href="../../../share/mesoSPIM_Core.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">row</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
            <span class="n">acq_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;acq_list&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">acq_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;acq_list&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">acq_list</span><span class="o">.</span><span class="n">has_rotation</span><span class="p">()</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sig_warning</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Acquisition list contains rotation - stopping.&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sig_finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">acquisition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;acq_list&#39;</span><span class="p">][</span><span class="n">row</span><span class="p">]</span>
                <span class="n">rotation_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;acq_list&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_rotation_point</span><span class="p">()</span>
                <span class="n">acq_list</span> <span class="o">=</span> <span class="n">AcquisitionList</span><span class="p">([</span><span class="n">acquisition</span><span class="p">])</span>
                <span class="n">acq_list</span><span class="o">.</span><span class="n">set_rotation_point</span><span class="p">(</span><span class="n">rotation_position</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">acq_list</span><span class="o">.</span><span class="n">has_rotation</span><span class="p">()</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_warning</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Acquisition list contains rotation - stopping&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">acq_list</span><span class="o">.</span><span class="n">check_for_existing_filenames</span><span class="p">()</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_warning</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;One or more files in the acquisition list already exist - stopping.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">acq_list</span><span class="o">.</span><span class="n">check_for_duplicated_filenames</span><span class="p">()</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_warning</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;One or more filenames in the acquisition list is duplicated - stopping.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_update_gui_from_state</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prepare_acquisition_list</span><span class="p">(</span><span class="n">acq_list</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_acquisition_list</span><span class="p">(</span><span class="n">acq_list</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_acquisition_list</span><span class="p">(</span><span class="n">acq_list</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_update_gui_from_state</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.prepare_acquisition_list"><a class="viewcode-back" href="../../../share/mesoSPIM_Core.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.prepare_acquisition_list">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_acquisition_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acq_list</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Housekeeping: Prepare the acquisition list</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_acquisition_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">acq_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_image_count</span> <span class="o">=</span> <span class="n">acq_list</span><span class="o">.</span><span class="n">get_image_count</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_list_rotation_position</span> <span class="o">=</span>  <span class="n">acq_list</span><span class="o">.</span><span class="n">get_rotation_point</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.run_acquisition_list"><a class="viewcode-back" href="../../../share/mesoSPIM_Core.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.run_acquisition_list">[docs]</a>    <span class="k">def</span> <span class="nf">run_acquisition_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acq_list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">acq</span> <span class="ow">in</span> <span class="n">acq_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prepare_acquisition</span><span class="p">(</span><span class="n">acq</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_acquisition</span><span class="p">(</span><span class="n">acq</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close_acquisition</span><span class="p">(</span><span class="n">acq</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.close_acquisition_list"><a class="viewcode-back" href="../../../share/mesoSPIM_Core.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.close_acquisition_list">[docs]</a>    <span class="k">def</span> <span class="nf">close_acquisition_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acq_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Closing Acquisition List&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span><span class="p">:</span>
            <span class="n">current_rotation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">][</span><span class="s1">&#39;theta_pos&#39;</span><span class="p">]</span>
            <span class="n">startpoint</span> <span class="o">=</span> <span class="n">acq_list</span><span class="o">.</span><span class="n">get_startpoint</span><span class="p">()</span>
            <span class="n">target_rotation</span> <span class="o">=</span> <span class="n">startpoint</span><span class="p">[</span><span class="s1">&#39;theta_abs&#39;</span><span class="p">]</span>
            <span class="n">rotation_position</span> <span class="o">=</span> <span class="n">acq_list</span><span class="o">.</span><span class="n">get_rotation_point</span><span class="p">()</span>

            <span class="c1"># if current_rotation &gt; target_rotation+0.1 or current_rotation &lt; target_rotation-0.1:</span>
            <span class="c1">#     self.move_absolute(rotation_position, wait_until_done=True)</span>
            <span class="c1">#     self.move_absolute({&#39;theta_abs&#39;:target_rotation}, wait_until_done=True)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">move_absolute</span><span class="p">(</span><span class="n">acq_list</span><span class="o">.</span><span class="n">get_startpoint</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.preview_acquisition"><a class="viewcode-back" href="../../../share/mesoSPIM_Core.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.preview_acquisition">[docs]</a>    <span class="k">def</span> <span class="nf">preview_acquisition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;selected_row&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">row</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No row selected!&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_update_gui_from_state</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">acq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;acq_list&#39;</span><span class="p">][</span><span class="n">row</span><span class="p">]</span>

            <span class="n">rotation_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;acq_list&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_rotation_point</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sig_status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Going to start position&#39;</span><span class="p">)</span>
            
            <span class="sd">&#39;&#39;&#39; Rotation handling goes here &#39;&#39;&#39;</span>
            <span class="n">current_rotation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">][</span><span class="s1">&#39;theta_pos&#39;</span><span class="p">]</span>
            <span class="n">startpoint</span> <span class="o">=</span> <span class="n">acq</span><span class="o">.</span><span class="n">get_startpoint</span><span class="p">()</span>
            <span class="n">target_rotation</span> <span class="o">=</span> <span class="n">startpoint</span><span class="p">[</span><span class="s1">&#39;theta_abs&#39;</span><span class="p">]</span>

            <span class="sd">&#39;&#39;&#39; Check if sample has to be rotated, allow some tolerance &#39;&#39;&#39;</span>
            <span class="c1"># if current_rotation &gt; target_rotation+0.1 or current_rotation &lt; target_rotation-0.1:</span>
            <span class="c1">#     self.move_absolute(rotation_position, wait_until_done=True)</span>
            <span class="c1">#     self.move_absolute({&#39;theta_abs&#39;:target_rotation}, wait_until_done=True)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">move_absolute</span><span class="p">(</span><span class="n">startpoint</span><span class="p">,</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sig_status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Setting Filter &amp; Shutter&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_shutterconfig</span><span class="p">(</span><span class="n">acq</span><span class="p">[</span><span class="s1">&#39;shutterconfig&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_filter</span><span class="p">(</span><span class="n">acq</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">],</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Setting Zoom&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_zoom</span><span class="p">(</span><span class="n">acq</span><span class="p">[</span><span class="s1">&#39;zoom&#39;</span><span class="p">],</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_intensity</span><span class="p">(</span><span class="n">acq</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">],</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_laser</span><span class="p">(</span><span class="n">acq</span><span class="p">[</span><span class="s1">&#39;laser&#39;</span><span class="p">],</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;etl_l_amplitude&#39;</span> <span class="p">:</span> <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;etl_l_amplitude&#39;</span><span class="p">]})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;etl_r_amplitude&#39;</span> <span class="p">:</span> <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;etl_r_amplitude&#39;</span><span class="p">]})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;etl_l_offset&#39;</span> <span class="p">:</span> <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;etl_l_offset&#39;</span><span class="p">]})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;etl_r_offset&#39;</span> <span class="p">:</span> <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;etl_r_offset&#39;</span><span class="p">]})</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sig_update_gui_from_state</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;idle&#39;</span></div>
        
<div class="viewcode-block" id="mesoSPIM_Core.prepare_acquisition"><a class="viewcode-back" href="../../../share/mesoSPIM_Core.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.prepare_acquisition">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_acquisition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acq</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Housekeeping: Prepare the acquisition</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running Acquisition #&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_count</span><span class="p">,</span>
                <span class="s1">&#39; with Filename: &#39;</span><span class="p">,</span> <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Going to start position&#39;</span><span class="p">)</span>
        <span class="sd">&#39;&#39;&#39; Rotation handling goes here:</span>

<span class="sd">        If target rotation different than current rotation:</span>
<span class="sd">            - go to target position</span>
<span class="sd">            - rotate to target angle</span>
<span class="sd">            - </span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">current_rotation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">][</span><span class="s1">&#39;theta_pos&#39;</span><span class="p">]</span>
        <span class="n">startpoint</span> <span class="o">=</span> <span class="n">acq</span><span class="o">.</span><span class="n">get_startpoint</span><span class="p">()</span>
        <span class="n">target_rotation</span> <span class="o">=</span> <span class="n">startpoint</span><span class="p">[</span><span class="s1">&#39;theta_abs&#39;</span><span class="p">]</span>

        <span class="sd">&#39;&#39;&#39; Check if sample has to be rotated, allow some tolerance &#39;&#39;&#39;</span>
        <span class="c1"># if current_rotation &gt; target_rotation+0.1 or current_rotation &lt; target_rotation-0.1:</span>
        <span class="c1">#     self.move_absolute(self.acquisition_list_rotation_position, wait_until_done=True)</span>
        <span class="c1">#     self.move_absolute({&#39;theta_abs&#39;:target_rotation}, wait_until_done=True)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">move_absolute</span><span class="p">(</span><span class="n">startpoint</span><span class="p">,</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sig_status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Setting Filter &amp; Shutter&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_shutterconfig</span><span class="p">(</span><span class="n">acq</span><span class="p">[</span><span class="s1">&#39;shutterconfig&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_filter</span><span class="p">(</span><span class="n">acq</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">],</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Setting Zoom&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_zoom</span><span class="p">(</span><span class="n">acq</span><span class="p">[</span><span class="s1">&#39;zoom&#39;</span><span class="p">],</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_intensity</span><span class="p">(</span><span class="n">acq</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">],</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_laser</span><span class="p">(</span><span class="n">acq</span><span class="p">[</span><span class="s1">&#39;laser&#39;</span><span class="p">],</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;etl_l_amplitude&#39;</span> <span class="p">:</span> <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;etl_l_amplitude&#39;</span><span class="p">]})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;etl_r_amplitude&#39;</span> <span class="p">:</span> <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;etl_r_amplitude&#39;</span><span class="p">]})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;etl_l_offset&#39;</span> <span class="p">:</span> <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;etl_l_offset&#39;</span><span class="p">]})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;etl_r_offset&#39;</span> <span class="p">:</span> <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;etl_r_offset&#39;</span><span class="p">]})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sig_status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Preparing camera: Allocating memory&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_prepare_image_series</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">acq</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepare_image_series</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_metadata</span><span class="p">(</span><span class="n">acq</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="mesoSPIM_Core.run_acquisition"><a class="viewcode-back" href="../../../share/mesoSPIM_Core.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.run_acquisition">[docs]</a>    <span class="k">def</span> <span class="nf">run_acquisition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acq</span><span class="p">):</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="n">acq</span><span class="o">.</span><span class="n">get_image_count</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Running Acquisition&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open_shutters</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close_image_series</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sig_end_image_series</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sig_finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">snap_image_in_series</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sig_add_images_to_image_series</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
                <span class="c1">#time.sleep(0.02)</span>
                <span class="c1"># self.sig_add_images_to_image_series_and_wait_until_done.emit()</span>

                <span class="c1"># self.move_relative(acq.get_delta_z_dict(), wait_until_done=True)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">move_relative</span><span class="p">(</span><span class="n">acq</span><span class="o">.</span><span class="n">get_delta_z_dict</span><span class="p">())</span>

                <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QEventLoop</span><span class="o">.</span><span class="n">AllEvents</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">image_count</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">send_progress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acquisition_count</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">total_acquisition_count</span><span class="p">,</span>
                                   <span class="n">i</span><span class="p">,</span>
                                   <span class="n">steps</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">total_image_count</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">image_count</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_shutters</span><span class="p">()</span></div>
        
<div class="viewcode-block" id="mesoSPIM_Core.close_acquisition"><a class="viewcode-back" href="../../../share/mesoSPIM_Core.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.close_acquisition">[docs]</a>    <span class="k">def</span> <span class="nf">close_acquisition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acq</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Closing Acquisition: Saving data &amp; freeing up memory&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">move_absolute</span><span class="p">(</span><span class="n">acq</span><span class="o">.</span><span class="n">get_startpoint</span><span class="p">(),</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_image_series</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_end_image_series</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_count</span> <span class="o">+=</span> <span class="mi">1</span></div>
  
<div class="viewcode-block" id="mesoSPIM_Core.execute_script"><a class="viewcode-back" href="../../../share/mesoSPIM_Core.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.execute_script">[docs]</a>    <span class="nd">@QtCore</span><span class="o">.</span><span class="n">pyqtSlot</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">execute_script</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">script</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_update_gui_from_state</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;running_script&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">exec</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;idle&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_update_gui_from_state</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.lightsheet_alignment_mode"><a class="viewcode-back" href="../../../share/mesoSPIM_Core.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.lightsheet_alignment_mode">[docs]</a>    <span class="k">def</span> <span class="nf">lightsheet_alignment_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Switches shutters after each image to allow coalignment of both lightsheets&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_prepare_live</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
        <span class="sd">&#39;&#39;&#39;Needs more careful adjustment of the timing</span>

<span class="sd">        TODO: There is no wait period to wait for the shutters to open. Nonetheless, the</span>
<span class="sd">        visual of the mode impression is not too bad.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutter_left</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snap_image</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_get_live_image</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutter_left</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutter_right</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snap_image</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_get_live_image</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutter_right</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">close_shutters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_end_live</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.visual_mode"><a class="viewcode-back" href="../../../share/mesoSPIM_Core.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.visual_mode">[docs]</a>    <span class="k">def</span> <span class="nf">visual_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">old_l_amp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;etl_l_amplitude&#39;</span><span class="p">]</span>
        <span class="n">old_r_amp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;etl_r_amplitude&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;etl_l_amplitude&#39;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;etl_r_amplitude&#39;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
       
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_prepare_live</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">open_shutters</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="sd">&#39;&#39;&#39; Needs update to use snap image in series &#39;&#39;&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snap_image</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_get_live_image</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
            <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>

            <span class="sd">&#39;&#39;&#39; How to handle a possible shutter switch?&#39;&#39;&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">open_shutters</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">close_shutters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_end_live</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sig_finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;etl_l_amplitude&#39;</span> <span class="p">:</span> <span class="n">old_l_amp</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;etl_r_amplitude&#39;</span> <span class="p">:</span> <span class="n">old_r_amp</span><span class="p">})</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.write_line"><a class="viewcode-back" href="../../../share/mesoSPIM_Core.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.write_line">[docs]</a>    <span class="k">def</span> <span class="nf">write_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Little helper method to write a single line with a key and value for metadata</span>

<span class="sd">        Adds a line break at the end.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;] &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="mesoSPIM_Core.write_metadata"><a class="viewcode-back" href="../../../share/mesoSPIM_Core.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.write_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">write_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acq</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Writes a metadata.txt file</span>

<span class="sd">        Path contains the file to be written</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;folder&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">acq</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span>

        <span class="n">metadata_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_meta.txt&#39;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Metadata_path: &#39;</span><span class="p">,</span> <span class="n">metadata_path</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metadata_path</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;Metadata for file&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;z_stepsize&#39;</span><span class="p">,</span> <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;z_step&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;z_planes&#39;</span><span class="p">,</span> <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;planes&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="c1"># self.write_line(file, &#39;COMMENTS&#39;)</span>
            <span class="c1"># self.write_line(file, &#39;Comment: &#39;, acq([&#39;comment&#39;]))</span>
            <span class="c1"># self.write_line(file)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;CFG&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;Laser&#39;</span><span class="p">,</span> <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;laser&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;Intensity (%)&#39;</span><span class="p">,</span> <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;Zoom&#39;</span><span class="p">,</span> <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;zoom&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;Pixelsize in um&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;pixelsize&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;Filter&#39;</span><span class="p">,</span> <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;Shutter&#39;</span><span class="p">,</span> <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;shutterconfig&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;POSTION&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;x_pos&#39;</span><span class="p">,</span> <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;x_pos&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;y_pos&#39;</span><span class="p">,</span> <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;y_pos&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;f_pos&#39;</span><span class="p">,</span> <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;f_pos&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;z_start&#39;</span><span class="p">,</span> <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;z_start&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;z_end&#39;</span><span class="p">,</span> <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;z_end&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;z_stepsize&#39;</span><span class="p">,</span> <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;z_step&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;z_planes&#39;</span><span class="p">,</span> <span class="n">acq</span><span class="o">.</span><span class="n">get_image_count</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

            <span class="sd">&#39;&#39;&#39; Attention: change to true ETL values ASAP &#39;&#39;&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="s1">&#39;ETL PARAMETERS&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;ETL CFG File&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;ETL_cfg_file&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="s1">&#39;etl_l_offset&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;etl_l_offset&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="s1">&#39;etl_l_amplitude&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;etl_l_amplitude&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="s1">&#39;etl_r_offset&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;etl_r_offset&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="s1">&#39;etl_r_amplitude&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;etl_r_amplitude&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;GALVO PARAMETERS&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;galvo_l_frequency&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;galvo_l_frequency&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;galvo_l_amplitude&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;galvo_l_amplitude&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;galvo_l_offset&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;galvo_l_offset&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;galvo_r_amplitude&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;galvo_r_amplitude&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;galvo_r_offset&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;galvo_r_offset&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;CAMERA PARAMETERS&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;camera_exposure&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;camera_exposure_time&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;camera_line_interval&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;camera_line_interval&#39;</span><span class="p">])</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Fabian F. Voigt.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>