<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>multiScope &mdash; self-driving multi-scale imaging 1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=359c27e9"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            self-driving multi-scale imaging
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">self-driving multi-scale imaging</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">multiScope</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for multiScope</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">queue</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">atexit</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">shared_memory</span>
<span class="kn">from</span> <span class="nn">tifffile</span> <span class="kn">import</span> <span class="n">imread</span><span class="p">,</span> <span class="n">imwrite</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="kn">import</span> <span class="nn">acquisition_array_class</span> <span class="k">as</span> <span class="nn">acq_arrays</span>

<span class="kn">import</span> <span class="nn">src.camera.Photometrics_camera</span> <span class="k">as</span> <span class="nn">Photometricscamera</span>
<span class="kn">import</span> <span class="nn">src.camera.Synthetic_camera</span> <span class="k">as</span> <span class="nn">Synthetic_camera</span>

<span class="kn">import</span> <span class="nn">src.ni_board.vni</span> <span class="k">as</span> <span class="nn">ni</span>
<span class="kn">import</span> <span class="nn">src.ni_board.ni_synthetic</span> <span class="k">as</span> <span class="nn">synthetic_ni</span>

<span class="kn">import</span> <span class="nn">src.stages.rotation_stage_cmd</span> <span class="k">as</span> <span class="nn">RotStage</span>
<span class="kn">import</span> <span class="nn">src.stages.synthetic_rotation_stage</span> <span class="k">as</span> <span class="nn">Synthetic_RotStage</span>

<span class="kn">import</span> <span class="nn">src.stages.translation_stage_cmd</span> <span class="k">as</span> <span class="nn">TransStage</span>
<span class="kn">import</span> <span class="nn">src.stages.synthetic_translation_stage</span> <span class="k">as</span> <span class="nn">Synthetic_TransStage</span>

<span class="kn">import</span> <span class="nn">src.filter_wheel.ludlcontrol</span> <span class="k">as</span> <span class="nn">FilterWheel</span>
<span class="kn">import</span> <span class="nn">src.filter_wheel.Synthetic_Filterwheel</span> <span class="k">as</span> <span class="nn">Synthetic_FilterWheel</span>

<span class="kn">import</span> <span class="nn">src.slit.slit_cmd</span> <span class="k">as</span> <span class="nn">SlitControl</span>

<span class="kn">import</span> <span class="nn">auxiliary_code.concurrency_tools</span> <span class="k">as</span> <span class="nn">ct</span>
<span class="kn">import</span> <span class="nn">auxiliary_code.napari_in_subprocess</span> <span class="k">as</span> <span class="nn">napari</span>
<span class="kn">from</span> <span class="nn">auxiliary_code.constants</span> <span class="kn">import</span> <span class="n">FilterWheel_parameters</span>
<span class="kn">from</span> <span class="nn">auxiliary_code.constants</span> <span class="kn">import</span> <span class="n">Stage_parameters</span>
<span class="kn">from</span> <span class="nn">auxiliary_code.constants</span> <span class="kn">import</span> <span class="n">NI_board_parameters</span>
<span class="kn">from</span> <span class="nn">auxiliary_code.constants</span> <span class="kn">import</span> <span class="n">Camera_parameters</span>
<span class="kn">from</span> <span class="nn">auxiliary_code.constants</span> <span class="kn">import</span> <span class="n">ASLM_parameters</span>
<span class="kn">from</span> <span class="nn">auxiliary_code.constants</span> <span class="kn">import</span> <span class="n">microscope_configuration</span>


<span class="kn">from</span> <span class="nn">automated_microscopy.drift_correction</span> <span class="kn">import</span> <span class="n">drift_correction</span>
<span class="kn">from</span> <span class="nn">automated_microscopy.image_deposit</span> <span class="kn">import</span> <span class="n">images_InMemory_class</span>

<div class="viewcode-block" id="multiScopeModel"><a class="viewcode-back" href="../multiScope.html#multiScope.multiScopeModel">[docs]</a><span class="k">class</span> <span class="nc">multiScopeModel</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The main model class of the multi-scale microscope.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unfinished_tasks</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">num_frames</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

        <span class="c1"># parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exposure_time_HR</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exposure_time_LR</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">continue_preview_lowres</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">continue_preview_highres</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack_nbplanes_lowres</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack_nbplanes_highres</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lowres_planespacing</span> <span class="o">=</span> <span class="mi">10000000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highres_planespacing</span> <span class="o">=</span> <span class="mi">10000000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">displayImStack</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">abortStackFlag</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#abort current stack acquisition if value is 1, otherwise 0</span>

        <span class="c1"># filepath variables for saving image and projections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span> <span class="o">=</span> <span class="s1">&#39;D:/acquisitions/testimage.tif&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_projectionfilepath</span> <span class="o">=</span> <span class="s1">&#39;D:/acquisitions/testimage.tif&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_positionfilepath</span> <span class="o">=</span> <span class="s1">&#39;D:/acquisitions/testimage.txt&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">experimentfilepath</span> <span class="o">=</span> <span class="s1">&#39;D:/acquisitions&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_timepointstring</span> <span class="o">=</span> <span class="s2">&quot;t00000&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">past_timepointstring</span> <span class="o">=</span> <span class="s2">&quot;t00000&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_region</span> <span class="o">=</span> <span class="s2">&quot;low_stack001&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_laser</span> <span class="o">=</span> <span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">laser488</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lowres_laserpower</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highres_laserpower</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">channelIndicator</span> <span class="o">=</span> <span class="s2">&quot;00&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slitopening_lowres</span> <span class="o">=</span> <span class="mi">3700</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slitopening_highres</span> <span class="o">=</span> <span class="mi">4558</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autoscale_preview</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slow_velocity</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slow_acceleration</span> <span class="o">=</span> <span class="mf">0.1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_lowresROI_width</span> <span class="o">=</span> <span class="n">Camera_parameters</span><span class="o">.</span><span class="n">LR_width_pixel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_lowresROI_height</span> <span class="o">=</span> <span class="n">Camera_parameters</span><span class="o">.</span><span class="n">LR_height_pixel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_highresROI_width</span> <span class="o">=</span> <span class="n">Camera_parameters</span><span class="o">.</span><span class="n">HR_width_pixel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_highresROI_height</span> <span class="o">=</span> <span class="n">Camera_parameters</span><span class="o">.</span><span class="n">HR_height_pixel</span>

        <span class="c1"># for keeping track of the allocated buffer size (so that it doesn&#39;t have to be allocated twice)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updatebuffer_highres_width</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updatebuffer_highres_height</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updatebuffer_highres_stacknb</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updatebuffer_lowres_width</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updatebuffer_lowres_height</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updatebuffer_lowres_stacknb</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">high_res_memory_names</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">low_res_memory_names</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lowresbuffernumber</span> <span class="o">=</span> <span class="mi">3</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">delay_cameratrigger</span> <span class="o">=</span> <span class="mf">0.004</span>  <span class="c1"># the time given for the stage to move to the new position</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ASLM_acquisition_time</span> <span class="o">=</span> <span class="mf">0.3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ASLM_from_Volt</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># first voltage applied at remote mirror</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ASLM_to_Volt</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># voltage applied at remote mirror at the end of sawtooth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ASLM_currentVolt</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># current voltage applied to remote mirror</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ASLM_staticLowResVolt</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># default ASLM low res voltage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ASLM_staticHighResVolt</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># default ASLM high res voltage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ASLM_alignmentOn</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># param=1 if ASLM alignment mode is on, otherwise zero</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ASLM_delaybeforevoltagereturn</span> <span class="o">=</span> <span class="mf">0.001</span>  <span class="c1"># 1 ms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ASLM_additionalreturntime</span> <span class="o">=</span> <span class="mf">0.001</span>  <span class="c1"># 1ms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ASLM_scanWidth</span> <span class="o">=</span> <span class="n">ASLM_parameters</span><span class="o">.</span><span class="n">simultaneous_lines</span>

        <span class="c1"># preview buffers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">low_res_buffer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">Camera_parameters</span><span class="o">.</span><span class="n">LR_height_pixel</span><span class="p">,</span> <span class="n">Camera_parameters</span><span class="o">.</span><span class="n">LR_width_pixel</span><span class="p">],</span>
                                       <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint16&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">high_res_buffer</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">SharedNDArray</span><span class="p">(</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">Camera_parameters</span><span class="o">.</span><span class="n">HR_height_pixel</span><span class="p">,</span> <span class="n">Camera_parameters</span><span class="o">.</span><span class="n">HR_width_pixel</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint16&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">low_res_buffer</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># fill to initialize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">high_res_buffer</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># fill to initialize</span>

        <span class="c1"># textlabels for GUI</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentFPS</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># drift correction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ImageRepo</span> <span class="o">=</span> <span class="n">images_InMemory_class</span><span class="p">()</span> <span class="c1">#place holder for obtaining drift correction class from controller</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">driftcorrectionmodule</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#place holder for obtaining drift correction class from controller</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drift_correctionOnHighRes</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#parameter whether high res drift correction is enabled</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drift_correctionOnLowRes</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#parameter whether low res drift correction is enabled</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drift_which_channels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#array on which channels drift correction is run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perform_driftcorrectionOnChannel</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#flag whether for current stack, drift correction should be performed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_PosNumber</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#todo previously &#39;item0&#39;</span>

        <span class="c1"># initialize buffers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_bufferSize</span><span class="p">()</span>

        <span class="c1">#initialize buffer queue so that there are two buffers - so that one can be used for acquisition and one for processing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">high_res_buffers_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">low_res_buffers_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">high_res_buffers_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lowresbuffernumber</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">low_res_buffers_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="c1"># start initializing all hardware component here by calling the initialization from a ResultThread</span>
        <span class="n">lowres_camera_init</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">ResultThread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_init_lowres_camera</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>  <span class="c1"># ~3.6s</span>
        <span class="n">highres_camera_init</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">ResultThread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_init_highres_camera</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>  <span class="c1"># ~3.6s</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_display</span><span class="p">()</span>  <span class="c1"># ~1.3s</span>

        <span class="c1"># init acquisition array writing class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_acq_array</span> <span class="o">=</span> <span class="n">acq_arrays</span><span class="o">.</span><span class="n">acquisition_arrays</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># initialize stages and stages in ResultThreads</span>
        <span class="n">trans_stage_init</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">ResultThread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_init_XYZ_stage</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>  <span class="c1"># ~0.4s</span>
        <span class="n">rot_stage_init</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">ResultThread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_init_rotation_stage</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">filterwheel_init</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">ResultThread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_init_filterwheel</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>  <span class="c1"># ~5.3s</span>
        <span class="c1">#slit_init = ct.ResultThread(target=self._init_slit).start()  #</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_init_ao</span><span class="p">()</span>  <span class="c1"># ~0.2s</span>

        <span class="c1"># wait for all started initialization threads before continuing (by calling thread join)</span>
        <span class="n">lowres_camera_init</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Successfully initialized lowres camera&#39;</span><span class="p">)</span>
        <span class="n">highres_camera_init</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Successfully initialized highres camera&#39;</span><span class="p">)</span>
        <span class="n">filterwheel_init</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Successfully initialized filter wheel&#39;</span><span class="p">)</span>
        <span class="n">trans_stage_init</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Successfully initialized stage&#39;</span><span class="p">)</span>
        <span class="n">rot_stage_init</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Successfully initialized rot stage&#39;</span><span class="p">)</span>
        <span class="c1">#slit_init.get_result()</span>
        <span class="c1">#print(&#39;Successfully initialized slit&#39;)</span>


        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Finished initializing multiScope&#39;</span><span class="p">)</span>

<span class="c1">#######################################################################################################################</span>
<span class="c1"># Next come the initialization functions for hardware, and smart microscopy tools</span>
<span class="c1">#######################################################################################################################</span>
    <span class="k">def</span> <span class="nf">_init_lowres_camera</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize low resolution camera</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initializing low resolution camera ..&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">microscope_configuration</span><span class="o">.</span><span class="n">lowres_camera</span> <span class="o">==</span> <span class="s1">&#39;Photometrics_lowres&#39;</span><span class="p">:</span>
            <span class="c1"># place the Photometrics class as object into an Object in Subprocess</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lowres_camera</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">ObjectInSubprocess</span><span class="p">(</span><span class="n">Photometricscamera</span><span class="o">.</span><span class="n">Photo_Camera</span><span class="p">,</span> <span class="s1">&#39;PMPCIECam00&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lowres_camera_ROI</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lowres_camera</span><span class="o">.</span><span class="n">get_imageroi</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lowres_camera_ROI</span><span class="p">)</span>
            <span class="c1"># self.lowres_camera.take_snapshot(20)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;done with camera.&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># place the Photometrics class as object into an Object in Subprocess</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lowres_camera</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">ObjectInSubprocess</span><span class="p">(</span><span class="n">Synthetic_camera</span><span class="o">.</span><span class="n">Synthetic_Photo_Camera</span><span class="p">,</span> <span class="s1">&#39;lowres_synthetic&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lowres_camera_ROI</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lowres_camera</span><span class="o">.</span><span class="n">get_imageroi</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lowres_camera_ROI</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;done with camera.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_highres_camera</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize low resolution camera</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">microscope_configuration</span><span class="o">.</span><span class="n">highres_camera</span> <span class="o">==</span> <span class="s1">&#39;Photometrics_highres&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initializing high resolution camera..&quot;</span><span class="p">)</span>
            <span class="c1"># place the Photometrics class as object into an Object in Subprocess</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">highres_camera</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">ObjectInSubprocess</span><span class="p">(</span><span class="n">Photometricscamera</span><span class="o">.</span><span class="n">Photo_Camera</span><span class="p">,</span> <span class="s1">&#39;PMUSBCam00&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">highres_camera_ROI</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">highres_camera</span><span class="o">.</span><span class="n">get_imageroi</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highres_camera_ROI</span><span class="p">)</span>
            <span class="c1"># self.lowres_camera.take_snapshot(20)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;done with camera.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># place the Photometrics class as object into an Object in Subprocess</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">highres_camera</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">ObjectInSubprocess</span><span class="p">(</span><span class="n">Synthetic_camera</span><span class="o">.</span><span class="n">Synthetic_Photo_Camera</span><span class="p">,</span> <span class="s1">&#39;highres_synthetic&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">highres_camera_ROI</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">highres_camera</span><span class="o">.</span><span class="n">get_imageroi</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highres_camera_ROI</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;done with camera.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_display</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initializing display...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">ObjectInSubprocess</span><span class="p">(</span><span class="n">napari</span><span class="o">.</span><span class="n">_NapariDisplay</span><span class="p">,</span> <span class="n">custom_loop</span><span class="o">=</span><span class="n">napari</span><span class="o">.</span><span class="n">_napari_child_loop</span><span class="p">,</span>
                                             <span class="n">close_method_name</span><span class="o">=</span><span class="s1">&#39;close&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;done with display.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_ao</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize National Instruments card 6378 as device 1, Dev1</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initializing ao card...&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">microscope_configuration</span><span class="o">.</span><span class="n">ni_board</span> <span class="o">==</span> <span class="s1">&#39;NI_Board&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ao</span> <span class="o">=</span> <span class="n">ni</span><span class="o">.</span><span class="n">Analog_Out</span><span class="p">(</span>
                <span class="n">num_channels</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">ao_nchannels</span><span class="p">,</span>
                <span class="n">rate</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">rate</span><span class="p">,</span>
                <span class="n">daq_type</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">ao_type</span><span class="p">,</span>
                <span class="n">line</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">line_selection</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ao_laser488_power</span> <span class="o">=</span> <span class="n">ni</span><span class="o">.</span><span class="n">Analog_Out</span><span class="p">(</span>
                <span class="n">daq_type</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">ao_type_constant</span><span class="p">,</span>
                <span class="n">line</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">power_488_line</span><span class="p">,</span>
                <span class="n">minVol</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">minVol_constant</span><span class="p">,</span>
                <span class="n">maxVol</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">maxVol_constant</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ao_laser552_power</span> <span class="o">=</span> <span class="n">ni</span><span class="o">.</span><span class="n">Analog_Out</span><span class="p">(</span>
                <span class="n">daq_type</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">ao_type_constant</span><span class="p">,</span>
                <span class="n">line</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">power_552_line</span><span class="p">,</span>
                <span class="n">minVol</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">minVol_constant</span><span class="p">,</span>
                <span class="n">maxVol</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">maxVol_constant</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ao_laser594_power</span> <span class="o">=</span> <span class="n">ni</span><span class="o">.</span><span class="n">Analog_Out</span><span class="p">(</span>
                <span class="n">daq_type</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">ao_type_constant</span><span class="p">,</span>
                <span class="n">line</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">power_594_line</span><span class="p">,</span>
                <span class="n">minVol</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">minVol_constant</span><span class="p">,</span>
                <span class="n">maxVol</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">maxVol_constant</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ao_laser640_power</span> <span class="o">=</span> <span class="n">ni</span><span class="o">.</span><span class="n">Analog_Out</span><span class="p">(</span>
                <span class="n">daq_type</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">ao_type_constant</span><span class="p">,</span>
                <span class="n">line</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">power_640_line</span><span class="p">,</span>
                <span class="n">minVol</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">minVol_constant</span><span class="p">,</span>
                <span class="n">maxVol</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">maxVol_constant</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flipMirrorPosition_power</span> <span class="o">=</span> <span class="n">ni</span><span class="o">.</span><span class="n">Analog_Out</span><span class="p">(</span>
                <span class="n">daq_type</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">ao_type_constant</span><span class="p">,</span>
                <span class="n">line</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">flip_mirror_line</span><span class="p">,</span>
                <span class="n">minVol</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">minVol_constant</span><span class="p">,</span>
                <span class="n">maxVol</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">maxVol_constant</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">LED_voltage</span> <span class="o">=</span> <span class="n">ni</span><span class="o">.</span><span class="n">Analog_Out</span><span class="p">(</span>
                <span class="n">daq_type</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">ao_type_constant</span><span class="p">,</span>
                <span class="n">line</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">LED_line</span><span class="p">,</span>
                <span class="n">minVol</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">minVol_constant</span><span class="p">,</span>
                <span class="n">maxVol</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">maxVol_constant</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;done with ao.&quot;</span><span class="p">)</span>
            <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ao</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ao</span> <span class="o">=</span> <span class="n">synthetic_ni</span><span class="o">.</span><span class="n">Analog_Out</span><span class="p">(</span>
                <span class="n">num_channels</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">ao_nchannels</span><span class="p">,</span>
                <span class="n">rate</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">rate</span><span class="p">,</span>
                <span class="n">daq_type</span><span class="o">=</span> <span class="s1">&#39;synthetic&#39;</span><span class="p">,</span>
                <span class="n">line</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">line_selection</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ao_laser488_power</span> <span class="o">=</span> <span class="n">synthetic_ni</span><span class="o">.</span><span class="n">Analog_Out</span><span class="p">(</span>
                <span class="n">daq_type</span><span class="o">=</span><span class="s1">&#39;synthetic_constant&#39;</span><span class="p">,</span>
                <span class="n">line</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">power_488_line</span><span class="p">,</span>
                <span class="n">minVol</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">minVol_constant</span><span class="p">,</span>
                <span class="n">maxVol</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">maxVol_constant</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ao_laser552_power</span> <span class="o">=</span> <span class="n">synthetic_ni</span><span class="o">.</span><span class="n">Analog_Out</span><span class="p">(</span>
                <span class="n">daq_type</span><span class="o">=</span><span class="s1">&#39;synthetic_constant&#39;</span><span class="p">,</span>
                <span class="n">line</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">power_552_line</span><span class="p">,</span>
                <span class="n">minVol</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">minVol_constant</span><span class="p">,</span>
                <span class="n">maxVol</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">maxVol_constant</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ao_laser594_power</span> <span class="o">=</span> <span class="n">synthetic_ni</span><span class="o">.</span><span class="n">Analog_Out</span><span class="p">(</span>
                <span class="n">daq_type</span><span class="o">=</span><span class="s1">&#39;synthetic_constant&#39;</span><span class="p">,</span>
                <span class="n">line</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">power_594_line</span><span class="p">,</span>
                <span class="n">minVol</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">minVol_constant</span><span class="p">,</span>
                <span class="n">maxVol</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">maxVol_constant</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ao_laser640_power</span> <span class="o">=</span> <span class="n">synthetic_ni</span><span class="o">.</span><span class="n">Analog_Out</span><span class="p">(</span>
                <span class="n">daq_type</span><span class="o">=</span><span class="s1">&#39;synthetic_constant&#39;</span><span class="p">,</span>
                <span class="n">line</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">power_640_line</span><span class="p">,</span>
                <span class="n">minVol</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">minVol_constant</span><span class="p">,</span>
                <span class="n">maxVol</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">maxVol_constant</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flipMirrorPosition_power</span> <span class="o">=</span> <span class="n">synthetic_ni</span><span class="o">.</span><span class="n">Analog_Out</span><span class="p">(</span>
                <span class="n">daq_type</span><span class="o">=</span><span class="s1">&#39;synthetic_constant&#39;</span><span class="p">,</span>
                <span class="n">line</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">flip_mirror_line</span><span class="p">,</span>
                <span class="n">minVol</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">minVol_constant</span><span class="p">,</span>
                <span class="n">maxVol</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">maxVol_constant</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">LED_voltage</span> <span class="o">=</span> <span class="n">synthetic_ni</span><span class="o">.</span><span class="n">Analog_Out</span><span class="p">(</span>
                <span class="n">daq_type</span><span class="o">=</span><span class="s1">&#39;synthetic_constant&#39;</span><span class="p">,</span>
                <span class="n">line</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">LED_line</span><span class="p">,</span>
                <span class="n">minVol</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">minVol_constant</span><span class="p">,</span>
                <span class="n">maxVol</span><span class="o">=</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">maxVol_constant</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_filterwheel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize filterwheel</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">microscope_configuration</span><span class="o">.</span><span class="n">filterwheel</span> <span class="o">==</span> <span class="s1">&#39;Ludl_filterwheel&#39;</span><span class="p">:</span>
            <span class="n">ComPort</span> <span class="o">=</span> <span class="n">FilterWheel_parameters</span><span class="o">.</span><span class="n">comport</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="n">FilterWheel_parameters</span><span class="o">.</span><span class="n">avail_filters</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initializing filter wheel...&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filterwheel</span> <span class="o">=</span> <span class="n">FilterWheel</span><span class="o">.</span><span class="n">LudlFilterwheel</span><span class="p">(</span><span class="n">ComPort</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filterwheel</span><span class="o">.</span><span class="n">set_filter</span><span class="p">(</span><span class="s1">&#39;515-30-25&#39;</span><span class="p">,</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filterwheel</span><span class="o">.</span><span class="n">set_filter</span><span class="p">(</span><span class="s1">&#39;572/20-25&#39;</span><span class="p">,</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filterwheel</span><span class="o">.</span><span class="n">set_filter</span><span class="p">(</span><span class="s1">&#39;615/20-25&#39;</span><span class="p">,</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filterwheel</span><span class="o">.</span><span class="n">set_filter</span><span class="p">(</span><span class="s1">&#39;676/37-25&#39;</span><span class="p">,</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;done with Ludl filterwheel.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ComPort</span> <span class="o">=</span> <span class="n">FilterWheel_parameters</span><span class="o">.</span><span class="n">comport</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="n">FilterWheel_parameters</span><span class="o">.</span><span class="n">avail_filters</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initializing filter wheel...&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filterwheel</span> <span class="o">=</span> <span class="n">Synthetic_FilterWheel</span><span class="o">.</span><span class="n">Synthetic_Filterwheel</span><span class="p">(</span><span class="n">ComPort</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">)</span>



    <span class="k">def</span> <span class="nf">_init_XYZ_stage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize translation stage</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">microscope_configuration</span><span class="o">.</span><span class="n">translationstage</span> <span class="o">==</span> <span class="s1">&#39;Smaract_TranslationStage&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initializing XYZ stage usb:sn:MCS2-00001795...&quot;</span><span class="p">)</span>
            <span class="n">stage_id</span> <span class="o">=</span> <span class="n">Stage_parameters</span><span class="o">.</span><span class="n">stage_id_XYZ</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">XYZ_stage</span> <span class="o">=</span> <span class="n">TransStage</span><span class="o">.</span><span class="n">SLC_translationstage</span><span class="p">(</span><span class="n">stage_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">XYZ_stage</span><span class="o">.</span><span class="n">findReference</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initializing synthetic stage &quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">XYZ_stage</span> <span class="o">=</span> <span class="n">Synthetic_TransStage</span><span class="o">.</span><span class="n">Synthetic_translationstage</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">XYZ_stage</span><span class="o">.</span><span class="n">findReference</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;done with XYZ stage.&quot;</span><span class="p">)</span>
        <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">XYZ_stage</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_rotation_stage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize rotation stage</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initializing rotation stage...&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">microscope_configuration</span><span class="o">.</span><span class="n">rotationstage</span> <span class="o">==</span> <span class="s1">&#39;Smaract_RotationStage&#39;</span><span class="p">:</span>
            <span class="n">stage_id</span> <span class="o">=</span> <span class="n">Stage_parameters</span><span class="o">.</span><span class="n">stage_id_rot</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rotationstage</span> <span class="o">=</span> <span class="n">RotStage</span><span class="o">.</span><span class="n">SR2812_rotationstage</span><span class="p">(</span><span class="n">stage_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stage_id</span> <span class="o">=</span> <span class="n">Stage_parameters</span><span class="o">.</span><span class="n">stage_id_rot</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rotationstage</span> <span class="o">=</span> <span class="n">Synthetic_RotStage</span><span class="o">.</span><span class="n">Synthetic_rotationstage</span><span class="p">(</span><span class="n">stage_id</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;done with rot stage.&quot;</span><span class="p">)</span>
        <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotationstage</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>

    <span class="c1"># def _init_slit(self):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Initialize motorized slit</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     self.adjustableslit = SlitControl.slit_ximc_control()</span>
    <span class="c1">#     self.adjustableslit.slit_info()</span>
    <span class="c1">#     self.adjustableslit.slit_status()</span>
    <span class="c1">#     self.adjustableslit.slit_set_microstep_mode_256()</span>
    <span class="c1">#     self.adjustableslit.home_stage()</span>
    <span class="c1">#     print(&quot;slit homed&quot;)</span>
    <span class="c1">#     self.adjustableslit.slit_set_speed(800)</span>

<span class="c1">#######################################################################################################################</span>
<span class="c1"># Next come the functions at the end of a microscopy session - closing functions</span>
<span class="c1">#######################################################################################################################</span>
<div class="viewcode-block" id="multiScopeModel.close"><a class="viewcode-back" href="../multiScope.html#multiScope.multiScopeModel.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Close all opened channels, camera etc</span>
<span class="sd">                &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finish_all_tasks</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lowres_camera</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highres_camera</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ao</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotationstage</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">XYZ_stage</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1">#self.adjustableslit.slit_closing()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># more work needed here</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Closed multiScope&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="multiScopeModel.finish_all_tasks"><a class="viewcode-back" href="../multiScope.html#multiScope.multiScopeModel.finish_all_tasks">[docs]</a>    <span class="k">def</span> <span class="nf">finish_all_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">collected_tasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">th</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unfinished_tasks</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">th</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="n">collected_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">th</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">collected_tasks</span></div>

<span class="c1">#######################################################################################################################</span>
<span class="c1"># functions to control buffers and hardware run from GUI: update_bufferSize, set_laserpower, check_movementboundaries,</span>
<span class="c1"># move_to_position, move_adjustableslit, changeLRtoHR, changeHRtoLR</span>
<span class="c1">#######################################################################################################################</span>

<div class="viewcode-block" id="multiScopeModel.update_bufferSize"><a class="viewcode-back" href="../multiScope.html#multiScope.multiScopeModel.update_bufferSize">[docs]</a>    <span class="k">def</span> <span class="nf">update_bufferSize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This handles the size of the buffers during acquisitions.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># check for whether some image dimension parameters were changed</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">updatebuffer_highres_width</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_highresROI_width</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">updatebuffer_highres_height</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_highresROI_height</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">updatebuffer_highres_stacknb</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack_nbplanes_highres</span><span class="p">):</span>

            <span class="c1"># make sure to delete previous shared memory</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">high_res_memory_names</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Delete previous shared memory arrays&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">shared_memory</span><span class="o">.</span><span class="n">SharedMemory</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">high_res_memory_names</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                    <span class="n">shared_memory</span><span class="o">.</span><span class="n">SharedMemory</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">high_res_memory_names</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                    <span class="k">pass</span>  <span class="c1"># This is the error we expected if the memory was unlinked.</span>

            <span class="c1"># allocate memory</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">high_res_buffers</span> <span class="o">=</span> <span class="p">[</span><span class="n">ct</span><span class="o">.</span><span class="n">SharedNDArray</span><span class="p">(</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack_nbplanes_highres</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_highresROI_height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_highresROI_width</span><span class="p">),</span>
                <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint16&#39;</span><span class="p">)</span>
                                     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">high_res_buffers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">high_res_buffers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">high_res_memory_names</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">high_res_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shared_memory</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
            <span class="c1"># save current parameters so that you don&#39;t have to reallocate the memory again without image dimension changes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">updatebuffer_highres_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_highresROI_width</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">updatebuffer_highres_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_highresROI_height</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">updatebuffer_highres_stacknb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack_nbplanes_highres</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;high res buffer updated&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">updatebuffer_lowres_width</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_lowresROI_width</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">updatebuffer_lowres_height</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_lowresROI_height</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">updatebuffer_lowres_stacknb</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack_nbplanes_lowres</span><span class="p">):</span>

            <span class="c1"># make sure to delete previous shared memory</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">low_res_memory_names</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Delete previous shared memory arrays&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lowresbuffernumber</span><span class="p">):</span>
                        <span class="n">shared_memory</span><span class="o">.</span><span class="n">SharedMemory</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">low_res_memory_names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                    <span class="k">pass</span>  <span class="c1"># This is the error we expected if the memory was unlinked.</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">low_res_buffers</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ct</span><span class="o">.</span><span class="n">SharedNDArray</span><span class="p">(</span>
                    <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack_nbplanes_lowres</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_lowresROI_height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_lowresROI_width</span><span class="p">),</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint16&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lowresbuffernumber</span><span class="p">)]</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lowresbuffernumber</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">low_res_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">updatebuffer_lowres_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_lowresROI_width</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">updatebuffer_lowres_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_lowresROI_height</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">updatebuffer_lowres_stacknb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack_nbplanes_lowres</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;low res buffer updated&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">low_res_memory_names</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">low_res_buffers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shared_memory</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lowresbuffernumber</span><span class="p">)]</span></div>

<div class="viewcode-block" id="multiScopeModel.set_laserpower"><a class="viewcode-back" href="../multiScope.html#multiScope.multiScopeModel.set_laserpower">[docs]</a>    <span class="k">def</span> <span class="nf">set_laserpower</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">powersettings</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ao_laser488_power</span><span class="o">.</span><span class="n">setconstantvoltage</span><span class="p">(</span><span class="n">powersettings</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ao_laser552_power</span><span class="o">.</span><span class="n">setconstantvoltage</span><span class="p">(</span><span class="n">powersettings</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ao_laser594_power</span><span class="o">.</span><span class="n">setconstantvoltage</span><span class="p">(</span><span class="n">powersettings</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ao_laser640_power</span><span class="o">.</span><span class="n">setconstantvoltage</span><span class="p">(</span><span class="n">powersettings</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span></div>

<div class="viewcode-block" id="multiScopeModel.check_movementboundaries"><a class="viewcode-back" href="../multiScope.html#multiScope.multiScopeModel.check_movementboundaries">[docs]</a>    <span class="k">def</span> <span class="nf">check_movementboundaries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        :param array = [axialPosition, lateralPosition, updownPosition, anglePosition], a list of position the stages moves to</span>
<span class="sd">        :return: an array which has no out of range positions</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">20</span> <span class="o">*</span> <span class="mi">1000000000</span><span class="p">:</span>
            <span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">19.9</span> <span class="o">*</span> <span class="mi">1000000000</span>
        <span class="k">if</span> <span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">20</span> <span class="o">*</span> <span class="mi">1000000000</span><span class="p">:</span>
            <span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">19.9</span> <span class="o">*</span> <span class="mi">1000000000</span>

        <span class="k">if</span> <span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">20</span> <span class="o">*</span> <span class="mi">1000000000</span><span class="p">:</span>
            <span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">19.9</span> <span class="o">*</span> <span class="mi">1000000000</span>
        <span class="k">if</span> <span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">20</span> <span class="o">*</span> <span class="mi">1000000000</span><span class="p">:</span>
            <span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">19.9</span> <span class="o">*</span> <span class="mi">1000000000</span>

        <span class="k">if</span> <span class="n">array</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">41.9</span> <span class="o">*</span> <span class="mi">1000000000</span><span class="p">:</span>
            <span class="n">array</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">41.5</span> <span class="o">*</span> <span class="mi">1000000000</span>
        <span class="k">if</span> <span class="n">array</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">41.9</span> <span class="o">*</span> <span class="mi">1000000000</span><span class="p">:</span>
            <span class="n">array</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">41.5</span> <span class="o">*</span> <span class="mi">1000000000</span>

        <span class="k">return</span> <span class="n">array</span></div>

<div class="viewcode-block" id="multiScopeModel.move_to_position"><a class="viewcode-back" href="../multiScope.html#multiScope.multiScopeModel.move_to_position">[docs]</a>    <span class="k">def</span> <span class="nf">move_to_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positionlist</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        move to specified position according to positionlist</span>
<span class="sd">        :param positionlist: list of positions in format, e.g. [44280000, -2000000000, -2587870000]</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">positionlistInt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">positionlist</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">XYZ_stage</span><span class="o">.</span><span class="n">moveToPosition</span><span class="p">(</span><span class="n">positionlistInt</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotationstage</span><span class="o">.</span><span class="n">moveToAngle</span><span class="p">(</span><span class="n">positionlist</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span></div>

    <span class="c1"># def move_adjustableslit(self, slitopening, wait=0):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     :param slitopening: move to this slitopening;</span>
    <span class="c1">#     :param if wait==1 - wait for slit move to finish before continuing</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     self.adjustableslit.slit_move(int(slitopening), 0)</span>
    <span class="c1">#     if wait == 1:</span>
    <span class="c1">#         self.adjustableslit.slit_wait_for_stop(100)</span>

<div class="viewcode-block" id="multiScopeModel.changeLRtoHR"><a class="viewcode-back" href="../multiScope.html#multiScope.multiScopeModel.changeLRtoHR">[docs]</a>    <span class="k">def</span> <span class="nf">changeLRtoHR</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        change from low resolution to high resolution acquisition settings</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flipMirrorPosition_power</span><span class="o">.</span><span class="n">setconstantvoltage</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>
        <span class="c1">#self.move_adjustableslit(self.slitopening_highres, 1)</span>

<div class="viewcode-block" id="multiScopeModel.changeHRtoLR"><a class="viewcode-back" href="../multiScope.html#multiScope.multiScopeModel.changeHRtoLR">[docs]</a>    <span class="k">def</span> <span class="nf">changeHRtoLR</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        change from high resolution to low resolution acquisition settings</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flipMirrorPosition_power</span><span class="o">.</span><span class="n">setconstantvoltage</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span></div>
        <span class="c1">#self.move_adjustableslit(self.slitopening_lowres, 1)</span>

<span class="c1">#######################################################################################################################</span>
<span class="c1"># Next come the run preview functions (low and highres preview)</span>
<span class="c1">#######################################################################################################################</span>

<div class="viewcode-block" id="multiScopeModel.preview_lowres"><a class="viewcode-back" href="../multiScope.html#multiScope.multiScopeModel.preview_lowres">[docs]</a>    <span class="k">def</span> <span class="nf">preview_lowres</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        starts a custody thread to run a low resolution preview.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">preview_lowres_task</span><span class="p">(</span><span class="n">custody</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">num_frames</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initial_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

            <span class="k">def</span> <span class="nf">laser_preview</span><span class="p">():</span>
                <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">continue_preview_lowres</span><span class="p">:</span>
                    <span class="n">basic_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_acq_array</span><span class="o">.</span><span class="n">get_lowres_preview_array</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ao</span><span class="o">.</span><span class="n">set_verbose</span><span class="p">(</span><span class="n">verbosevalue</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ao</span><span class="o">.</span><span class="n">play_voltages</span><span class="p">(</span><span class="n">basic_unit</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">ct</span><span class="o">.</span><span class="n">ResultThread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">laser_preview</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="n">currentlaserpower</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">currentexposuretime</span> <span class="o">=-</span><span class="mi">1</span>

            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">continue_preview_lowres</span><span class="p">:</span>


                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exposure_time_LR</span> <span class="o">!=</span> <span class="n">currentexposuretime</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lowres_camera</span><span class="o">.</span><span class="n">set_up_lowres_preview</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_time_LR</span><span class="p">)</span>
                    <span class="n">currentexposuretime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exposure_time_LR</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lowres_laserpower</span> <span class="o">!=</span> <span class="n">currentlaserpower</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_laserpower</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lowres_laserpower</span><span class="p">)</span>
                    <span class="n">currentlaserpower</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lowres_laserpower</span>

                <span class="n">custody</span><span class="o">.</span><span class="n">switch_from</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lowres_camera</span><span class="p">)</span>
                <span class="c1"># self.lowres_camera.run_preview(out=self.low_res_buffer)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lowres_camera</span><span class="o">.</span><span class="n">acquire_preview_tobuffer</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">low_res_buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lowres_camera</span><span class="o">.</span><span class="n">get_previewbuffer</span><span class="p">()</span>
                <span class="c1"># display</span>
                <span class="n">custody</span><span class="o">.</span><span class="n">switch_from</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lowres_camera</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">show_image_lowres</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">low_res_buffer</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoscale_preview</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">minval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">low_res_buffer</span><span class="p">)</span>
                    <span class="n">maxval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">low_res_buffer</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">set_contrast</span><span class="p">(</span><span class="n">minval</span><span class="p">,</span> <span class="n">maxval</span><span class="p">,</span> <span class="s2">&quot;lowrespreview&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;updated preview settings&quot;</span><span class="p">)</span>

                <span class="n">custody</span><span class="o">.</span><span class="n">switch_from</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_frames</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1"># calculate fps to display</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_frames</span> <span class="o">==</span> <span class="mi">100</span><span class="p">:</span>
                    <span class="n">time_elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_time</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%0.2f</span><span class="s2"> average FPS&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_frames</span> <span class="o">/</span> <span class="n">time_elapsed</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">num_frames</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">initial_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">lowres_camera</span><span class="o">.</span><span class="n">end_preview</span><span class="p">()</span>

        <span class="c1"># self.low_res_buffer = ct.SharedNDArray(shape=(self.current_lowresROI_height, self.current_lowresROI_width), dtype=&#39;uint16&#39;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">low_res_buffer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">current_lowresROI_height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_lowresROI_width</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;uint16&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lowres_camera</span><span class="o">.</span><span class="n">init_previewbuffer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_lowresROI_height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_lowresROI_width</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">continue_preview_lowres</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">th</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">CustodyThread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">preview_lowres_task</span><span class="p">,</span> <span class="n">first_resource</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">th</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">th</span></div>

    <span class="c1">###this is the code to run a high resolution preview with a static light-sheet</span>
<div class="viewcode-block" id="multiScopeModel.preview_highres_static"><a class="viewcode-back" href="../multiScope.html#multiScope.multiScopeModel.preview_highres_static">[docs]</a>    <span class="k">def</span> <span class="nf">preview_highres_static</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">preview_highres_task</span><span class="p">(</span><span class="n">custody</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">num_frames</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initial_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

            <span class="k">def</span> <span class="nf">laser_preview_highres</span><span class="p">():</span>
                <span class="c1"># old_laserline = 0</span>
                <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">continue_preview_highres</span><span class="p">:</span>
                    <span class="n">basic_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_acq_array</span><span class="o">.</span><span class="n">get_highres_preview_array</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ao</span><span class="o">.</span><span class="n">play_voltages</span><span class="p">(</span><span class="n">basic_unit</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># run laser as sub-thread that is terminated when the preview button is pressed (self.continue_preview_highres is false).</span>
            <span class="n">ct</span><span class="o">.</span><span class="n">ResultThread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">laser_preview_highres</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">continue_preview_highres</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_laserpower</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highres_laserpower</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">highres_camera</span><span class="o">.</span><span class="n">set_up_highrespreview</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_time_HR</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_frames</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">custody</span><span class="o">.</span><span class="n">switch_from</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">highres_camera</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">highres_camera</span><span class="o">.</span><span class="n">run_preview</span><span class="p">(</span><span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">high_res_buffer</span><span class="p">,</span> <span class="n">flipimage</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># display acquired image</span>
                <span class="n">custody</span><span class="o">.</span><span class="n">switch_from</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highres_camera</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">show_image_highres</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">high_res_buffer</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoscale_preview</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">minval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">high_res_buffer</span><span class="p">)</span>
                    <span class="n">maxval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">high_res_buffer</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">set_contrast</span><span class="p">(</span><span class="n">minval</span><span class="p">,</span> <span class="n">maxval</span><span class="p">,</span> <span class="s2">&quot;highrespreview&quot;</span><span class="p">)</span>

                <span class="n">custody</span><span class="o">.</span><span class="n">switch_from</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_frames</span> <span class="o">==</span> <span class="mi">100</span><span class="p">:</span>
                    <span class="n">time_elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_time</span>
                    <span class="n">avg_FPS</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_frames</span> <span class="o">/</span> <span class="n">time_elapsed</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%0.2f</span><span class="s2"> average FPS&quot;</span> <span class="o">%</span> <span class="n">avg_FPS</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">currentFPS</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">avg_FPS</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">num_frames</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">initial_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">highres_camera</span><span class="o">.</span><span class="n">end_preview</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">high_res_buffer</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">SharedNDArray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_highresROI_height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_highresROI_width</span><span class="p">),</span>
                                                <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint16&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">continue_preview_highres</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">th</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">CustodyThread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">preview_highres_task</span><span class="p">,</span> <span class="n">first_resource</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">highres_camera</span><span class="p">)</span>
        <span class="n">th</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">th</span></div>

<div class="viewcode-block" id="multiScopeModel.calculate_ASLMparameters"><a class="viewcode-back" href="../multiScope.html#multiScope.multiScopeModel.calculate_ASLMparameters">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_ASLMparameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">desired_exposuretime</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        calculate the parameters for an ASLM acquisition</span>
<span class="sd">        :param desired_exposuretime: the exposure time that is desired for the whole acquisition</span>
<span class="sd">        :return: set the important parameters for ASLM acquisitions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">linedelay</span> <span class="o">=</span> <span class="n">Camera_parameters</span><span class="o">.</span><span class="n">highres_line_digitization_time</span>
        <span class="n">nbrows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_highresROI_height</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ASLM_lineExposure</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">desired_exposuretime</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nbrows</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ASLM_scanWidth</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ASLM_line_delay</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">desired_exposuretime</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ASLM_lineExposure</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="n">nbrows</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">linedelay</span><span class="p">)))</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ASLM_acquisition_time</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ASLM_line_delay</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">nbrows</span> <span class="o">*</span> <span class="n">linedelay</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ASLM_lineExposure</span> <span class="o">+</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ASLM_line_delay</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">linedelay</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;ASLM parameters are: </span><span class="si">{}</span><span class="s2"> exposure time, and </span><span class="si">{}</span><span class="s2"> line delay factor, </span><span class="si">{}</span><span class="s2"> total acquisition time for </span><span class="si">{}</span><span class="s2"> scan width&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ASLM_lineExposure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ASLM_line_delay</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ASLM_acquisition_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ASLM_scanWidth</span><span class="p">))</span></div>

<div class="viewcode-block" id="multiScopeModel.preview_highres_ASLM"><a class="viewcode-back" href="../multiScope.html#multiScope.multiScopeModel.preview_highres_ASLM">[docs]</a>    <span class="k">def</span> <span class="nf">preview_highres_ASLM</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">preview_highresASLM_task</span><span class="p">(</span><span class="n">custody</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">num_frames</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initial_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">continue_preview_highres</span><span class="p">:</span>
                <span class="c1"># get/update latest laserpower</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_laserpower</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highres_laserpower</span><span class="p">)</span>

                <span class="c1"># calculate ALSM parameters</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calculate_ASLMparameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_time_HR</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">highres_camera</span><span class="o">.</span><span class="n">prepare_ASLM_acquisition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ASLM_lineExposure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ASLM_line_delay</span><span class="p">)</span>

                <span class="c1"># generate acquisition array</span>
                <span class="n">basic_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_acq_array</span><span class="o">.</span><span class="n">get_highresASLM_preview_array</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;array generated&quot;</span><span class="p">)</span>

                <span class="n">custody</span><span class="o">.</span><span class="n">switch_from</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">highres_camera</span><span class="p">)</span>

                <span class="c1"># write voltages, indicate &quot;False&quot; so that the voltages are not set back to zero at the end (for the remote mirror)</span>
                <span class="n">write_voltages_thread</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">ResultThread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ao</span><span class="o">.</span><span class="n">_write_voltages</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">basic_unit</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                                                        <span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

                <span class="c1"># start camera thread to poll for new images</span>
                <span class="k">def</span> <span class="nf">start_camera_streamASLMpreview</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">highres_camera</span><span class="o">.</span><span class="n">run_preview_ASLM</span><span class="p">(</span><span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">high_res_buffer</span><span class="p">)</span>

                <span class="n">camera_stream_thread_ASLMpreview</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">ResultThread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">start_camera_streamASLMpreview</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

                <span class="c1"># play voltages</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ao</span><span class="o">.</span><span class="n">play_voltages</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force_final_zeros</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;voltages played&quot;</span><span class="p">)</span>
                <span class="n">camera_stream_thread_ASLMpreview</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;camera thread returned&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_frames</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># display</span>
                <span class="n">custody</span><span class="o">.</span><span class="n">switch_from</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highres_camera</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">show_image_highres</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">high_res_buffer</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoscale_preview</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">minval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">high_res_buffer</span><span class="p">)</span>
                    <span class="n">maxval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">high_res_buffer</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">set_contrast</span><span class="p">(</span><span class="n">minval</span><span class="p">,</span> <span class="n">maxval</span><span class="p">,</span> <span class="s2">&quot;highrespreview&quot;</span><span class="p">)</span>

                <span class="n">custody</span><span class="o">.</span><span class="n">switch_from</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_frames</span> <span class="o">==</span> <span class="mi">100</span><span class="p">:</span>
                    <span class="n">time_elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_time</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%0.2f</span><span class="s2"> average FPS&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_frames</span> <span class="o">/</span> <span class="n">time_elapsed</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">num_frames</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">initial_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

            <span class="c1"># end preview by setting voltages back to zero</span>
            <span class="n">end_unit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">100</span><span class="p">,</span> <span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">ao_nchannels</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ao</span><span class="o">.</span><span class="n">play_voltages</span><span class="p">(</span><span class="n">voltages</span><span class="o">=</span><span class="n">end_unit</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force_final_zeros</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">highres_camera</span><span class="o">.</span><span class="n">end_preview</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">high_res_buffer</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">SharedNDArray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_highresROI_height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_highresROI_width</span><span class="p">),</span>
                                                <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint16&#39;</span><span class="p">)</span>

        <span class="c1"># parameters for preview</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">continue_preview_highres</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># start preview custody thread</span>
        <span class="n">th</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">CustodyThread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">preview_highresASLM_task</span><span class="p">,</span> <span class="n">first_resource</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">highres_camera</span><span class="p">)</span>
        <span class="n">th</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">th</span></div>

<span class="c1">#######################################################################################################################</span>
<span class="c1"># below here are the stack acquisition functions</span>
<span class="c1">#######################################################################################################################</span>

<div class="viewcode-block" id="multiScopeModel.stack_acquisition_master"><a class="viewcode-back" href="../multiScope.html#multiScope.multiScopeModel.stack_acquisition_master">[docs]</a>    <span class="k">def</span> <span class="nf">stack_acquisition_master</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_folder</span><span class="p">,</span> <span class="n">current_position</span><span class="p">,</span> <span class="n">whichlaser</span><span class="p">,</span> <span class="n">resolutionmode</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Master to start stack acquisitions of different channels and resolution modes. Decides which stack acquisition method to call</span>
<span class="sd">        :param current_folder: folder to save the acquired data</span>
<span class="sd">        :param current_folder: folder to save the projected data</span>
<span class="sd">        :param current_startposition: start position for the stack streaming</span>
<span class="sd">        :param whichlaser: which channels to image</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#get current start position</span>
        <span class="c1"># get current position from list</span>
        <span class="n">xpos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">current_position</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mi">1000000000</span><span class="p">)</span>
        <span class="n">ypos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">current_position</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="mi">1000000000</span><span class="p">)</span>
        <span class="n">zpos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">current_position</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="mi">1000000000</span><span class="p">)</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">current_position</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">*</span> <span class="mi">1000000</span><span class="p">)</span>
        <span class="n">current_startposition</span> <span class="o">=</span> <span class="p">[</span><span class="n">zpos</span><span class="p">,</span> <span class="n">xpos</span><span class="p">,</span> <span class="n">ypos</span><span class="p">,</span> <span class="n">angle</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">current_startposition</span><span class="p">)</span>

        <span class="c1"># first get the right laser power</span>
        <span class="k">if</span> <span class="n">resolutionmode</span> <span class="o">==</span> <span class="s2">&quot;low&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_laserpower</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lowres_laserpower</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resolutionmode</span> <span class="o">==</span> <span class="s2">&quot;highASLM&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_laserpower</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highres_laserpower</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resolutionmode</span> <span class="o">==</span> <span class="s2">&quot;highSPIM&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_laserpower</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highres_laserpower</span><span class="p">)</span>

        <span class="n">filename_image</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;1_CH488_000000.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;1_CH552_000000.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;1_CH594_000000.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;1_CH640_000000.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;1_CHLED_000000.tif&quot;</span><span class="p">]</span>
        <span class="n">channel_name</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;CH488&quot;</span><span class="p">,</span> <span class="s2">&quot;CH552&quot;</span><span class="p">,</span>  <span class="s2">&quot;CH594&quot;</span><span class="p">,</span> <span class="s2">&quot;CH640&quot;</span><span class="p">,</span>  <span class="s2">&quot;CHLED&quot;</span><span class="p">]</span>
        <span class="n">laser_param</span> <span class="o">=</span> <span class="p">[</span><span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">laser488</span><span class="p">,</span>
                       <span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">laser552</span><span class="p">,</span>
                       <span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">laser594</span><span class="p">,</span>
                       <span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">laser640</span><span class="p">,</span>
                       <span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">led</span><span class="p">]</span>

        <span class="c1"># save current position to file for later reproducibility</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_positionfilepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experimentfilepath</span><span class="p">,</span> <span class="s2">&quot;positions&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_region</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_currentpositionToFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_positionfilepath</span><span class="p">,</span> <span class="n">current_startposition</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">w_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">whichlaser</span><span class="p">)):</span>
            <span class="c1">#if laser is selected do:</span>
            <span class="k">if</span> <span class="n">whichlaser</span><span class="p">[</span><span class="n">w_i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abortStackFlag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;acquire laser: &quot;</span> <span class="o">+</span> <span class="n">channel_name</span><span class="p">[</span><span class="n">w_i</span><span class="p">])</span>
                <span class="c1">#generate filepaths for projections and drift correction</span>
                <span class="n">current_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_folder</span><span class="p">,</span> <span class="n">filename_image</span><span class="p">[</span><span class="n">w_i</span><span class="p">])</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">current_projectionfilepath_three</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experimentfilepath</span><span class="p">,</span> <span class="s2">&quot;projections&quot;</span><span class="p">,</span> <span class="s2">&quot;three&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_region</span><span class="p">,</span> <span class="n">channel_name</span><span class="p">[</span><span class="n">w_i</span><span class="p">],</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">current_timepointstring</span> <span class="o">+</span> <span class="s2">&quot;.tif&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_projectionfilepath_XY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experimentfilepath</span><span class="p">,</span> <span class="s2">&quot;projections&quot;</span><span class="p">,</span> <span class="s2">&quot;XY&quot;</span><span class="p">,</span>
                                                               <span class="bp">self</span><span class="o">.</span><span class="n">current_region</span><span class="p">,</span> <span class="n">channel_name</span><span class="p">[</span><span class="n">w_i</span><span class="p">],</span>
                                                               <span class="bp">self</span><span class="o">.</span><span class="n">current_timepointstring</span> <span class="o">+</span> <span class="s2">&quot;.tif&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_projectionfilepath_XZ</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experimentfilepath</span><span class="p">,</span> <span class="s2">&quot;projections&quot;</span><span class="p">,</span> <span class="s2">&quot;XZ&quot;</span><span class="p">,</span>
                                                               <span class="bp">self</span><span class="o">.</span><span class="n">current_region</span><span class="p">,</span> <span class="n">channel_name</span><span class="p">[</span><span class="n">w_i</span><span class="p">],</span>
                                                               <span class="bp">self</span><span class="o">.</span><span class="n">current_timepointstring</span> <span class="o">+</span> <span class="s2">&quot;.tif&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_projectionfilepath_YZ</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experimentfilepath</span><span class="p">,</span> <span class="s2">&quot;projections&quot;</span><span class="p">,</span> <span class="s2">&quot;YZ&quot;</span><span class="p">,</span>
                                                               <span class="bp">self</span><span class="o">.</span><span class="n">current_region</span><span class="p">,</span> <span class="n">channel_name</span><span class="p">[</span><span class="n">w_i</span><span class="p">],</span>
                                                               <span class="bp">self</span><span class="o">.</span><span class="n">current_timepointstring</span> <span class="o">+</span> <span class="s2">&quot;.tif&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">past_projectionfilepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experimentfilepath</span><span class="p">,</span> <span class="s2">&quot;projections&quot;</span><span class="p">,</span> <span class="s2">&quot;three&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_region</span><span class="p">,</span> <span class="n">channel_name</span><span class="p">[</span><span class="n">w_i</span><span class="p">],</span>
                                                            <span class="bp">self</span><span class="o">.</span><span class="n">past_timepointstring</span> <span class="o">+</span> <span class="s2">&quot;.tif&quot;</span><span class="p">)</span>


                <span class="c1">#set flag for drift correction on channel (high-res drift correction) - take info from GUI</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drift_which_channels</span><span class="p">[</span><span class="n">w_i</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">perform_driftcorrectionOnChannel</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">perform_driftcorrectionOnChannel</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1">#select resolution level and start stack acquisition</span>
                <span class="k">if</span> <span class="n">resolutionmode</span> <span class="o">==</span> <span class="s2">&quot;low&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">acquire_stack_lowres</span><span class="p">(</span><span class="n">current_startposition</span><span class="p">,</span> <span class="n">laser_param</span><span class="p">[</span><span class="n">w_i</span><span class="p">],</span> <span class="n">current_filepath</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">resolutionmode</span> <span class="o">==</span> <span class="s2">&quot;highASLM&quot;</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;acquire high res ALSM&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">acquire_stack_highres</span><span class="p">(</span><span class="n">current_startposition</span><span class="p">,</span> <span class="n">laser_param</span><span class="p">[</span><span class="n">w_i</span><span class="p">],</span> <span class="n">current_filepath</span><span class="p">,</span> <span class="s2">&quot;ASLM&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">resolutionmode</span> <span class="o">==</span> <span class="s2">&quot;highSPIM&quot;</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;acquire high res SPIM&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">acquire_stack_highres</span><span class="p">(</span><span class="n">current_startposition</span><span class="p">,</span> <span class="n">laser_param</span><span class="p">[</span><span class="n">w_i</span><span class="p">],</span> <span class="n">current_filepath</span><span class="p">,</span> <span class="s2">&quot;SPIM&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="multiScopeModel.save_currentpositionToFile"><a class="viewcode-back" href="../multiScope.html#multiScope.multiScopeModel.save_currentpositionToFile">[docs]</a>    <span class="k">def</span> <span class="nf">save_currentpositionToFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">current_startposition</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        saves current position to file/append it, called by stack_acquisition_master</span>
<span class="sd">        :param filepath:</span>
<span class="sd">        :return:</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># make positions folder if it does not exist to write file</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filepath</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;folder not created&quot;</span><span class="p">)</span>

        <span class="n">str_positionarray</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_startposition</span><span class="p">)</span>

        <span class="c1"># append current position to text file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_timepointstring</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;: &#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">str_positionarray</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="multiScopeModel.prepare_acquisition"><a class="viewcode-back" href="../multiScope.html#multiScope.multiScopeModel.prepare_acquisition">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_acquisition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_startposition</span><span class="p">,</span> <span class="n">laser</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        prepare acquisition by moving filter wheel and stage system to the correct position</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">movestage</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">move_to_position</span><span class="p">(</span><span class="n">current_startposition</span><span class="p">)</span>

        <span class="n">thread_stagemove</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">ResultThread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">movestage</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">LED_voltage</span><span class="o">.</span><span class="n">setconstantvoltage</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">laser</span> <span class="o">==</span> <span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">laser488</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filterwheel</span><span class="o">.</span><span class="n">set_filter</span><span class="p">(</span><span class="s1">&#39;515-30-25&#39;</span><span class="p">,</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">laser</span> <span class="o">==</span> <span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">laser552</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filterwheel</span><span class="o">.</span><span class="n">set_filter</span><span class="p">(</span><span class="s1">&#39;572/20-25&#39;</span><span class="p">,</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">laser</span> <span class="o">==</span> <span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">laser594</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filterwheel</span><span class="o">.</span><span class="n">set_filter</span><span class="p">(</span><span class="s1">&#39;615/20-25&#39;</span><span class="p">,</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">laser</span> <span class="o">==</span> <span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">laser640</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filterwheel</span><span class="o">.</span><span class="n">set_filter</span><span class="p">(</span><span class="s1">&#39;676/37-25&#39;</span><span class="p">,</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">laser</span> <span class="o">==</span> <span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">led</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filterwheel</span><span class="o">.</span><span class="n">set_filter</span><span class="p">(</span><span class="s1">&#39;515-30-25&#39;</span><span class="p">,</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">LED_voltage</span><span class="o">.</span><span class="n">setconstantvoltage</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_bufferSize</span><span class="p">()</span>

        <span class="n">thread_stagemove</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span></div>

<div class="viewcode-block" id="multiScopeModel.acquire_stack_lowres"><a class="viewcode-back" href="../multiScope.html#multiScope.multiScopeModel.acquire_stack_lowres">[docs]</a>    <span class="k">def</span> <span class="nf">acquire_stack_lowres</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_startposition</span><span class="p">,</span> <span class="n">current_laserline</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">acquire_task</span><span class="p">(</span><span class="n">custody</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;new low res stack acquisition started...&quot;</span><span class="p">)</span>
            <span class="n">custody</span><span class="o">.</span><span class="n">switch_from</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lowres_camera</span><span class="p">)</span>

            <span class="c1"># prepare acquisition by moving filter wheel and stage, and set buffer size</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prepare_acquisition</span><span class="p">(</span><span class="n">current_startposition</span><span class="p">,</span> <span class="n">current_laserline</span><span class="p">)</span>

            <span class="c1"># prepare camera for stack acquisition - put in thread so that program executes faster :)</span>
            <span class="k">def</span> <span class="nf">prepare_camera</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lowres_camera</span><span class="o">.</span><span class="n">prepare_stack_acquisition_seq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_time_LR</span><span class="p">)</span>

            <span class="n">camera_prepare_thread</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">ResultThread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">prepare_camera</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="c1"># define NI board voltage array</span>
            <span class="n">basic_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_acq_array</span><span class="o">.</span><span class="n">get_lowRes_StackAq_array</span><span class="p">(</span><span class="n">current_laserline</span><span class="p">)</span>
            <span class="n">control_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">basic_unit</span><span class="p">,</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack_nbplanes_lowres</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># add +1 as you want to return to origin position</span>

            <span class="c1"># write voltages</span>
            <span class="n">write_voltages_thread</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">ResultThread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ao</span><span class="o">.</span><span class="n">_write_voltages</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">control_array</span><span class="p">,),</span>
                                                    <span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="c1"># set up stage</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">XYZ_stage</span><span class="o">.</span><span class="n">streamStackAcquisition_externalTrigger_setup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack_nbplanes_lowres</span><span class="p">,</span>
                                                                        <span class="bp">self</span><span class="o">.</span><span class="n">lowres_planespacing</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slow_velocity</span><span class="p">,</span>
                                                                        <span class="bp">self</span><span class="o">.</span><span class="n">slow_acceleration</span><span class="p">)</span>

            <span class="c1"># wait for camera set up before proceeding</span>
            <span class="n">camera_prepare_thread</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>

            <span class="c1"># start thread on stage to wait for trigger</span>
            <span class="k">def</span> <span class="nf">start_stage_stream</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">XYZ_stage</span><span class="o">.</span><span class="n">streamStackAcquisition_externalTrigger_waitEnd</span><span class="p">()</span>

            <span class="n">stream_thread</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">ResultThread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">start_stage_stream</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>  <span class="c1"># ~3.6s</span>

            <span class="k">def</span> <span class="nf">start_camera_streamfast</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lowres_camera</span><span class="o">.</span><span class="n">run_stack_acquisition_buffer_fast</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack_nbplanes_lowres</span><span class="p">,</span>
                                                                     <span class="bp">self</span><span class="o">.</span><span class="n">low_res_buffers</span><span class="p">[</span><span class="n">current_bufferiter</span><span class="p">])</span>
                <span class="k">return</span>

            <span class="n">start_camera_streamfast_thread</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">ResultThread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">start_camera_streamfast</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="c1"># play voltages - you need to use &quot;block true&quot; as otherwise the program finishes without playing the voltages</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ao</span><span class="o">.</span><span class="n">play_voltages</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">stream_thread</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>
            <span class="n">start_camera_streamfast_thread</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>
            <span class="n">write_voltages_thread</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>

            <span class="n">custody</span><span class="o">.</span><span class="n">switch_from</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lowres_camera</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">saveimage</span><span class="p">():</span>
                <span class="c1"># save image</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">imwrite</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">low_res_buffers</span><span class="p">[</span><span class="n">current_bufferiter</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;couldn&#39;t save image&quot;</span><span class="p">)</span>

            <span class="n">savethread</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">ResultThread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">saveimage</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">displayImStack</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">show_stack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">low_res_buffers</span><span class="p">[</span><span class="n">current_bufferiter</span><span class="p">])</span>

            <span class="k">def</span> <span class="nf">calculate_projection_and_drift</span><span class="p">():</span>
                <span class="c1"># calculate projections</span>
                <span class="n">filepathforprojection_three</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_projectionfilepath_three</span><span class="p">)</span>  <span class="c1"># assign now as filepath is updated for next stack acquired</span>
                <span class="n">filepathforprojection_XY</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_projectionfilepath_XY</span><span class="p">)</span>  <span class="c1"># assign now as filepath is updated for next stack acquired</span>
                <span class="n">filepathforprojection_XZ</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_projectionfilepath_XZ</span><span class="p">)</span>  <span class="c1"># assign now as filepath is updated for next stack acquired</span>
                <span class="n">filepathforprojection_YZ</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_projectionfilepath_YZ</span><span class="p">)</span>  <span class="c1"># assign now as filepath is updated for next stack acquired</span>
                <span class="n">posnumber_lowres</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_PosNumber</span><span class="p">)</span>
                <span class="n">bufferindex</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">current_bufferiter</span><span class="p">)</span>
                <span class="n">driftcorr_OnChannel</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">perform_driftcorrectionOnChannel</span><span class="p">)</span>

                <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
                <span class="n">maxproj_xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">low_res_buffers</span><span class="p">[</span><span class="n">bufferindex</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">maxproj_xz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">low_res_buffers</span><span class="p">[</span><span class="n">bufferindex</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">maxproj_yz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">low_res_buffers</span><span class="p">[</span><span class="n">bufferindex</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;max proj time: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">t1</span><span class="p">))</span>

                <span class="c1">##display max projection</span>
                <span class="n">all_proj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">current_lowresROI_height</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack_nbplanes_lowres</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">current_lowresROI_width</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack_nbplanes_lowres</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;uint16&quot;</span><span class="p">)</span>

                <span class="n">all_proj</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">current_lowresROI_height</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">current_lowresROI_width</span><span class="p">]</span> <span class="o">=</span> <span class="n">maxproj_xy</span>
                <span class="n">all_proj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_lowresROI_height</span><span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">current_lowresROI_width</span><span class="p">]</span> <span class="o">=</span> <span class="n">maxproj_xz</span>
                <span class="n">all_proj</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">current_lowresROI_height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_lowresROI_width</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">maxproj_yz</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">show_maxproj</span><span class="p">(</span><span class="n">all_proj</span><span class="p">)</span>

                <span class="c1">#save maxproj</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filepathforprojection_three</span><span class="p">))</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filepathforprojection_XY</span><span class="p">))</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filepathforprojection_XZ</span><span class="p">))</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filepathforprojection_YZ</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;folder not created&quot;</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">imwrite</span><span class="p">(</span><span class="n">filepathforprojection_three</span><span class="p">,</span> <span class="n">all_proj</span><span class="p">)</span>
                    <span class="n">imwrite</span><span class="p">(</span><span class="n">filepathforprojection_XY</span><span class="p">,</span> <span class="n">maxproj_xy</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;uint16&quot;</span><span class="p">))</span>
                    <span class="n">imwrite</span><span class="p">(</span><span class="n">filepathforprojection_XZ</span><span class="p">,</span> <span class="n">maxproj_xz</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;uint16&quot;</span><span class="p">))</span>
                    <span class="n">imwrite</span><span class="p">(</span><span class="n">filepathforprojection_YZ</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">maxproj_yz</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;uint16&quot;</span><span class="p">)))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;couldn&#39;t save projection image:&quot;</span> <span class="o">+</span> <span class="n">filepathforprojection_three</span><span class="p">)</span>

                <span class="c1">#perform drift correction on low res images</span>
                <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">driftcorr_OnChannel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;perform drift correction...&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drift_correctionOnLowRes</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;perform drift correction on LowRes...&quot;</span><span class="p">)</span>

                        <span class="c1">#set current parameters</span>
                        <span class="c1">#high&amp;low position list are updated when stack acquisition is started in multiScale_main to not override previous calculation for other position</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">driftcorrectionmodule</span><span class="o">.</span><span class="n">currenttimepoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_timepointstring</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">driftcorrectionmodule</span><span class="o">.</span><span class="n">lowres_zspacing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lowres_planespacing</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">driftcorrectionmodule</span><span class="o">.</span><span class="n">highres_zspacing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">highres_planespacing</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">driftcorrectionmodule</span><span class="o">.</span><span class="n">highres_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_highresROI_height</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">driftcorrectionmodule</span><span class="o">.</span><span class="n">highres_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_highresROI_width</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">driftcorrectionmodule</span><span class="o">.</span><span class="n">lowres_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_lowresROI_height</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">driftcorrectionmodule</span><span class="o">.</span><span class="n">lowres_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_lowresROI_width</span>


                        <span class="bp">self</span><span class="o">.</span><span class="n">driftcorrectionmodule</span><span class="o">.</span><span class="n">ImageRepo</span><span class="o">.</span><span class="n">replaceImage</span><span class="p">(</span><span class="s2">&quot;current_lowRes_Proj&quot;</span><span class="p">,</span> <span class="n">posnumber_lowres</span><span class="p">,</span> <span class="n">maxproj_xy</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;image replaced&quot;</span><span class="p">)</span>
                        <span class="n">highreslistID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">driftcorrectionmodule</span><span class="o">.</span><span class="n">find_corresponsingHighResTiles</span><span class="p">(</span><span class="n">posnumber_lowres</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;highreslist to do drift correction on: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">highreslistID</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; of &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">posnumber_lowres</span><span class="p">))</span>
                        <span class="c1"># add max projection to ImageRepo</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drift_transmission</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">currentmode</span> <span class="o">=</span> <span class="s1">&#39;fluorescene&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">currentmode</span> <span class="o">=</span> <span class="s1">&#39;transmission&#39;</span>

                        <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="n">highreslistID</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------------------------------------------------------------&quot;</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;drift correction on &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">iter</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; and posnumber lowres&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">posnumber_lowres</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; and &quot;</span> <span class="o">+</span> <span class="n">filepathforprojection_three</span><span class="p">)</span>
                            <span class="p">(</span><span class="n">row_number</span><span class="p">,</span> <span class="n">column_number</span><span class="p">,</span> <span class="n">crop_height</span><span class="p">,</span> <span class="n">crop_width</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">driftcorrectionmodule</span><span class="o">.</span><span class="n">calculate_Lateral_drift</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">iter</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="n">currentmode</span><span class="p">)</span>
                            <span class="n">image1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">low_res_buffers</span><span class="p">[</span><span class="n">bufferindex</span><span class="p">][:,</span> <span class="n">row_number</span><span class="p">:</span><span class="n">row_number</span><span class="o">+</span><span class="n">crop_height</span><span class="p">,</span> <span class="n">column_number</span><span class="p">:</span><span class="n">column_number</span><span class="o">+</span><span class="n">crop_width</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                            <span class="n">image2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">low_res_buffers</span><span class="p">[</span><span class="n">bufferindex</span><span class="p">][:,</span> <span class="n">row_number</span><span class="p">:</span><span class="n">row_number</span><span class="o">+</span><span class="n">crop_height</span><span class="p">,</span> <span class="n">column_number</span><span class="p">:</span><span class="n">column_number</span><span class="o">+</span><span class="n">crop_width</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">driftcorrectionmodule</span><span class="o">.</span><span class="n">calculate_axialdrift</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">iter</span><span class="p">),</span> <span class="n">image1</span><span class="p">,</span> <span class="n">image2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">currentmode</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">driftcorrectionmodule</span><span class="o">.</span><span class="n">indicate_driftcorrectionCompleted</span><span class="p">(</span><span class="nb">iter</span><span class="p">)</span>


                <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;drift correction time: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">t1</span><span class="p">))</span>

            <span class="n">projection_thread</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">ResultThread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">calculate_projection_and_drift</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="n">custody</span><span class="o">.</span><span class="n">switch_from</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="c1"># savethread.get_result()</span>
            <span class="c1"># projection_thread.get_result()</span>
            <span class="k">return</span>

        <span class="c1">##navigate buffer queue - where to save current image: this allows you to acquire another stack, while the stack before is still being processed</span>
        <span class="n">current_bufferiter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">low_res_buffers_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>  <span class="c1"># get current buffer iter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">low_res_buffers_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">current_bufferiter</span><span class="p">)</span>  <span class="c1"># add number to end of queue</span>

        <span class="n">acquire_thread</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">CustodyThread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">acquire_task</span><span class="p">,</span> <span class="n">first_resource</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lowres_camera</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">acquire_thread</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span></div>

<div class="viewcode-block" id="multiScopeModel.acquire_stack_highres"><a class="viewcode-back" href="../multiScope.html#multiScope.multiScopeModel.acquire_stack_highres">[docs]</a>    <span class="k">def</span> <span class="nf">acquire_stack_highres</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_startposition</span><span class="p">,</span> <span class="n">current_laserline</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">modality</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">acquire_taskHighResSPIM</span><span class="p">(</span><span class="n">custody</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">)</span>
            <span class="n">custody</span><span class="o">.</span><span class="n">switch_from</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">highres_camera</span><span class="p">)</span>

            <span class="c1"># prepare acquisition by moving filter wheel etc</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prepare_acquisition</span><span class="p">(</span><span class="n">current_startposition</span><span class="p">,</span> <span class="n">current_laserline</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">modality</span> <span class="o">==</span> <span class="s2">&quot;ASLM&quot;</span><span class="p">:</span>
                <span class="c1"># obtain ASLM parameters</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calculate_ASLMparameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_time_HR</span><span class="p">)</span>

                <span class="c1"># define NI board voltage array</span>
                <span class="n">basic_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_acq_array</span><span class="o">.</span><span class="n">get_highResASLM_StackAq_array</span><span class="p">(</span><span class="n">current_laserline</span><span class="p">)</span>
                <span class="n">control_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">basic_unit</span><span class="p">,</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stack_nbplanes_highres</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># add +1 as you want to return to origin position</span>

                <span class="c1"># smooth remote mirror voltage</span>
                <span class="n">control_array</span><span class="p">[:,</span> <span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">voicecoil</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smooth_sawtooth</span><span class="p">(</span>
                    <span class="n">control_array</span><span class="p">[:,</span> <span class="n">NI_board_parameters</span><span class="o">.</span><span class="n">voicecoil</span><span class="p">],</span>
                    <span class="n">window_len</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ao</span><span class="o">.</span><span class="n">s2p</span><span class="p">(</span><span class="mf">0.002</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;voltage array calculated&quot;</span><span class="p">)</span>

                <span class="c1"># prepare high res camera for stack acquisition</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">highres_camera</span><span class="o">.</span><span class="n">prepare_ASLM_acquisition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ASLM_lineExposure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ASLM_line_delay</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># define NI board voltage array</span>
                <span class="n">basic_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_acq_array</span><span class="o">.</span><span class="n">get_highResSPIM_StackAq_array</span><span class="p">(</span><span class="n">current_laserline</span><span class="p">)</span>
                <span class="n">control_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">basic_unit</span><span class="p">,</span>
                                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack_nbplanes_highres</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                         <span class="mi">1</span><span class="p">))</span>  <span class="c1"># add +1 as you want to return to origin position</span>

                <span class="c1"># prepare high res camera for stack acquisition</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">highres_camera</span><span class="o">.</span><span class="n">prepare_stack_acquisition_highres</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_time_HR</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;camera initialized&quot;</span><span class="p">)</span>

            <span class="c1"># write voltages</span>
            <span class="n">write_voltages_thread</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">ResultThread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ao</span><span class="o">.</span><span class="n">_write_voltages</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">control_array</span><span class="p">,),</span>
                                                    <span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="c1"># set up stage</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">XYZ_stage</span><span class="o">.</span><span class="n">streamStackAcquisition_externalTrigger_setup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack_nbplanes_highres</span><span class="p">,</span>
                                                                        <span class="bp">self</span><span class="o">.</span><span class="n">highres_planespacing</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slow_velocity</span><span class="p">,</span>
                                                                        <span class="bp">self</span><span class="o">.</span><span class="n">slow_acceleration</span><span class="p">)</span>

            <span class="c1"># start thread on stage to wait for trigger</span>
            <span class="k">def</span> <span class="nf">start_stage_streamHighResSPIM</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">XYZ_stage</span><span class="o">.</span><span class="n">streamStackAcquisition_externalTrigger_waitEnd</span><span class="p">()</span>

            <span class="n">stream_thread</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">ResultThread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">start_stage_streamHighResSPIM</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>  <span class="c1"># ~3.6s</span>

            <span class="k">def</span> <span class="nf">start_camera_streamHighResSPIM</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">highres_camera</span><span class="o">.</span><span class="n">run_stack_acquisition_buffer_fast</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack_nbplanes_highres</span><span class="p">,</span>
                                                                      <span class="bp">self</span><span class="o">.</span><span class="n">high_res_buffers</span><span class="p">[</span><span class="n">current_bufferiter</span><span class="p">],</span> <span class="n">flipimage</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="n">start_highrescamera_stream_thread</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">ResultThread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">start_camera_streamHighResSPIM</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;stage and camera threads waiting ...&quot;</span><span class="p">)</span>

            <span class="c1"># play voltages</span>
            <span class="c1"># you need to use &quot;block true&quot; as otherwise the program finishes without playing the voltages really</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ao</span><span class="o">.</span><span class="n">play_voltages</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">stream_thread</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>
            <span class="n">start_highrescamera_stream_thread</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>

            <span class="n">custody</span><span class="o">.</span><span class="n">switch_from</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highres_camera</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">saveimage_highresSPIM</span><span class="p">():</span>
                <span class="c1"># save image</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">imwrite</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">high_res_buffers</span><span class="p">[</span><span class="n">current_bufferiter</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;couldn&#39;t save image&quot;</span><span class="p">)</span>

            <span class="n">savethread</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">ResultThread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">saveimage_highresSPIM</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>


            <span class="k">def</span> <span class="nf">calculate_projection_highres</span><span class="p">():</span>
                <span class="c1"># calculate projections</span>

                <span class="c1">#todo - list all parameters here that change from stack to stack to avoid racing conditions....</span>
                <span class="n">filepathforprojection_three</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_projectionfilepath_three</span><span class="p">)</span>  <span class="c1"># assign now as filepath is updated for next stack acquired</span>
                <span class="n">filepathforprojection_XY</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_projectionfilepath_XY</span><span class="p">)</span>  <span class="c1"># assign now as filepath is updated for next stack acquired</span>
                <span class="n">filepathforprojection_XZ</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_projectionfilepath_XZ</span><span class="p">)</span>  <span class="c1"># assign now as filepath is updated for next stack acquired</span>
                <span class="n">filepathforprojection_YZ</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_projectionfilepath_YZ</span><span class="p">)</span>  <span class="c1"># assign now as filepath is updated for next stack acquired</span>
                <span class="n">pastfilepathforprojection</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">past_projectionfilepath</span><span class="p">)</span>
                <span class="n">current_region_item</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_PosNumber</span><span class="p">)</span>
                <span class="n">bufferindex</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">current_bufferiter</span><span class="p">)</span>
                <span class="n">driftcorr_OnChannel</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">perform_driftcorrectionOnChannel</span><span class="p">)</span>


                <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
                <span class="n">maxproj_xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">high_res_buffers</span><span class="p">[</span><span class="n">bufferindex</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">maxproj_xz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">high_res_buffers</span><span class="p">[</span><span class="n">bufferindex</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">maxproj_yz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">high_res_buffers</span><span class="p">[</span><span class="n">bufferindex</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>

                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;time: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">t1</span><span class="p">))</span>

                <span class="c1">##display max projection</span>
                <span class="n">all_proj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">current_highresROI_height</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack_nbplanes_highres</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">current_highresROI_width</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack_nbplanes_highres</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;uint16&quot;</span><span class="p">)</span>
                <span class="n">all_proj</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">current_highresROI_height</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">current_highresROI_width</span><span class="p">]</span> <span class="o">=</span> <span class="n">maxproj_xy</span>
                <span class="n">all_proj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_highresROI_height</span><span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">current_highresROI_width</span><span class="p">]</span> <span class="o">=</span> <span class="n">maxproj_xz</span>
                <span class="n">maxproj_yzTransposed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">maxproj_yz</span><span class="p">)</span>
                <span class="n">all_proj</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">current_highresROI_height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_highresROI_width</span><span class="p">:]</span> <span class="o">=</span> <span class="n">maxproj_yzTransposed</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">show_maxproj</span><span class="p">(</span><span class="n">all_proj</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filepathforprojection_three</span><span class="p">))</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filepathforprojection_XY</span><span class="p">))</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filepathforprojection_XZ</span><span class="p">))</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filepathforprojection_YZ</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;folder not created&quot;</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">imwrite</span><span class="p">(</span><span class="n">filepathforprojection_three</span><span class="p">,</span> <span class="n">all_proj</span><span class="p">)</span>
                    <span class="n">imwrite</span><span class="p">(</span><span class="n">filepathforprojection_XY</span><span class="p">,</span> <span class="n">maxproj_xy</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;uint16&quot;</span><span class="p">))</span>
                    <span class="n">imwrite</span><span class="p">(</span><span class="n">filepathforprojection_XZ</span><span class="p">,</span> <span class="n">maxproj_xz</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;uint16&quot;</span><span class="p">))</span>
                    <span class="n">imwrite</span><span class="p">(</span><span class="n">filepathforprojection_YZ</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">maxproj_yz</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;uint16&quot;</span><span class="p">)))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;couldn&#39;t save projection image&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">displayImStack</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">show_stack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">high_res_buffers</span><span class="p">[</span><span class="n">current_bufferiter</span><span class="p">])</span>

                <span class="c1">###drift-correction module here for high res driftcorrection</span>
                <span class="k">if</span> <span class="n">driftcorr_OnChannel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drift_correctionOnHighRes</span> <span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">current_region_iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_region</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;stack&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">driftcorrectionmodule</span><span class="o">.</span><span class="n">calculate_drift_highRes</span><span class="p">(</span><span class="n">maxproj_xy</span><span class="p">,</span>
                                                                           <span class="n">maxproj_xz</span><span class="p">,</span>
                                                                           <span class="n">maxproj_yzTransposed</span><span class="p">,</span>
                                                                           <span class="n">pastfilepathforprojection</span><span class="p">,</span>
                                                                           <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">highres_planespacing</span><span class="o">/</span><span class="mi">1000000</span><span class="p">),</span>
                                                                           <span class="n">current_region_item</span>
                                                                           <span class="p">)</span>


            <span class="n">projection_thread2</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">ResultThread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">calculate_projection_highres</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="n">custody</span><span class="o">.</span><span class="n">switch_from</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="c1"># savethread.get_result()</span>

        <span class="c1">##navigate buffer queue - where to save current image.</span>
        <span class="n">current_bufferiter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">high_res_buffers_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>  <span class="c1"># get current buffer iter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">high_res_buffers_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">current_bufferiter</span><span class="p">)</span>  <span class="c1"># add number to end of queue</span>

        <span class="c1"># start thread and wait for its completion</span>
        <span class="n">acquire_threadHighResSPIM</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">CustodyThread</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="n">acquire_taskHighResSPIM</span><span class="p">,</span> <span class="n">first_resource</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">highres_camera</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">acquire_threadHighResSPIM</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span></div>

<div class="viewcode-block" id="multiScopeModel.smooth_sawtooth"><a class="viewcode-back" href="../multiScope.html#multiScope.multiScopeModel.smooth_sawtooth">[docs]</a>    <span class="k">def</span> <span class="nf">smooth_sawtooth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">window_len</span><span class="o">=</span><span class="mi">101</span><span class="p">):</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">window_len</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">window_len</span> <span class="o">=</span> <span class="n">window_len</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">startwindow</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">window_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">startarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">startwindow</span><span class="p">)</span> <span class="o">*</span> <span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">endarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">startwindow</span><span class="p">)</span> <span class="o">*</span> <span class="n">array</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">startarray</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">endarray</span><span class="p">]</span>  <span class="c1"># make array bigger on both sides</span>

        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">window_len</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>  <span class="c1"># define a flat window - all values have equal weight</span>

        <span class="n">returnarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">w</span> <span class="o">/</span> <span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">s</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">)</span>  <span class="c1"># convolve with window to smooth</span>

        <span class="k">return</span> <span class="n">returnarray</span></div></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># first code to run in the multiscope</span>

    <span class="c1"># Create scope object:</span>
    <span class="n">scope</span> <span class="o">=</span> <span class="n">multiScopeModel</span><span class="p">()</span>
    <span class="c1"># close</span>
    <span class="n">scope</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Stephan Daetwyler, Reto Fiolka.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>